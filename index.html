<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Cuentas Streaming - Tu App</title>
    <meta name="description" content="Sistema de gestión de cuentas de streaming para administrar clientes, ventas, finanzas y cuentas de plataformas como Netflix, HBO Max, etc.">
    <meta name="keywords" content="streaming, cuentas, gestión, clientes, ventas, finanzas, Netflix, HBO Max, Disney+, Spotify, administrador">
    <meta name="author" content="Tu Nombre/Empresa">
    <meta property="og:title" content="Administrador de Cuentas Streaming">
    <meta property="og:description" content="Sistema de gestión de cuentas de streaming para administrar clientes, ventas, finanzas y cuentas de plataformas como Netflix, HBO Max, etc.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tudominio.com">
    <!-- <meta property="og:image" content="https://tudominio.com/imagen-preview.jpg"> -->

    <!-- Firebase Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    
    <!-- Font Awesome para iconos profesionales -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        /* ============= VARIABLES CSS ============= */
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a6fd8;
            --secondary-color: #6c757d;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.6;
            
            --border-radius: 12px;
            --border-radius-lg: 20px;
            --border-radius-xl: 24px;
            
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition-fast: 150ms ease;
            --transition-normal: 200ms ease;
            --transition-slow: 300ms ease;
        }

        /* ============= RESET Y BASE ============= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            color: var(--dark-color);
            background: linear-gradient(135deg, #f0f2f5 0%, #e2e8f0 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* ============= LOGIN SYSTEM ============= */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-card {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }

        .login-header .logo {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: var(--shadow-lg);
        }

        .login-header .logo i {
            color: white;
            font-size: 24px;
        }

        .login-header h1 {
            color: var(--dark-color);
            margin-bottom: 8px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .login-header p {
            color: var(--secondary-color);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: all var(--transition-normal);
            background: white;
            color: var(--dark-color);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

        .btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-full {
            width: 100%;
        }

        .btn-success {
            background: var(--gradient-success);
        }

        .btn-danger {
            background: var(--gradient-danger);
        }

        .btn-warning {
            background: var(--gradient-warning);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 13px;
        }

        .login-error {
            background: var(--gradient-danger);
            color: white;
            padding: 16px;
            border-radius: var(--border-radius);
            margin-top: 16px;
            font-size: 14px;
            white-space: pre-line;
            box-shadow: var(--shadow-md);
        }

        .login-loading {
            text-align: center;
            margin-top: 20px;
            color: var(--secondary-color);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Demo mode styles */
        .demo-alert {
            background: var(--gradient-warning);
            color: white;
            padding: 24px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
        }

        .demo-alert h3 {
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .demo-features {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius-lg);
            color: var(--dark-color);
            box-shadow: var(--shadow-md);
        }

        .demo-features h4 {
            margin-bottom: 16px;
            color: var(--dark-color);
        }

        .demo-features ul {
            list-style: none;
            padding: 0;
        }

        .demo-features li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .demo-features li i {
            color: var(--success-color);
            width: 16px;
        }

        /* ============= MAIN APPLICATION ============= */
        .main-app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            box-shadow: var(--shadow-md);
            padding: var(--spacing-lg) var(--spacing-xl);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-brand .logo {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-brand .logo i {
            color: white;
            font-size: 18px;
        }

        .header-brand h1 {
            color: var(--dark-color);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-email {
            background: var(--light-color);
            color: var(--dark-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tabs {
            background: white;
            box-shadow: var(--shadow-sm);
            padding: 0 var(--spacing-xl);
            overflow-x: auto;
        }

        .nav-tabs-content {
            display: flex;
            gap: 2px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 16px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-color);
            border-bottom: 3px solid transparent;
            transition: all var(--transition-normal);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            color: var(--primary-color);
            background: #f8fafc;
        }

        .nav-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #f8fafc;
        }

        /* Main content */
        .main-content {
            flex: 1;
            padding: var(--spacing-xl);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .section {
            display: none;
            animation: fadeInUp 0.3s ease;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between; /* Changed from 'between' to 'space-between' */
            align-items: center;
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-title {
            color: var(--dark-color);
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 0 var(--border-radius-lg) 0 60px;
            opacity: 0.1;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.success::before {
            background: var(--gradient-success);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.warning::before {
            background: var(--gradient-warning);
        }

        .stat-card.danger {
            border-left-color: var(--danger-color);
        }

        .stat-card.danger::before {
            background: var(--gradient-danger);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            background: var(--gradient-primary);
        }

        .stat-card.success .stat-icon {
            background: var(--gradient-success);
        }

        .stat-card.warning .stat-icon {
            background: var(--gradient-warning);
        }

        .stat-card.danger .stat-icon {
            background: var(--gradient-danger);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--dark-color);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--secondary-color);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Cards and Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-lg);
        }

        .card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all var(--transition-normal);
            border: 1px solid #f1f5f9;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
        }

        .card-header h3 {
            color: var(--dark-color);
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: var(--spacing-xl);
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-top: var(--spacing-lg);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        .table th {
            background: var(--gradient-dark);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: background-color var(--transition-fast);
        }

        .table tbody tr:hover {
            background-color: #f8fafc;
        }

        .table tbody tr:nth-child(even) {
            background-color: #fefefe;
        }

        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.unavailable {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-badge.active {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info-color);
        }

        /* CHANGE: Added styles for sale payment status */
        .status-badge.paid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-badge.overdue {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        /* END CHANGE */

        /* ============= MODALS ============= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: all var(--transition-normal);
            margin: var(--spacing-md);
            border: 1px solid #f1f5f9;
        }

        .modal.modal-show {
            transform: scale(1) translateY(0);
        }

        .modal-small { max-width: 400px; width: 100%; }
        .modal-medium { max-width: 600px; width: 100%; }
        .modal-large { max-width: 900px; width: 100%; }

        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--secondary-color);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background-color: #f1f5f9;
            color: var(--dark-color);
        }

        .modal-body {
            padding: var(--spacing-xl);
        }

        .modal-footer {
            padding: var(--spacing-xl);
            border-top: 1px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* CHANGE: Toast Notification Styles */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-notification.show {
            opacity: 1;
            visibility: visible;
        }

        .toast-notification.error {
            background-color: var(--danger-color);
        }

        .toast-notification.warning {
            background-color: var(--warning-color);
        }
        /* END CHANGE */

        /* Form sections */
        .form-section {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            border: 1px solid #f1f5f9;
            border-radius: var(--border-radius);
            background: #f8fafc;
        }

        .form-section h4 {
            margin-bottom: var(--spacing-md);
            color: var(--dark-color);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .form-text {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-top: 4px;
        }

        /* Financial specific styles */
        .profit-indicator {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: var(--border-radius);
        }

        .profit-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid #f1f5f9;
        }

        .metric.profit .value { color: var(--success-color); font-weight: 700; }
        .metric.loss .value { color: var(--danger-color); font-weight: 700; }
        .value.positive { color: var(--success-color); font-weight: 700; }
        .value.negative { color: var(--danger-color); font-weight: 700; }

        /* Finance tabs */
        .finance-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: var(--spacing-xl);
            background: #f1f5f9;
            border-radius: var(--border-radius);
            padding: 4px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary-color);
            transition: all var(--transition-fast);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .finance-tab-content {
            display: none;
        }

        .finance-tab-content.active {
            display: block;
        }

        /* Profile management */
        .profile-item {
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-md);
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: var(--border-radius);
        }

        .profile-fields {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--spacing-sm);
            align-items: center;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .main-content {
                padding: var(--spacing-md);
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .form-row,
            .profit-breakdown {
                grid-template-columns: 1fr;
            }

            .profile-fields {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .finance-tabs {
                overflow-x: auto;
                padding: 2px;
            }

            .tab-btn {
                white-space: nowrap;
            }

            /* Responsive table for smaller screens */
            .table-container {
                overflow-x: auto;
            }

            .table {
                min-width: 600px; /* Ensure table content doesn't collapse too much */
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs-content {
                overflow-x: auto;
            }

            .modal {
                margin: var(--spacing-sm);
                max-width: none;
                width: calc(100% - 2rem);
            }

            .form-row {
                grid-template-columns: 1fr; /* Stack form fields on very small screens */
            }

            .profile-fields {
                grid-template-columns: 1fr; /* Stack profile fields */
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in { animation: fadeIn 0.3s ease; }
        .fade-out { animation: fadeIn 0.3s ease reverse; }

        /* Utilities */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .d-flex { display: flex; }
        .d-none { display: none; }
        .gap-2 { gap: var(--spacing-sm); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mt-3 { margin-top: var(--spacing-md); }

        /* Specific styles for financial summary items */
        .summary-stats {
            display: grid;
            gap: 8px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-item .label {
            color: #6c757d;
        }
        
        .summary-item .value {
            font-weight: 600;
            color: var(--dark-color); /* Changed from #495057 to var(--dark-color) for consistency */
        }

        /* Styles for account profit/loss items in financial overview */
        .account-profit-item, .renewal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f8fafc;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
        }

        .account-profit-item .profit-info .profit {
            color: var(--success-color);
            font-weight: 700;
        }

        .account-profit-item .loss-info .loss {
            color: var(--danger-color);
            font-weight: 700;
        }

        .account-profit-item .profit-info .roi,
        .account-profit-item .loss-info .status {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        .renewal-item.urgent {
            border-left: 4px solid var(--danger-color);
            background: rgba(239, 68, 68, 0.05);
        }

        .renewal-item .renewal-info .cost {
            font-weight: 700;
            color: var(--primary-color);
        }

        .renewal-item .renewal-info .days {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: var(--secondary-color);
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-screen" role="dialog" aria-modal="true" aria-labelledby="login-title">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-play-circle" aria-hidden="true"></i>
                    </div>
                    <h1 id="login-title">Streaming Admin</h1>
                    <p>Sistema de gestión de cuentas streaming</p>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label for="loginEmail">
                            <i class="fas fa-envelope" aria-hidden="true"></i> Email
                        </label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="tu@email.com" autocomplete="username" aria-required="true" tabindex="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">
                            <i class="fas fa-lock" aria-hidden="true"></i> Contraseña
                        </label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Contraseña" autocomplete="current-password" aria-required="true" tabindex="0">
                    </div>
                    
                    <button class="btn btn-full" onclick="loginUser()" tabindex="0">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                        Iniciar Sesión
                    </button>
                    
                    <div id="loginError" class="login-error" style="display: none;" role="alert" aria-live="assertive"></div>
                    <div id="loginLoading" class="login-loading" style="display: none;" aria-live="polite">
                        <div class="spinner" role="status" aria-label="Cargando"></div>
                        <p>Verificando credenciales...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modo Demo -->
    <div id="demoScreen" class="login-screen" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="demo-title">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-play-circle" aria-hidden="true"></i>
                    </div>
                    <h1 id="demo-title">Streaming Admin</h1>
                    <p><strong>Modo Demo Activo</strong></p>
                </div>
                
                <div class="demo-content">
                    <div class="demo-alert" role="alert">
                        <h3><i class="fas fa-info-circle" aria-hidden="true"></i> Modo de Demostración</h3>
                        <p>Firebase Authentication no está disponible en este entorno.</p>
                        <p><strong>Para funcionalidad completa:</strong> Implementa en tu servidor con Firebase configurado.</p>
                    </div>
                    
                    <button class="btn btn-success btn-full" onclick="enterDemoMode()" tabindex="0">
                        <i class="fas fa-rocket" aria-hidden="true"></i>
                        Probar Modo Demo
                    </button>
                    
                    <div class="demo-features">
                        <h4><i class="fas fa-list-check" aria-hidden="true"></i> Funcionalidades disponibles:</h4>
                        <ul>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Gestión completa de cuentas streaming</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Administración de clientes</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Sistema de ventas y rentabilidad</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Dashboard financiero avanzado</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Generación de mensajes WhatsApp</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Análisis de ROI y ganancias</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aplicación Principal -->
    <div id="mainApp" class="main-app" style="display: none;">
        <!-- Header -->
        <header class="header" role="banner">
            <div class="header-content">
                <div class="header-brand">
                    <div class="logo">
                        <i class="fas fa-play-circle" aria-hidden="true"></i>
                    </div>
                    <h1>Streaming Admin</h1>
                </div>
                <div class="user-info">
                    <span id="userEmail" class="user-email" aria-label="Correo electrónico del usuario"></span>
                    <button class="btn btn-danger btn-sm" onclick="logoutUser()" aria-label="Cerrar sesión" tabindex="0">
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        Salir
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs" role="navigation" aria-label="Navegación principal">
            <div class="nav-tabs-content">
                <button class="nav-btn active" onclick="showSection('dashboard')" aria-controls="dashboard" aria-selected="true" role="tab" tabindex="0">
                    <i class="fas fa-chart-line" aria-hidden="true"></i> Dashboard
                </button>
                <button class="nav-btn" onclick="showSection('accounts')" aria-controls="accounts" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-tv" aria-hidden="true"></i> Cuentas
                </button>
                <button class="nav-btn" onclick="showSection('clients')" aria-controls="clients" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-users" aria-hidden="true"></i> Clientes
                </button>
                <button class="nav-btn" onclick="showSection('sales')" aria-controls="sales" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-shopping-cart" aria-hidden="true"></i> Ventas
                </button>
                <button class="nav-btn" onclick="showSection('finances')" aria-controls="finances" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-chart-pie" aria-hidden="true"></i> Finanzas
                </button>
                <button class="nav-btn" onclick="showSection('config')" aria-controls="config" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-cog" aria-hidden="true"></i> Config
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" role="main">
            <!-- Dashboard -->
            <section id="dashboard" class="section active" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line" aria-hidden="true"></i>
                        Dashboard
                    </h2>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" role="region" aria-labelledby="totalAccounts">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-tv" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalAccounts">0</div>
                        <div class="stat-label">Cuentas Totales</div>
                    </div>
                    <div class="stat-card success" role="region" aria-labelledby="totalClients">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-users" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Clientes Activos</div>
                    </div>
                    <div class="stat-card warning" role="region" aria-labelledby="totalSales">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalSales">0</div>
                        <div class="stat-label">Ventas del Mes</div>
                    </div>
                    <div class="stat-card danger" role="region" aria-labelledby="totalRevenue">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalRevenue">$0</div>
                        <div class="stat-label">Ingresos</div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card" role="region" aria-labelledby="quick-actions-title">
                        <div class="card-header">
                            <h3 id="quick-actions-title"><i class="fas fa-bolt" aria-hidden="true"></i> Acciones Rápidas</h3>
                        </div>
                        <div class="card-body">
                            <div class="action-buttons">
                                <button class="btn" onclick="openAddAccountModal()" tabindex="0">
                                    <i class="fas fa-plus" aria-hidden="true"></i> Nueva Cuenta
                                </button>
                                <button class="btn btn-success" onclick="openAddClientModal()" tabindex="0">
                                    <i class="fas fa-user-plus" aria-hidden="true"></i> Nuevo Cliente
                                </button>
                                <button class="btn btn-warning" onclick="openSaleModal()" tabindex="0">
                                    <i class="fas fa-cash-register" aria-hidden="true"></i> Nueva Venta
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card" role="region" aria-labelledby="platform-distribution-title">
                        <div class="card-header">
                            <h3 id="platform-distribution-title"><i class="fas fa-chart-bar" aria-hidden="true"></i> Distribución por Plataforma</h3>
                        </div>
                        <div class="card-body">
                            <div id="platformStats">No hay cuentas registradas</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Cuentas -->
            <section id="accounts" class="section" role="tabpanel" aria-labelledby="accounts-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tv" aria-hidden="true"></i>
                        Gestión de Cuentas
                    </h2>
                    <button class="btn" onclick="openAddAccountModal()" tabindex="0">
                        <i class="fas fa-plus" aria-hidden="true"></i> Nueva Cuenta
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="accountsTable" role="table" aria-label="Tabla de Cuentas">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-play-circle" aria-hidden="true"></i> Plataforma</th>
                                <th scope="col"><i class="fas fa-envelope" aria-hidden="true"></i> Usuario</th>
                                <th scope="col"><i class="fas fa-user-friends" aria-hidden="true"></i> Perfiles</th>
                                <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Precio/Perfil</th>
                                <th scope="col"><i class="fas fa-credit-card" aria-hidden="true"></i> Precio Total</th>
                                <th scope="col"><i class="fas fa-info-circle" aria-hidden="true"></i> Estado</th>
                                <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Clientes -->
            <section id="clients" class="section" role="tabpanel" aria-labelledby="clients-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-users" aria-hidden="true"></i>
                        Gestión de Clientes
                    </h2>
                    <button class="btn btn-success" onclick="openAddClientModal()" tabindex="0">
                        <i class="fas fa-user-plus" aria-hidden="true"></i> Nuevo Cliente
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="clientsTable" role="table" aria-label="Tabla de Clientes">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-user" aria-hidden="true"></i> Nombre</th>
                                <th scope="col"><i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp</th>
                                <th scope="col"><i class="fas fa-envelope" aria-hidden="true"></i> Email</th>
                                <th scope="col"><i class="fas fa-shopping-cart" aria-hidden="true"></i> Compras</th>
                                <th scope="col"><i class="fas fa-calendar" aria-hidden="true"></i> Última Compra</th>
                                <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Ventas -->
            <section id="sales" class="section" role="tabpanel" aria-labelledby="sales-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                        Gestión de Ventas
                    </h2>
                    <button class="btn btn-warning" onclick="openSaleModal()" tabindex="0">
                        <i class="fas fa-cash-register" aria-hidden="true"></i> Nueva Venta
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="salesTable" role="table" aria-label="Tabla de Ventas">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-user" aria-hidden="true"></i> Cliente</th>
                                <th scope="col"><i class="fas fa-play-circle" aria-hidden="true"></i> Plataforma</th>
                                <th scope="col"><i class="fas fa-user-friends" aria-hidden="true"></i> Perfiles</th>
                                <th scope="col"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Inicio</th>
                                <th scope="col"><i class="fas fa-calendar-times" aria-hidden="true"></i> Fin</th>
                                <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Total</th>
                                <th scope="col"><i class="fas fa-info-circle" aria-hidden="true"></i> Estado</th>
                                <th scope="col"><i class="fas fa-money-bill" aria-hidden="true"></i> Pago</th> <!-- CHANGE: Added Payment Status column -->
                                <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Finanzas -->
            <section id="finances" class="section" role="tabpanel" aria-labelledby="finances-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie" aria-hidden="true"></i>
                        Centro Financiero
                    </h2>
                </div>

                <!-- Métricas principales -->
                <div class="stats-grid">
                    <div class="stat-card success" role="region" aria-labelledby="netProfit">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="netProfit">$0.00</div>
                        <div class="stat-label">Ganancia Neta</div>
                    </div>
                    <div class="stat-card danger" role="region" aria-labelledby="totalInvestment">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-hand-holding-usd" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalInvestment">$0.00</div>
                        <div class="stat-label">Inversión Total</div>
                    </div>
                    <div class="stat-card" role="region" aria-labelledby="financialTotalRevenue">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="financialTotalRevenue">$0.00</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                    <div class="stat-card warning" role="region" aria-labelledby="averageROI">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-percentage" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="averageROI">0%</div>
                        <div class="stat-label">ROI Promedio</div>
                    </div>
                </div>

                <!-- Tabs financieros -->
                <div class="finance-tabs" role="tablist" aria-label="Pestañas financieras">
                    <button class="tab-btn active" onclick="financialManager.showFinanceTab('overview')" aria-controls="finance-overview" aria-selected="true" role="tab" tabindex="0">
                        <i class="fas fa-eye" aria-hidden="true"></i> Resumen
                    </button>
                    <button class="tab-btn" onclick="financialManager.showFinanceTab('accounts')" aria-controls="finance-accounts" aria-selected="false" role="tab" tabindex="0">
                        <i class="fas fa-tv" aria-hidden="true"></i> Cuentas
                    </button>
                    <button class="tab-btn" onclick="financialManager.showFinanceTab('expenses')" aria-controls="finance-expenses" aria-selected="false" role="tab" tabindex="0">
                        <i class="fas fa-receipt" aria-hidden="true"></i> Gastos
                    </button>
                    <button class="tab-btn" onclick="financialManager.showFinanceTab('reports')" aria-controls="finance-reports" aria-selected="false" role="tab" tabindex="0">
                        <i class="fas fa-file-alt" aria-hidden="true"></i> Reportes
                    </button>
                </div>

                <!-- Tab: Resumen -->
                <div id="finance-overview" class="finance-tab-content active" role="tabpanel" aria-labelledby="overview-tab">
                    <div class="cards-grid">
                        <div class="card" role="region" aria-labelledby="profitable-accounts-title">
                            <div class="card-header">
                                <h3 id="profitable-accounts-title"><i class="fas fa-trophy" aria-hidden="true"></i> Cuentas Más Rentables</h3>
                            </div>
                            <div class="card-body">
                                <div id="topProfitableAccounts">
                                    <div class="loading">Calculando...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" role="region" aria-labelledby="losing-accounts-title">
                            <div class="card-header">
                                <h3 id="losing-accounts-title"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Cuentas con Pérdidas</h3>
                            </div>
                            <div class="card-body">
                                <div id="losingAccounts">
                                    <div class="loading">Calculando...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" role="region" aria-labelledby="upcoming-renewals-title">
                            <div class="card-header">
                                <h3 id="upcoming-renewals-title"><i class="fas fa-calendar-exclamation" aria-hidden="true"></i> Renovaciones Próximas</h3>
                            </div>
                            <div class="card-body">
                                <div id="upcomingRenewals">
                                    <div class="loading">Cargando...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" role="region" aria-labelledby="general-summary-title">
                            <div class="card-header">
                                <h3 id="general-summary-title"><i class="fas fa-chart-bar" aria-hidden="true"></i> Resumen General</h3>
                            </div>
                            <div class="card-body">
                                <div id="generalSummary">
                                    <div class="loading">Cargando...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Análisis por Cuentas -->
                <div id="finance-accounts" class="finance-tab-content" role="tabpanel" aria-labelledby="accounts-tab" hidden>
                    <div class="table-container">
                        <table class="table" id="financialAccountsTable" role="table" aria-label="Tabla de Análisis Financiero por Cuentas">
                            <thead>
                                <tr>
                                    <th scope="col"><i class="fas fa-play-circle" aria-hidden="true"></i> Plataforma</th>
                                    <th scope="col"><i class="fas fa-envelope" aria-hidden="true"></i> Email</th>
                                    <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Costo</th>
                                    <th scope="col"><i class="fas fa-chart-line" aria-hidden="true"></i> Ingresos</th>
                                    <th scope="col"><i class="fas fa-hand-holding-usd" aria-hidden="true"></i> Ganancia</th>
                                    <th scope="col"><i class="fas fa-percentage" aria-hidden="true"></i> ROI</th>
                                    <th scope="col"><i class="fas fa-info-circle" aria-hidden="true"></i> Estado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Gestión de Gastos -->
                <div id="finance-expenses" class="finance-tab-content" role="tabpanel" aria-labelledby="expenses-tab" hidden>
                    <div class="section-header">
                        <button class="btn btn-success" onclick="financialManager.openAddExpenseModal()" tabindex="0">
                            <i class="fas fa-plus" aria-hidden="true"></i> Agregar Gasto
                        </button>
                    </div>
                    
                    <div class="stats-grid mb-3">
                        <div class="stat-card warning" role="region" aria-labelledby="monthlyExpenses">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="monthlyExpenses">$0.00</div>
                            <div class="stat-label">Gastos del Mes</div>
                        </div>
                        <div class="stat-card danger" role="region" aria-labelledby="yearlyExpenses">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar" aria-hidden="true"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="yearlyExpenses">$0.00</div>
                            <div class="stat-label">Gastos del Año</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table" id="expensesTable" role="table" aria-label="Tabla de Gastos">
                            <thead>
                                <tr>
                                    <th scope="col"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Fecha</th>
                                    <th scope="col"><i class="fas fa-file-text" aria-hidden="true"></i> Descripción</th>
                                    <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Monto</th>
                                    <th scope="col"><i class="fas fa-tag" aria-hidden="true"></i> Categoría</th>
                                    <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Reportes -->
                <div id="finance-reports" class="finance-tab-content" role="tabpanel" aria-labelledby="reports-tab" hidden>
                    <div class="cards-grid">
                        <div class="card report-card" onclick="financialManager.generateMonthlyReport()" role="button" tabindex="0" aria-label="Generar Reporte Mensual"> <!-- CHANGE: Updated onclick to generateMonthlyReport -->
                            <div class="card-header">
                                <h3><i class="fas fa-chart-bar" aria-hidden="true"></i> Reporte Mensual</h3>
                            </div>
                            <div class="card-body">
                                <p>Resumen de ingresos, gastos y rentabilidad del mes actual.</p>
                            </div>
                        </div>
                        
                        <div class="card report-card" onclick="financialManager.generateAccountReport()" role="button" tabindex="0" aria-label="Generar Reporte por Cuentas">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Reporte por Cuentas</h3>
                            </div>
                            <div class="card-body">
                                <p>Análisis detallado de rentabilidad por cuenta.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Configuración -->
            <section id="config" class="section" role="tabpanel" aria-labelledby="config-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-cog" aria-hidden="true"></i>
                        Configuración
                    </h2>
                </div>

                <div class="card" role="region" aria-labelledby="firebase-status-title">
                    <div class="card-header">
                        <h3 id="firebase-status-title"><i class="fas fa-database" aria-hidden="true"></i> Estado de Firebase</h3>
                    </div>
                    <div class="card-body">
                        <div id="configStatus">
                            <p id="configInfo"><strong>Modo Demo:</strong> Funcionando con datos locales</p>
                        </div>
                        <button class="btn" onclick="testFirebaseConnection()" tabindex="0">
                            <i class="fas fa-plug" aria-hidden="true"></i> Probar Conexión
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay" role="presentation"></div>

    <!-- CHANGE: Toast Notification Element -->
    <div id="toastNotification" class="toast-notification" role="alert" aria-live="assertive">
        <span id="toastIcon"></span>
        <span id="toastMessage"></span>
    </div>
    <!-- END CHANGE -->

    <script>
        // ============= CONFIGURACIÓN FIREBASE =============
        // IMPORTANTE: Reemplaza esta configuración con la de tu proyecto Firebase.
        // Puedes encontrarla en la consola de Firebase > Configuración del proyecto > Tus apps.
        // FIREBASE_CONFIG_PLACEHOLDER
        const firebaseConfig = {
            apiKey: "AIzaSyDNINcVmzUG65S75zDp_7yPN41zyfLunr0", // Tu API Key
            authDomain: "control-de-c.firebaseapp.com", // Tu Auth Domain
            projectId: "control-de-c", // Tu Project ID
            storageBucket: "control-de-c.firebasestorage.app", // Tu Storage Bucket
            messagingSenderId: "332573734404", // Tu Messaging Sender ID
            appId: "1:332573734404:web:6f2a4a064bac6febec6751" // Tu App ID
        };
        /* REEMPLAZAR_CON_TU_CONFIG */

        // ============= VARIABLES GLOBALES =============
        let db; // Instancia de Firestore
        let accounts = [];
        let clients = [];
        let sales = [];
        let expenses = []; // Gestionado por FinancialManager, localmente en modo demo
        let currentUser = null;
        let financialManager = null;
        let activeModalInstance = null; // CHANGE: Track active modal instance

        // Detectar entorno (para modo demo en entornos específicos como Claude.ai o archivos locales)
        const isClaudeEnvironment = window.location.hostname.includes('claude.ai') || 
                                   window.location.hostname.includes('artifact') ||
                                   !window.location.hostname;

        // ============= SISTEMA DE MODALES =============
        class ModalManager {
            constructor() {
                this.activeModal = null;
                this.init();
                this.lastFocusedElement = null; // CHANGE: To store the element that opened the modal
            }

            init() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.activeModal) {
                        this.close();
                    }
                });

                document.getElementById('modal-overlay').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-overlay') {
                        this.close();
                    }
                });
            }

            open(content, options = {}) {
                // CHANGE: Close any existing modal before opening a new one
                if (this.activeModal) {
                    this.close();
                }
                this.lastFocusedElement = document.activeElement; // Store the currently focused element

                const modal = this.createModal(content, options);
                this.showModal(modal);
                activeModalInstance = this; // CHANGE: Set the active modal instance
                return modal;
            }

            confirm(message, title = 'Confirmar') {
                return new Promise((resolve) => {
                    const content = `
                        <div class="modal-header">
                            <h3><i class="fas fa-question-circle" aria-hidden="true"></i> ${title}</h3>
                            <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>${message}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modal.close(); modal.resolveConfirm(false)" tabindex="0">Cancelar</button>
                            <button class="btn btn-danger" onclick="modal.close(); modal.resolveConfirm(true)" tabindex="0">Confirmar</button>
                        </div>
                    `;

                    this.resolveConfirm = resolve;
                    this.open(content, { size: 'small' });
                });
            }

            // CHANGE: Added toast notification function
            toast(message, type = 'info', duration = 3000) {
                const toast = document.getElementById('toastNotification');
                const toastMessage = document.getElementById('toastMessage');
                const toastIcon = document.getElementById('toastIcon');

                toastMessage.textContent = message;
                toast.className = 'toast-notification show'; // Reset classes

                let iconClass = '';
                switch (type) {
                    case 'success':
                        iconClass = 'fas fa-check-circle';
                        toast.classList.add('success');
                        break;
                    case 'error':
                        iconClass = 'fas fa-times-circle';
                        toast.classList.add('error');
                        break;
                    case 'warning':
                        iconClass = 'fas fa-exclamation-triangle';
                        toast.classList.add('warning');
                        break;
                    default:
                        iconClass = 'fas fa-info-circle';
                        toast.classList.add('info');
                }
                toastIcon.className = iconClass;

                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }
            // END CHANGE

            alert(message, title = 'Información', type = 'info') {
                const icons = {
                    'info': 'fas fa-info-circle',
                    'success': 'fas fa-check-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'error': 'fas fa-times-circle'
                };

                const content = `
                    <div class="modal-header">
                        <h3><i class="${icons[type]}" aria-hidden="true"></i> ${title}</h3>
                        <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="modal.close()" tabindex="0">Aceptar</button>
                    </div>
                `;

                this.open(content, { size: 'small' });
            }

            form(config, title) {
                return new Promise((resolve) => {
                    let formHTML = `
                        <div class="modal-header">
                            <h3><i class="fas fa-edit" aria-hidden="true"></i> ${title}</h3>
                            <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="modal-form" aria-label="${title}">
                    `;
                    
                    config.fields.forEach(field => {
                        formHTML += this.createFormField(field);
                    });
                    
                    formHTML += `
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modal.close(); modal.resolveForm(null)" tabindex="0">Cancelar</button>
                            <button class="btn" onclick="modal.submitForm()" tabindex="0">Enviar</button>
                        </div>
                    `;

                    this.resolveForm = resolve;
                    this.open(formHTML, { size: 'medium' });
                });
            }

            submitForm() {
                const form = document.getElementById('modal-form');
                if (!form.checkValidity()) {
                    form.reportValidity(); // Muestra los mensajes de validación del navegador
                    return;
                }
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                this.close();
                this.resolveForm(data);
            }

            createFormField(field) {
                const { type, name, label, placeholder, required, options, value, min, max, step } = field;
                
                let fieldHTML = `<div class="form-group">`;
                if (label) fieldHTML += `<label for="${name}">${label}${required ? ' <span aria-hidden="true">*</span>' : ''}</label>`;
                
                switch (type) {
                    case 'text':
                    case 'email':
                    case 'password':
                        fieldHTML += `<input type="${type}" name="${name}" id="${name}" class="form-control" placeholder="${placeholder || ''}" ${required ? 'required' : ''} value="${value !== undefined ? value : ''}" tabindex="0" aria-required="${required ? 'true' : 'false'}">`;
                        break;
                    case 'number':
                        fieldHTML += `<input type="${type}" name="${name}" id="${name}" class="form-control" placeholder="${placeholder || ''}" ${required ? 'required' : ''} value="${value !== undefined ? value : ''}" tabindex="0" aria-required="${required ? 'true' : 'false'}" ${min !== undefined ? `min="${min}"` : ''} ${max !== undefined ? `max="${max}"` : ''} ${step !== undefined ? `step="${step}"` : ''}>`;
                        break;
                    case 'date':
                        fieldHTML += `<input type="${type}" name="${name}" id="${name}" class="form-control" ${required ? 'required' : ''} value="${value !== undefined ? value : ''}" tabindex="0" aria-required="${required ? 'true' : 'false'}">`;
                        break;
                    case 'textarea':
                        fieldHTML += `<textarea name="${name}" id="${name}" class="form-control" rows="3" placeholder="${placeholder || ''}" ${required ? 'required' : ''} tabindex="0" aria-required="${required ? 'true' : 'false'}">${value !== undefined ? value : ''}</textarea>`;
                        break;
                    case 'select':
                        fieldHTML += `<select name="${name}" id="${name}" class="form-control" ${required ? 'required' : ''} tabindex="0" aria-required="${required ? 'true' : 'false'}">`;
                        if (options) {
                            options.forEach(option => {
                                fieldHTML += `<option value="${option.value}" ${value == option.value ? 'selected' : ''}>${option.text}</option>`;
                            });
                        }
                        fieldHTML += `</select>`;
                        break;
                }
                
                fieldHTML += `</div>`;
                return fieldHTML;
            }

            createModal(content, options = {}) {
                const { size = 'medium' } = options;
                
                const modal = document.createElement('div');
                modal.className = `modal modal-${size}`;
                modal.setAttribute('role', 'dialog');
                modal.setAttribute('aria-modal', 'true');
                modal.setAttribute('aria-labelledby', 'modal-title'); // Asume que el header tiene un h3 con id="modal-title"
                modal.innerHTML = `
                    <div class="modal-content">
                        ${content}
                    </div>
                `;

                return modal;
            }

            showModal(modal) {
                this.activeModal = modal;
                const overlay = document.getElementById('modal-overlay');
                
                overlay.appendChild(modal);
                overlay.classList.add('active');
                document.body.classList.add('modal-open');

                // Enfocar el primer elemento interactivo dentro del modal para accesibilidad
                const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                const firstFocusableElement = focusableElements[0];
                if (firstFocusableElement) {
                    firstFocusableElement.focus();
                }
            }

            close() {
                if (!this.activeModal) return;

                this.activeModal.classList.remove('modal-show');
                
                setTimeout(() => {
                    if (this.activeModal && this.activeModal.parentNode) {
                        this.activeModal.parentNode.removeChild(this.activeModal);
                    }
                    this.activeModal = null;
                    activeModalInstance = null; // CHANGE: Clear the active modal instance
                    
                    const overlay = document.getElementById('modal-overlay');
                    overlay.classList.remove('active');
                    document.body.classList.remove('modal-open');

                    // CHANGE: Return focus to the element that opened the modal
                    if (this.lastFocusedElement) {
                        this.lastFocusedElement.focus();
                        this.lastFocusedElement = null;
                    }
                }, 300);
            }
        }

        const modal = new ModalManager();

        // ============= SISTEMA FINANCIERO =============
        class FinancialManager {
            constructor() {
                this.expenses = [];
                try {
                    if (typeof localStorage !== 'undefined') {
                        this.expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                    }
                } catch (e) {
                    console.warn('localStorage no disponible para gastos:', e);
                }
            }

            calculateFinancialMetrics() {
                const metrics = {
                    totalInvestment: 0,
                    totalRevenue: 0,
                    totalExpenses: 0,
                    netProfit: 0,
                    averageROI: 0
                };

                // Calcular inversión total y ingresos de cuentas
                accounts.forEach(account => {
                    metrics.totalInvestment += parseFloat(account.acquisitionCost) || 0;
                    
                    // Calcular ingresos generados por esta cuenta
                    const accountSales = sales.filter(sale => sale.accountId === account.id);
                    const accountRevenue = accountSales.reduce((sum, sale) => sum + parseFloat(sale.total), 0);
                    account.totalEarned = accountRevenue; // Actualiza totalEarned en el objeto de la cuenta
                });

                // Calcular ingresos totales de todas las ventas
                metrics.totalRevenue = sales.reduce((sum, sale) => sum + parseFloat(sale.total), 0);

                // Calcular gastos adicionales (desde localStorage en modo demo)
                metrics.totalExpenses = this.expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                
                // Calcular ganancia neta
                metrics.netProfit = metrics.totalRevenue - metrics.totalInvestment - metrics.totalExpenses;
                
                // Calcular ROI promedio
                if (metrics.totalInvestment > 0) {
                    metrics.averageROI = ((metrics.netProfit / metrics.totalInvestment) * 100);
                }

                return metrics;
            }

            updateFinancialDashboard() {
                const metrics = this.calculateFinancialMetrics();
                
                // Actualizar elementos del DOM
                this.updateElement('netProfit', `$${metrics.netProfit.toFixed(2)}`);
                this.updateElement('totalInvestment', `$${metrics.totalInvestment.toFixed(2)}`);
                this.updateElement('financialTotalRevenue', `$${metrics.totalRevenue.toFixed(2)}`);
                this.updateElement('averageROI', `${metrics.averageROI.toFixed(1)}%`);

                this.updateTopPerformingAccounts();
                this.updateUpcomingRenewals();
                this.updateGeneralSummary();
                this.renderFinancialAccountsTable(); // Asegura que esta tabla se actualice
                this.renderExpensesTable(); // Asegura que la tabla de gastos se actualice
                this.updateExpensesSummary(); // Asegura que el resumen de gastos se actualice
            }

            updateElement(id, content) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = content;
                }
            }

            getTopPerformingAccounts(limit = 5) {
                return accounts
                    .map(account => ({
                        ...account,
                        profit: (account.totalEarned || 0) - (parseFloat(account.acquisitionCost) || 0),
                        roi: (parseFloat(account.acquisitionCost) || 0) > 0 ? 
                            (((account.totalEarned || 0) - (parseFloat(account.acquisitionCost) || 0)) / (parseFloat(account.acquisitionCost) || 0) * 100) : 0
                    }))
                    .sort((a, b) => b.profit - a.profit)
                    .slice(0, limit);
            }

            getLosingAccounts() {
                return accounts
                    .map(account => ({
                        ...account,
                        profit: (account.totalEarned || 0) - (parseFloat(account.acquisitionCost) || 0)
                    }))
                    .filter(account => account.profit < 0)
                    .sort((a, b) => a.profit - b.profit);
            }

            updateTopPerformingAccounts() {
                const topAccounts = this.getTopPerformingAccounts(3);
                const container = document.getElementById('topProfitableAccounts');
                
                if (!container) return;

                if (topAccounts.length === 0 || topAccounts.every(acc => acc.profit === 0)) {
                    container.innerHTML = '<div class="no-data"><i class="fas fa-info-circle" aria-hidden="true"></i> Agrega cuentas con costos para ver análisis</div>';
                    return;
                }

                container.innerHTML = topAccounts.map(account => `
                    <div class="account-profit-item">
                        <div>
                            <strong><i class="fas fa-play-circle" aria-hidden="true"></i> ${account.platform}</strong><br>
                            <small>${account.email}</small>
                        </div>
                        <div class="profit-info">
                            <div class="profit">$${account.profit.toFixed(2)}</div>
                            <div class="roi">${account.roi.toFixed(1)}% ROI</div>
                        </div>
                    </div>
                `).join('');

                // Actualizar cuentas con pérdidas
                const losingAccounts = this.getLosingAccounts();
                const losingContainer = document.getElementById('losingAccounts');
                
                if (!losingContainer) return;
                
                if (losingAccounts.length === 0) {
                    losingContainer.innerHTML = '<div class="no-data"><i class="fas fa-check-circle" aria-hidden="true"></i> ¡Todas las cuentas son rentables!</div>';
                } else {
                    losingContainer.innerHTML = losingAccounts.map(account => `
                        <div class="account-profit-item loss">
                            <div>
                                <strong><i class="fas fa-play-circle" aria-hidden="true"></i> ${account.platform}</strong><br>
                                <small>${account.email}</small>
                            </div>
                            <div class="loss-info">
                                <div class="loss">-$${Math.abs(account.profit).toFixed(2)}</div>
                                <div class="status">Pérdida</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            getUpcomingRenewals(days = 30) {
                const now = new Date();
                
                return accounts
                    .filter(account => account.renewalDate)
                    .map(account => ({
                        ...account,
                        daysUntilRenewal: Math.ceil((new Date(account.renewalDate) - now) / (1000 * 60 * 60 * 24))
                    }))
                    .filter(account => account.daysUntilRenewal <= days && account.daysUntilRenewal >= 0)
                    .sort((a, b) => a.daysUntilRenewal - b.daysUntilRenewal);
            }

            updateUpcomingRenewals() {
                const renewals = this.getUpcomingRenewals();
                const container = document.getElementById('upcomingRenewals');
                
                if (!container) return;
                
                if (renewals.length === 0) {
                    container.innerHTML = '<div class="no-data"><i class="fas fa-calendar-check" aria-hidden="true"></i> No hay renovaciones próximas</div>';
                    return;
                }

                container.innerHTML = renewals.map(renewal => `
                    <div class="renewal-item ${renewal.daysUntilRenewal <= 3 ? 'urgent' : ''}">
                        <div>
                            <strong><i class="fas fa-play-circle" aria-hidden="true"></i> ${renewal.platform}</strong><br>
                            <small>${renewal.email}</small>
                        </div>
                        <div class="renewal-info">
                            <div class="cost">$${parseFloat(renewal.renewalCost || 0).toFixed(2)}</div>
                            <div class="days">${renewal.daysUntilRenewal} días</div>
                        </div>
                    </div>
                `).join('');
            }

            updateGeneralSummary() {
                const container = document.getElementById('generalSummary');
                if (!container) return;

                const totalAccounts = accounts.length;
                const rentableAccounts = accounts.filter(acc => 
                    (acc.totalEarned || 0) > (parseFloat(acc.acquisitionCost) || 0)
                ).length;
                const totalClients = clients.length;
                const totalSales = sales.length;
                const activeSales = sales.filter(sale => sale.status === 'Activa').length;

                container.innerHTML = `
                    <div class="summary-stats">
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-tv" aria-hidden="true"></i> Total de cuentas:</span>
                            <span class="value">${totalAccounts}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-chart-line" aria-hidden="true"></i> Cuentas rentables:</span>
                            <span class="value">${rentableAccounts}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-users" aria-hidden="true"></i> Total de clientes:</span>
                            <span class="value">${totalClients}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-shopping-cart" aria-hidden="true"></i> Ventas realizadas:</span>
                            <span class="value">${totalSales}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-check-circle" aria-hidden="true"></i> Ventas activas:</span>
                            <span class="value">${activeSales}</span>
                        </div>
                    </div>
                `;
            }

            // CHANGE: showFinanceTab now correctly handles tab switching and data loading
            showFinanceTab(tabName) {
                // Ocultar todos los contenidos
                document.querySelectorAll('.finance-tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.setAttribute('hidden', 'true'); // Ocultar para lectores de pantalla
                });
                
                // Remover clase active de todos los botones y aria-selected
                document.querySelectorAll('.finance-tabs .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                
                // Mostrar contenido seleccionado
                const targetTab = document.getElementById(`finance-${tabName}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                    targetTab.removeAttribute('hidden'); // Mostrar para lectores de pantalla
                }
                
                // Activar botón correspondiente
                const clickedButton = event.currentTarget; 
                if (clickedButton) {
                    clickedButton.classList.add('active');
                    clickedButton.setAttribute('aria-selected', 'true');
                }
                
                // Cargar datos específicos del tab
                switch(tabName) {
                    case 'accounts':
                        this.renderFinancialAccountsTable();
                        break;
                    case 'expenses':
                        this.renderExpensesTable();
                        this.updateExpensesSummary();
                        break;
                    case 'overview':
                        this.updateTopPerformingAccounts();
                        this.updateUpcomingRenewals();
                        this.updateGeneralSummary();
                        break;
                    case 'reports': // CHANGE: Added reports tab logic
                        // No specific render function needed here, cards are static
                        break;
                }
            }
            // END CHANGE

            renderFinancialAccountsTable() {
                const tbody = document.querySelector('#financialAccountsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                accounts.forEach(account => {
                    const totalEarned = account.totalEarned || 0;
                    const acquisitionCost = parseFloat(account.acquisitionCost) || 0;
                    const profit = totalEarned - acquisitionCost;
                    const roi = acquisitionCost > 0 ? ((profit / acquisitionCost) * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><i class="fas fa-play-circle" aria-hidden="true"></i> ${escapeHTML(account.platform)}</td>
                        <td>${escapeHTML(account.email)}</td>
                        <td>$${acquisitionCost.toFixed(2)}</td>
                        <td>$${totalEarned.toFixed(2)}</td>
                        <td class="${profit >= 0 ? 'profit' : 'loss'}">$${profit.toFixed(2)}</td>
                        <td class="${roi >= 0 ? 'positive' : 'negative'}">${roi.toFixed(1)}%</td>
                        <td>
                            <span class="status-badge ${profit >= 0 ? 'available' : 'unavailable'}">
                                ${profit >= 0 ? 'Rentable' : 'Con pérdida'}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            openAddExpenseModal() {
                const formConfig = {
                    fields: [
                        {
                            type: 'select',
                            name: 'type',
                            label: 'Tipo de Gasto',
                            required: true,
                            options: [
                                { value: '', text: 'Seleccionar tipo...' },
                                { value: 'renewal', text: 'Renovación de cuenta' },
                                { value: 'acquisition', text: 'Compra de cuenta nueva' },
                                { value: 'operational', text: 'Gasto operacional' },
                                { value: 'other', text: 'Otros' }
                            ]
                        },
                        { type: 'text', name: 'description', label: 'Descripción', required: true },
                        { type: 'number', name: 'amount', label: 'Monto ($)', required: true, placeholder: '0.00', step: '0.01', min: '0' },
                        { type: 'date', name: 'date', label: 'Fecha', required: true, value: new Date().toISOString().split('T')[0] },
                        { type: 'text', name: 'category', label: 'Categoría', placeholder: 'Ej: Suscripciones, Herramientas, etc.' }
                    ]
                };

                modal.form(formConfig, 'Agregar Nuevo Gasto').then(async data => { // CHANGE: Made async to await saveToFirebase
                    if (data) {
                        await this.addExpense(data); // CHANGE: Await addExpense
                    }
                });
            }

            async addExpense(expenseData) { // CHANGE: Made async
                // Basic sanitization for text fields
                const description = sanitizeInput(expenseData.description);
                const category = sanitizeInput(expenseData.category || 'General');

                const expense = {
                    id: Date.now().toString(),
                    type: expenseData.type,
                    description: description,
                    amount: parseFloat(expenseData.amount),
                    date: expenseData.date,
                    category: category,
                    createdAt: new Date().toISOString()
                };

                this.expenses.push(expense);
                this.saveExpenses(); // Save to localStorage
                
                // CHANGE: Save to Firebase
                try {
                    await saveToFirebase('expenses', expense);
                    modal.toast('Gasto agregado correctamente', 'success'); // CHANGE: Use toast
                } catch (error) {
                    console.error('Error saving expense to Firebase:', error);
                    modal.toast('Error al guardar el gasto en la nube.', 'error'); // CHANGE: Use toast
                }
                // END CHANGE

                this.renderExpensesTable();
                this.updateExpensesSummary();
                this.updateFinancialDashboard();
            }

            saveExpenses() {
                try {
                    if (typeof localStorage !== 'undefined') {
                        localStorage.setItem('expenses', JSON.stringify(this.expenses));
                    }
                } catch (e) {
                    console.error('Error al guardar gastos en localStorage:', e);
                }
            }

            // CHANGE: loadExpensesFromFirebase to load expenses from Firestore
            async loadExpensesFromFirebase() {
                if (db && !isClaudeEnvironment) {
                    try {
                        const expensesSnapshot = await db.collection('expenses').orderBy('createdAt', 'desc').get();
                        this.expenses = [];
                        expensesSnapshot.forEach((doc) => {
                            this.expenses.push({ id: doc.id, ...doc.data() });
                        });
                        this.saveExpenses(); // Sync with localStorage
                        console.log('✅ Gastos cargados desde Firebase correctamente.');
                    } catch (error) {
                        console.error('❌ Error al cargar gastos desde Firebase:', error);
                        modal.toast('Error al cargar gastos desde la nube.', 'error');
                    }
                } else {
                    // In demo mode or if Firebase is not initialized, load from localStorage
                    try {
                        this.expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                        console.log('✅ Gastos cargados desde localStorage (modo demo).');
                    } catch (error) {
                        console.error('Error loading expenses from localStorage:', error);
                    }
                }
            }
            // END CHANGE

            renderExpensesTable() {
                const tbody = document.querySelector('#expensesTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                // Ordenar por fecha más reciente
                const sortedExpenses = this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(expense.date).toLocaleDateString()}</td>
                        <td>${escapeHTML(expense.description)}</td>
                        <td>$${expense.amount.toFixed(2)}</td>
                        <td><span class="status-badge">${escapeHTML(expense.category)}</span></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="financialManager.deleteExpense('${expense.id}')" aria-label="Eliminar gasto ${escapeHTML(expense.description)}" tabindex="0">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateExpensesSummary() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // Gastos del mes actual
                const monthlyExpenses = this.expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                }).reduce((sum, expense) => sum + expense.amount, 0);

                // Gastos anuales
                const yearlyExpenses = this.expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getFullYear() === currentYear;
                }).reduce((sum, expense) => sum + expense.amount, 0);

                // Actualizar DOM
                this.updateElement('monthlyExpenses', `$${monthlyExpenses.toFixed(2)}`);
                this.updateElement('yearlyExpenses', `$${yearlyExpenses.toFixed(2)}`);
            }

            async deleteExpense(id) { // CHANGE: Made async
                const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar este gasto?');
                if (confirmed) {
                    try {
                        this.expenses = this.expenses.filter(expense => expense.id !== id);
                        this.saveExpenses(); // Save to localStorage
                        await deleteFromFirebase('expenses', id); // CHANGE: Delete from Firebase
                        this.renderExpensesTable();
                        this.updateExpensesSummary();
                        this.updateFinancialDashboard();
                        modal.toast('Gasto eliminado correctamente', 'success'); // CHANGE: Use toast
                    } catch (error) {
                        console.error('Error deleting expense:', error);
                        modal.toast(`Error al eliminar el gasto: ${error.message}`, 'error'); // CHANGE: Use toast
                    }
                }
            }

            // CHANGE: Implemented generateMonthlyReport
            generateMonthlyReport() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const monthSales = sales.filter(sale => {
                    const saleDate = new Date(sale.startDate);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                });

                const monthlyRevenue = monthSales.reduce((sum, sale) => sum + parseFloat(sale.total || 0), 0);
                const monthlyExpenses = this.expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                }).reduce((sum, expense) => sum + expense.amount, 0);

                const monthlyNetProfit = monthlyRevenue - monthlyExpenses;

                const activeAccounts = accounts.filter(acc => acc.status === 'Disponible').length;
                const occupiedAccounts = accounts.filter(acc => acc.status === 'Ocupado').length;
                const unavailableAccounts = accounts.filter(acc => acc.status === 'No disponible').length; // CHANGE: Added 'No disponible' status

                const reportContent = `
                    <p><strong>Mes:</strong> ${new Date(currentYear, currentMonth).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</p>
                    <p><strong>Ingresos Totales:</strong> $${monthlyRevenue.toFixed(2)}</p>
                    <p><strong>Gastos Totales:</strong> $${monthlyExpenses.toFixed(2)}</p>
                    <p><strong>Ganancia Neta:</strong> $${monthlyNetProfit.toFixed(2)}</p>
                    <br>
                    <p><strong>Cuentas Disponibles:</strong> ${activeAccounts}</p>
                    <p><strong>Cuentas Ocupadas:</strong> ${occupiedAccounts}</p>
                    <p><strong>Cuentas No Disponibles:</strong> ${unavailableAccounts}</p>
                `;

                modal.alert(reportContent, 'Reporte Mensual', 'info');
            }
            // END CHANGE

            generateAccountReport() {
                modal.alert('Generando reporte por cuentas... (Funcionalidad en desarrollo)', 'Reporte por Cuentas', 'info');
                // Implement actual report generation logic here
            }
        }

        // ============= INICIALIZACIÓN FIREBASE =============
        function initializeFirebase(config) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.firestore();
                // Habilitar persistencia offline
                db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.warn('⚠️ Persistencia offline no disponible: múltiples pestañas abiertas o datos ya persistidos.');
                    } else if (err.code == 'unimplemented') {
                        console.warn('⚠️ Persistencia offline no soportada en este navegador.');
                    } else {
                        console.error('Error al habilitar persistencia offline:', err);
                    }
                });
                console.log('✅ Firebase inicializado correctamente.');
                return true;
            } catch (error) {
                console.error('❌ Error al inicializar Firebase:', error);
                return false;
            }
        }

        // ============= FUNCIONES DE AUTENTICACIÓN =============
        function showDemoMode() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('demoScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function enterDemoMode() {
            currentUser = { email: 'demo@usuario.com', displayName: 'Usuario Demo' };
            showMainApp();
            
            if (accounts.length === 0) {
                loadDemoData();
            }
            
            // Inicializar el gestor financiero y actualizar el dashboard después de cargar los datos demo
            if (!financialManager) {
                financialManager = new FinancialManager();
            }
            financialManager.updateFinancialDashboard();
        }

        function checkAuthState() {
            if (isClaudeEnvironment) {
                showDemoMode();
                return;
            }

            console.log('🔍 Verificando estado de autenticación...');
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log('✅ Usuario autenticado:', user.email);
                    currentUser = user;
                    showMainApp();
                    // Cargar datos y luego inicializar el gestor financiero
                    loadData().then(() => {
                        if (!financialManager) {
                            financialManager = new FinancialManager();
                        }
                        financialManager.updateFinancialDashboard();
                        migrateExistingAccounts(); // Ejecutar migración después de cargar datos
                    }).catch(error => {
                        console.error("Error al cargar datos después de la autenticación:", error);
                        modal.alert("Error al cargar datos. Intenta recargar la página.", "Error de Carga", "error");
                    });
                } else {
                    console.log('❌ No hay usuario autenticado.');
                    currentUser = null;
                    showLoginScreen();
                }
            });
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showLoginError('Por favor completa todos los campos.');
                return;
            }

            showLoginLoading(true);
            hideLoginError();

            try {
                await firebase.auth().signInWithEmailAndPassword(email, password);
                console.log('Usuario autenticado con éxito.');
                showLoginLoading(false);
            } catch (error) {
                console.error('Error de autenticación:', error);
                showLoginLoading(false);
                
                let errorMessage = 'Error de autenticación';
                let helpMessage = '';
                
                switch(error.code) {
                    case 'auth/network-request-failed':
                        errorMessage = 'Error de conexión a Firebase.';
                        helpMessage = 'Verifica tu conexión a internet o la configuración de Firebase.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Usuario no encontrado.';
                        helpMessage = 'Verifica tu email o crea el usuario en Firebase Console.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Contraseña incorrecta.';
                        helpMessage = 'Verifica tu contraseña.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido.';
                        helpMessage = 'Verifica que el email tenga formato correcto.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Demasiados intentos fallidos.';
                        helpMessage = 'Espera unos minutos antes de intentar nuevamente.';
                        break;
                    default:
                        errorMessage = error.message;
                        helpMessage = 'Verifica la configuración de Firebase.';
                }
                
                showLoginError(errorMessage + (helpMessage ? '\n\n💡 ' + helpMessage : ''));
            }
        }

        async function logoutUser() {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas cerrar sesión?');
            if (confirmed) {
                if (isClaudeEnvironment) {
                    currentUser = null;
                    showDemoMode();
                } else {
                    try {
                        await firebase.auth().signOut();
                        console.log('Usuario desconectado.');
                    } catch (error) {
                        console.error('Error al cerrar sesión:', error);
                        modal.alert('Error al cerrar sesión: ' + error.message, 'Error', 'error');
                    }
                }
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('demoScreen').style.display = 'none';
            
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            showLoginLoading(false);
            hideLoginError();
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('demoScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            const userEmail = currentUser.email || 'demo@usuario.com';
            document.getElementById('userEmail').textContent = userEmail;
            
            // Actualización inicial del dashboard, el renderizado completo ocurrirá después de la carga de datos
            updateDashboard(); 
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideLoginError() {
            document.getElementById('loginError').style.display = 'none';
        }

        function showLoginLoading(show) {
            document.getElementById('loginLoading').style.display = show ? 'block' : 'none';
        }

        // ============= FUNCIONES DE DATOS (CRUD) =============
        async function loadData() {
            if (db && !isClaudeEnvironment) {
                try {
                    await loadFromFirebase();
                } catch (error) {
                    console.error("Error cargando datos desde Firebase, intentando con localStorage:", error);
                    loadFromLocalStorage();
                }
            } else {
                loadFromLocalStorage();
            }
        }

        async function loadFromFirebase() {
            console.log('🔥 Cargando datos desde Firebase...');
            
            // CHANGE: Load expenses from Firebase as well
            const [accountsSnapshot, clientsSnapshot, salesSnapshot, expensesSnapshot] = await Promise.all([
                db.collection('accounts').orderBy('createdAt', 'desc').get(),
                db.collection('clients').orderBy('createdAt', 'desc').get(),
                db.collection('sales').orderBy('createdAt', 'desc').get(),
                db.collection('expenses').orderBy('createdAt', 'desc').get() // Load expenses
            ]);

            accounts = [];
            accountsSnapshot.forEach((doc) => {
                accounts.push({ id: doc.id, ...doc.data() });
            });

            clients = [];
            clientsSnapshot.forEach((doc) => {
                const clientData = doc.data();
                clients.push({ 
                    id: doc.id, 
                    ...clientData,
                    purchases: clientData.purchases || 0,
                    lastPurchase: clientData.lastPurchase || null,
                    email: clientData.email || '',
                    notes: clientData.notes || ''
                });
            });

            sales = [];
            salesSnapshot.forEach((doc) => {
                sales.push({ id: doc.id, ...doc.data() });
            });

            // CHANGE: Populate financialManager.expenses from Firebase snapshot
            financialManager.expenses = [];
            expensesSnapshot.forEach((doc) => {
                financialManager.expenses.push({ id: doc.id, ...doc.data() });
            });
            financialManager.saveExpenses(); // Sync with localStorage
            // END CHANGE

            console.log('✅ Datos cargados desde Firebase correctamente.');
            renderAll(); // Renderiza todas las tablas después de cargar los datos
            updateDashboard(); // Actualiza las estadísticas del dashboard
        }

        function loadFromLocalStorage() {
            try {
                accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                clients = JSON.parse(localStorage.getItem('clients') || '[]');
                sales = JSON.parse(localStorage.getItem('sales') || '[]');
                
                // CHANGE: Load expenses for financialManager from localStorage
                if (financialManager) {
                    financialManager.expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                }
                // END CHANGE

                console.log('✅ Datos locales cargados correctamente.');
                renderAll(); // Renderiza todas las tablas después de cargar los datos
                updateDashboard(); // Actualiza las estadísticas del dashboard
            } catch (error) {
                console.error('Error cargando datos locales:', error);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('accounts', JSON.stringify(accounts));
                localStorage.setItem('clients', JSON.stringify(clients));
                localStorage.setItem('sales', JSON.stringify(sales));
                // CHANGE: Save expenses to localStorage
                if (financialManager) {
                    financialManager.saveExpenses();
                }
                // END CHANGE
            } catch (error) {
                console.error('Error guardando datos locales:', error);
            }
        }

        async function saveToFirebase(collectionName, data) {
            if (!db || isClaudeEnvironment || !currentUser) {
                console.warn(`Saltando guardado en Firebase para ${collectionName}/${data.id}. No conectado, modo demo o sin usuario.`);
                return Promise.resolve();
            }

            console.log(`💾 Guardando en Firebase: ${collectionName}/${data.id}`);
            
            try {
                await db.collection(collectionName).doc(data.id).set(data);
                console.log(`✅ Guardado en Firebase: ${collectionName}/${data.id}`);
            } catch (error) {
                console.error(`❌ Error guardando en Firebase ${collectionName}/${data.id}:`, error);
                modal.toast(`Error al guardar en la nube: ${error.message}`, 'error'); // CHANGE: Use toast
                throw error;
            }
        }

        async function deleteFromFirebase(collectionName, id) {
            if (!db || isClaudeEnvironment || !currentUser) {
                console.warn(`Saltando eliminación en Firebase para ${collectionName}/${id}. No conectado, modo demo o sin usuario.`);
                return Promise.resolve();
            }

            console.log(`🗑️ Eliminando de Firebase: ${collectionName}/${id}`);
            try {
                await db.collection(collectionName).doc(id).delete();
                console.log(`✅ Eliminado de Firebase: ${collectionName}/${id}`);
            } catch (error) {
                console.error(`❌ Error eliminando de Firebase ${collectionName}/${id}:`, error);
                modal.toast(`Error al eliminar en la nube: ${error.message}`, 'error'); // CHANGE: Use toast
                throw error;
            }
        }

        function loadDemoData() {
            accounts = [
                {
                    id: "demo1",
                    platform: "Netflix",
                    email: "netflix@ejemplo.com",
                    password: "password123",
                    devices: 4,
                    pricePerProfile: 2.50,
                    fullAccountPrice: 8.00,
                    profiles: [
                        { name: "Perfil 1", pin: "Sin pin", available: true, soldTo: null, saleId: null },
                        { name: "Perfil 2", pin: "1234", available: true, soldTo: null, saleId: null },
                        { name: "Perfil 3", pin: "Sin pin", available: false, soldTo: "demo-client-1", saleId: "demo-sale-1" },
                        { name: "Perfil 4", pin: "5678", available: true, soldTo: null, saleId: null }
                    ],
                    status: "Disponible",
                    acquisitionCost: 5.00,
                    supplier: "Proveedor Demo",
                    renewalCost: 8.00,
                    renewalDate: "2024-12-15",
                    totalEarned: 7.50,
                    createdAt: new Date().toISOString()
                },
                {
                    id: "demo2",
                    platform: "HBO Max",
                    email: "hbo@ejemplo.com",
                    password: "hbopass456",
                    devices: 3,
                    pricePerProfile: 3.00,
                    fullAccountPrice: 10.00,
                    profiles: [
                        { name: "Usuario 1", pin: "Sin pin", available: true, soldTo: null, saleId: null },
                        { name: "Usuario 2", pin: "9999", available: true, soldTo: null, saleId: null },
                        { name: "Usuario 3", pin: "Sin pin", available: true, soldTo: null, saleId: null }
                    ],
                    status: "Disponible",
                    acquisitionCost: 7.00,
                    supplier: "Proveedor Demo",
                    renewalCost: 0,
                    renewalDate: null,
                    totalEarned: 0,
                    createdAt: new Date().toISOString()
                },
                {
                    id: "demo3",
                    platform: "Spotify",
                    email: "spotify@ejemplo.com",
                    password: "spotifypass",
                    devices: 1,
                    pricePerProfile: 5.00,
                    fullAccountPrice: 5.00,
                    profiles: [
                        { name: "Usuario Principal", pin: "N/A", available: false, soldTo: "demo-client-2", saleId: "demo-sale-2" }
                    ],
                    status: "Ocupado",
                    acquisitionCost: 6.00, // Esta cuenta está perdiendo dinero en el demo
                    supplier: "Proveedor Demo",
                    renewalCost: 5.00,
                    renewalDate: "2024-11-01", // Próxima renovación
                    totalEarned: 5.00,
                    createdAt: new Date().toISOString()
                }
            ];

            clients = [
                {
                    id: "demo-client-1",
                    name: "Juan Pérez",
                    whatsApp: "+593991234567",
                    email: "juan@ejemplo.com",
                    notes: "Cliente frecuente",
                    purchases: 1,
                    lastPurchase: "2024-08-20",
                    createdAt: new Date().toISOString()
                },
                {
                    id: "demo-client-2",
                    name: "María García",
                    whatsApp: "+593987654321",
                    email: "maria@ejemplo.com",
                    notes: "Nuevo cliente",
                    purchases: 1,
                    lastPurchase: "2024-09-01",
                    createdAt: new Date().toISOString()
                }
            ];

            sales = [
                {
                    id: "demo-sale-1",
                    clientId: "demo-client-1",
                    accountId: "demo1",
                    profilesCount: 1,
                    startDate: "2024-08-20",
                    endDate: "2024-09-19",
                    total: 2.50,
                    status: "Activa",
                    paid: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: "demo-sale-2",
                    clientId: "demo-client-2",
                    accountId: "demo3",
                    profilesCount: 1,
                    startDate: "2024-09-01",
                    endDate: "2024-09-30",
                    total: 5.00,
                    status: "Activa",
                    paid: true,
                    createdAt: new Date().toISOString()
                }
            ];

            // Gastos demo para FinancialManager (se guardan en localStorage)
            financialManager.expenses = [
                {
                    id: "exp1",
                    type: "acquisition",
                    description: "Compra de cuenta Netflix",
                    amount: 5.00,
                    date: "2024-08-15",
                    category: "Cuentas",
                    createdAt: "2024-08-15T10:00:00Z"
                },
                {
                    id: "exp2",
                    type: "operational",
                    description: "Herramienta de gestión",
                    amount: 10.00,
                    date: "2024-09-05",
                    category: "Software",
                    createdAt: "2024-09-05T11:30:00Z"
                }
            ];
            financialManager.saveExpenses(); // Guarda los gastos demo en localStorage

            saveData(); // Guarda cuentas, clientes, ventas en localStorage
            renderAll(); // Renderiza todas las tablas
            updateDashboard(); // Actualiza las estadísticas del dashboard
            financialManager.updateFinancialDashboard(); // Actualiza el dashboard financiero
        }

        // ============= FUNCIONES DE UI =============
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.setAttribute('hidden', 'true'); // Ocultar para lectores de pantalla
            });
            
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.removeAttribute('hidden'); // Mostrar para lectores de pantalla
            }
            
            // Encuentra el botón que activó el evento y añade la clase 'active' y aria-selected
            const clickedButton = event.currentTarget;
            if (clickedButton) {
                clickedButton.classList.add('active');
                clickedButton.setAttribute('aria-selected', 'true');
            }
            
            if (sectionId === 'dashboard') {
                updateDashboard();
            } else if (sectionId === 'finances' && financialManager) {
                financialManager.updateFinancialDashboard();
                // Asegura que la pestaña financiera predeterminada esté activa al entrar en la sección de finanzas
                financialManager.showFinanceTab('overview'); 
            }
        }

        function updateDashboard() {
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('totalClients').textContent = clients.length;
            
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthSales = sales.filter(sale => {
                const saleDate = new Date(sale.startDate);
                return saleDate.getMonth() === thisMonth && saleDate.getFullYear() === thisYear;
            });
            
            document.getElementById('totalSales').textContent = monthSales.length;
            
            const totalRevenue = monthSales.reduce((sum, sale) => sum + parseFloat(sale.total || 0), 0);
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            
            updatePlatformStats();
        }

        function updatePlatformStats() {
            const platforms = {};
            accounts.forEach(account => {
                const platform = account.platform;
                platforms[platform] = (platforms[platform] || 0) + 1;
            });

            const statsHtml = Object.entries(platforms)
                .map(([platform, count]) => `<div><strong>${escapeHTML(platform)}:</strong> ${count}</div>`)
                .join('') || '<div>No hay cuentas registradas</div>';

            document.getElementById('platformStats').innerHTML = statsHtml;
        }

        function renderAccounts() {
            const tbody = document.querySelector('#accountsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            accounts.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHTML(account.platform)}</td>
                    <td>${escapeHTML(account.email)}</td>
                    <td>${account.profiles.length}</td>
                    <td>$${(account.pricePerProfile || 0).toFixed(2)}</td>
                    <td>$${(account.fullAccountPrice || 0).toFixed(2)}</td>
                    <td>
                        <!-- CHANGE: Inline editable status for accounts -->
                        <select class="form-control status-dropdown" onchange="updateAccountStatus('${account.id}', this.value)" aria-label="Cambiar estado de cuenta">
                            <option value="Disponible" ${account.status === 'Disponible' ? 'selected' : ''}>Disponible</option>
                            <option value="Ocupado" ${account.status === 'Ocupado' ? 'selected' : ''}>Ocupado</option>
                            <option value="No disponible" ${account.status === 'No disponible' ? 'selected' : ''}>No disponible</option>
                            <option value="Renovar" ${account.status === 'Renovar' ? 'selected' : ''}>Renovar</option>
                        </select>
                        <!-- END CHANGE -->
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="editAccount('${account.id}')" title="Editar" aria-label="Editar cuenta ${escapeHTML(account.platform)} ${escapeHTML(account.email)}" tabindex="0"><i class="fas fa-edit" aria-hidden="true"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAccount('${account.id}')" title="Eliminar" aria-label="Eliminar cuenta ${escapeHTML(account.platform)} ${escapeHTML(account.email)}" tabindex="0"><i class="fas fa-trash" aria-hidden="true"></i></button>
                        <button class="btn btn-secondary btn-sm" onclick="viewAccountDetails('${account.id}')" title="Ver Detalles" aria-label="Ver detalles de cuenta ${escapeHTML(account.platform)} ${escapeHTML(account.email)}" tabindex="0"><i class="fas fa-eye" aria-hidden="true"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // CHANGE: Function to update account status
        async function updateAccountStatus(accountId, newStatus) {
            const accountIndex = accounts.findIndex(acc => acc.id === accountId);
            if (accountIndex === -1) {
                modal.toast('Cuenta no encontrada.', 'error');
                return;
            }

            const oldStatus = accounts[accountIndex].status;
            accounts[accountIndex].status = newStatus;

            try {
                await saveToFirebase('accounts', accounts[accountIndex]);
                saveData(); // Update localStorage
                renderAccounts(); // Re-render to reflect changes
                modal.toast(`Estado de cuenta actualizado a "${newStatus}"`, 'success');
            } catch (error) {
                console.error('Error updating account status:', error);
                accounts[accountIndex].status = oldStatus; // Revert local change on error
                renderAccounts(); // Re-render to revert UI
                modal.toast(`Error al actualizar el estado: ${error.message}`, 'error');
            }
        }
        // END CHANGE

        function renderClients() {
            const tbody = document.querySelector('#clientsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            clients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHTML(client.name)}</td>
                    <td>${escapeHTML(client.whatsApp)}</td>
                    <td>${escapeHTML(client.email || 'No especificado')}</td>
                    <td>${client.purchases}</td>
                    <td>${client.lastPurchase ? new Date(client.lastPurchase).toLocaleDateString() : 'Nunca'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editClient('${client.id}')" title="Editar" aria-label="Editar cliente ${escapeHTML(client.name)}" tabindex="0"><i class="fas fa-edit" aria-hidden="true"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient('${client.id}')" title="Eliminar" aria-label="Eliminar cliente ${escapeHTML(client.name)}" tabindex="0"><i class="fas fa-trash" aria-hidden="true"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSales() {
            const tbody = document.querySelector('#salesTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            sales.forEach(sale => {
                const client = clients.find(c => c.id === sale.clientId);
                const account = accounts.find(a => a.id === sale.accountId);
                
                // CHANGE: Determine payment status
                const today = new Date();
                const endDate = new Date(sale.endDate);
                let paymentStatus = 'pending';
                let paymentStatusText = 'Pendiente';
                let paymentStatusIcon = 'fas fa-hourglass-half';

                if (sale.paid) {
                    paymentStatus = 'paid';
                    paymentStatusText = 'Pagado';
                    paymentStatusIcon = 'fas fa-check-circle';
                } else if (today > endDate) {
                    paymentStatus = 'overdue';
                    paymentStatusText = 'Atrasado';
                    paymentStatusIcon = 'fas fa-exclamation-circle';
                }
                // END CHANGE

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHTML(client ? client.name : 'Cliente eliminado')}</td>
                    <td>${escapeHTML(account ? account.platform : 'Cuenta eliminada')}</td>
                    <td>${sale.profilesCount}</td>
                    <td>${new Date(sale.startDate).toLocaleDateString()}</td>
                    <td>${new Date(sale.endDate).toLocaleDateString()}</td>
                    <td>$${(sale.total || 0).toFixed(2)}</td>
                    <td><span class="status-badge ${sale.status === 'Activa' ? 'active' : 'unavailable'}">${escapeHTML(sale.status)}</span></td>
                    <!-- CHANGE: Display payment status -->
                    <td>
                        <span class="status-badge ${paymentStatus}">
                            <i class="${paymentStatusIcon}" aria-hidden="true"></i> ${paymentStatusText}
                        </span>
                    </td>
                    <!-- END CHANGE -->
                    <td>
                        <button class="btn btn-info btn-sm" onclick="generateWhatsAppFromSale('${sale.id}')" title="Generar WhatsApp" aria-label="Generar mensaje de WhatsApp para venta ${sale.id}" tabindex="0"><i class="fab fa-whatsapp" aria-hidden="true"></i></button>
                        <!-- CHANGE: Button to toggle payment status -->
                        <button class="btn btn-secondary btn-sm" onclick="toggleSalePaymentStatus('${sale.id}', ${sale.paid})" title="${sale.paid ? 'Marcar como Pendiente' : 'Marcar como Pagado'}" aria-label="${sale.paid ? 'Marcar venta como Pendiente' : 'Marcar venta como Pagado'}" tabindex="0">
                            <i class="fas ${sale.paid ? 'fa-undo' : 'fa-dollar-sign'}" aria-hidden="true"></i>
                        </button>
                        <!-- END CHANGE -->
                        <button class="btn btn-danger btn-sm" onclick="deleteSale('${sale.id}')" title="Eliminar" aria-label="Eliminar venta ${sale.id}" tabindex="0"><i class="fas fa-trash" aria-hidden="true"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // CHANGE: Function to toggle sale payment status
        async function toggleSalePaymentStatus(saleId, currentPaidStatus) {
            const saleIndex = sales.findIndex(s => s.id === saleId);
            if (saleIndex === -1) {
                modal.toast('Venta no encontrada.', 'error');
                return;
            }

            const newPaidStatus = !currentPaidStatus;
            const oldSale = { ...sales[saleIndex] }; // Create a copy to revert on error
            sales[saleIndex].paid = newPaidStatus;

            try {
                await saveToFirebase('sales', sales[saleIndex]);
                saveData(); // Update localStorage
                renderSales(); // Re-render to reflect changes
                modal.toast(`Estado de pago de venta actualizado a "${newPaidStatus ? 'Pagado' : 'Pendiente'}"`, 'success');
            } catch (error) {
                console.error('Error updating sale payment status:', error);
                sales[saleIndex] = oldSale; // Revert local change on error
                renderSales(); // Re-render to revert UI
                modal.toast(`Error al actualizar el estado de pago: ${error.message}`, 'error');
            }
        }
        // END CHANGE

        function renderAll() {
            renderAccounts();
            renderClients();
            renderSales();
            if (financialManager) {
                financialManager.renderExpensesTable();
                financialManager.renderFinancialAccountsTable();
            }
            updateDashboard();
        }

        // Funciones de modales para Cuentas
        function openAddAccountModal(accountId = null) {
            let account = null;
            if (accountId) {
                account = accounts.find(acc => acc.id === accountId);
                if (!account) {
                    modal.alert('Cuenta no encontrada para editar.', 'Error', 'error');
                    return;
                }
            }

            const modalContent = `
                <div class="modal-header">
                    <h3 id="modal-title">${accountId ? 'Editar Cuenta Existente' : 'Agregar Nueva Cuenta'}</h3>
                    <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="account-form" aria-label="${accountId ? 'Formulario para editar cuenta' : 'Formulario para agregar nueva cuenta'}">
                        <!-- Información básica -->
                        <div class="form-section">
                            <h4><i class="fas fa-info-circle" aria-hidden="true"></i> Información de la Cuenta</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="platform">Plataforma: <span aria-hidden="true">*</span></label>
                                    <select id="platform" name="platform" class="form-control" required onchange="toggleCustomPlatform()" tabindex="0" aria-required="true">
                                        <option value="">Seleccionar plataforma</option>
                                        <option value="Netflix" ${account && account.platform === 'Netflix' ? 'selected' : ''}>Netflix</option>
                                        <option value="HBO Max" ${account && account.platform === 'HBO Max' ? 'selected' : ''}>HBO Max</option>
                                        <option value="Disney+" ${account && account.platform === 'Disney+' ? 'selected' : ''}>Disney+</option>
                                        <option value="Prime Video" ${account && account.platform === 'Prime Video' ? 'selected' : ''}>Prime Video</option>
                                        <option value="Spotify" ${account && account.platform === 'Spotify' ? 'selected' : ''}>Spotify</option>
                                        <option value="YouTube Premium" ${account && account.platform === 'YouTube Premium' ? 'selected' : ''}>YouTube Premium</option>
                                        <option value="Otro" ${account && !['Netflix', 'HBO Max', 'Disney+', 'Prime Video', 'Spotify', 'YouTube Premium'].includes(account.platform) ? 'selected' : ''}>Otro</option>
                                    </select>
                                </div>
                                <div class="form-group" id="custom-platform-group" style="display: ${account && !['Netflix', 'HBO Max', 'Disney+', 'Prime Video', 'Spotify', 'YouTube Premium'].includes(account.platform) ? 'block' : 'none'};">
                                    <label for="customPlatform">Plataforma Personalizada:</label>
                                    <input type="text" id="customPlatform" name="customPlatform" class="form-control" value="${account && !['Netflix', 'HBO Max', 'Disney+', 'Prime Video', 'Spotify', 'YouTube Premium'].includes(account.platform) ? escapeHTML(account.platform) : ''}" tabindex="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email">Usuario/Email: <span aria-hidden="true">*</span></label>
                                    <input type="email" id="email" name="email" class="form-control" required value="${account ? escapeHTML(account.email) : ''}" tabindex="0" aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label for="password">Contraseña: <span aria-hidden="true">*</span></label>
                                    <input id="password" name="password" class="form-control" required value="${account ? escapeHTML(account.password) : ''}" tabindex="0" aria-required="true">
                                </div>
                            </div>
                        </div>

                        <!-- Sección Financiera -->
                        <div class="form-section">
                            <h4><i class="fas fa-dollar-sign" aria-hidden="true"></i> Información Financiera</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="acquisitionCost">Costo de Adquisición: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="acquisitionCost" name="acquisitionCost" class="form-control" step="0.01" min="0" placeholder="0.00" required value="${account ? (account.acquisitionCost || 0).toFixed(2) : ''}" onchange="calculateProfitMargin()" tabindex="0" aria-required="true">
                                    <small class="form-text">Costo inicial de compra de la cuenta.</small>
                                </div>
                                <div class="form-group">
                                    <label for="supplier">Proveedor:</label>
                                    <input type="text" id="supplier" name="supplier" class="form-control" placeholder="Nombre del vendedor" value="${account ? escapeHTML(account.supplier || '') : ''}" tabindex="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="renewalCost">Costo de Renovación Mensual:</label>
                                    <input type="number" id="renewalCost" name="renewalCost" class="form-control" step="0.01" min="0" placeholder="0.00" value="${account ? (account.renewalCost || 0).toFixed(2) : ''}" tabindex="0">
                                    <small class="form-text">Solo si pagas renovaciones mensuales.</small>
                                </div>
                                <div class="form-group">
                                    <label for="renewalDate">Próxima Renovación:</label>
                                    <input type="date" id="renewalDate" name="renewalDate" class="form-control" value="${account ? (account.renewalDate || '') : ''}" tabindex="0">
                                </div>
                            </div>
                        </div>

                        <!-- Precios de venta -->
                        <div class="form-section">
                            <h4><i class="fas fa-tags" aria-hidden="true"></i> Precios de Venta</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pricePerProfile">Precio por Perfil: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="pricePerProfile" name="pricePerProfile" class="form-control" step="0.01" min="0" required value="${account ? (account.pricePerProfile || 0).toFixed(2) : ''}" onchange="calculateProfitMargin()" tabindex="0" aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label for="fullAccountPrice">Precio Cuenta Completa: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="fullAccountPrice" name="fullAccountPrice" class="form-control" step="0.01" min="0" required value="${account ? (account.fullAccountPrice || 0).toFixed(2) : ''}" onchange="calculateProfitMargin()" tabindex="0" aria-required="true">
                                </div>
                            </div>
                            
                            <!-- Indicador de rentabilidad en tiempo real -->
                            <div class="profit-indicator" id="profitIndicator" style="display: none;" role="status" aria-live="polite">
                                <strong>Análisis de Rentabilidad:</strong>
                                <div id="profitAnalysis"></div>
                            </div>
                        </div>

                        <!-- Perfiles -->
                        <div class="form-section">
                            <h4><i class="fas fa-user-friends" aria-hidden="true"></i> Configuración de Perfiles</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="devices">Número de Perfiles: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="devices" name="devices" class="form-control" min="1" max="10" required value="${account ? (account.devices || 1) : 1}" onchange="updateProfilesSection(); calculateProfitMargin();" tabindex="0" aria-required="true">
                                </div>
                            </div>
                            
                            <div id="profiles-container" role="group" aria-label="Perfiles de la cuenta">
                                <!-- Los perfiles se cargarán aquí por updateProfilesSection() -->
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addProfile()" tabindex="0">
                                <i class="fas fa-plus" aria-hidden="true"></i> Agregar Perfil
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="modal.close()" tabindex="0">Cancelar</button>
                    <button class="btn btn-success" onclick="saveAccount('${accountId || ''}')" tabindex="0">
                        <i class="fas fa-save" aria-hidden="true"></i> ${accountId ? 'Guardar Cambios' : 'Guardar Cuenta'}
                    </button>
                </div>
            `;

            modal.open(modalContent, { size: 'large' });

            // Llama a las funciones para poblar las partes dinámicas después de que el modal esté abierto
            setTimeout(() => {
                updateProfilesSection(account ? account.profiles : null);
                toggleCustomPlatform(); // Para mostrar/ocultar el campo de plataforma personalizada
                calculateProfitMargin(); // Para mostrar el análisis de ganancias inicial
            }, 100);
        }

        function toggleCustomPlatform() {
            const platformSelect = document.getElementById('platform');
            const customGroup = document.getElementById('custom-platform-group');
            const customInput = document.getElementById('customPlatform');
            
            if (platformSelect && customGroup && customInput) {
                if (platformSelect.value === 'Otro') {
                    customGroup.style.display = 'block';
                    customInput.required = true;
                    customInput.setAttribute('aria-required', 'true');
                } else {
                    customGroup.style.display = 'none';
                    customInput.required = false;
                    customInput.removeAttribute('aria-required');
                    customInput.value = ''; // Limpia la plataforma personalizada si no es 'Otro'
                }
            }
        }

        function calculateProfitMargin() {
            const acquisitionCostInput = document.getElementById('acquisitionCost');
            const pricePerProfileInput = document.getElementById('pricePerProfile');
            const devicesInput = document.getElementById('devices');
            
            if (!acquisitionCostInput || !pricePerProfileInput || !devicesInput) return;
            
            const acquisitionCost = parseFloat(acquisitionCostInput.value) || 0;
            const pricePerProfile = parseFloat(pricePerProfileInput.value) || 0;
            const devices = parseInt(devicesInput.value) || 1;
            
            if (acquisitionCost > 0 || pricePerProfile > 0) { // Muestra el análisis si hay algún valor relevante
                const maxRevenue = pricePerProfile * devices;
                const profit = maxRevenue - acquisitionCost;
                const margin = maxRevenue > 0 ? ((profit / maxRevenue) * 100).toFixed(1) : 0;
                const roi = acquisitionCost > 0 ? ((profit / acquisitionCost) * 100).toFixed(1) : 0;
                
                let analysis = `
                    <div class="profit-breakdown">
                        <div class="metric">
                            <span class="label">Inversión inicial:</span>
                            <span class="value">$${acquisitionCost.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">Ingresos máximos potenciales:</span>
                            <span class="value">$${maxRevenue.toFixed(2)}</span>
                        </div>
                        <div class="metric ${profit >= 0 ? 'profit' : 'loss'}">
                            <span class="label">Ganancia estimada:</span>
                            <span class="value">$${profit.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">Margen de ganancia:</span>
                            <span class="value ${margin >= 0 ? 'positive' : 'negative'}">${margin}%</span>
                        </div>
                        <div class="metric">
                            <span class="label">ROI:</span>
                            <span class="value ${roi >= 0 ? 'positive' : 'negative'}">${roi}%</span>
                        </div>
                    </div>
                `;
                
                const profitAnalysis = document.getElementById('profitAnalysis');
                const profitIndicator = document.getElementById('profitIndicator');
                
                if (profitAnalysis && profitIndicator) {
                    profitAnalysis.innerHTML = analysis;
                    profitIndicator.style.display = 'block';
                }
            } else {
                document.getElementById('profitIndicator').style.display = 'none';
            }
        }

        function updateProfilesSection(existingProfiles = null) {
            const deviceCount = parseInt(document.getElementById('devices').value) || 1;
            const container = document.getElementById('profiles-container');
            
            container.innerHTML = ''; // Limpia el contenedor
            
            for (let i = 0; i < deviceCount; i++) {
                const profile = existingProfiles && existingProfiles[i] ? existingProfiles[i] : { name: `Perfil ${i + 1}`, pin: 'Sin pin', available: true };
                
                const profileDiv = document.createElement('div');
                profileDiv.className = 'profile-item';
                profileDiv.innerHTML = `
                    <div class="profile-fields">
                        <input type="text" class="form-control profile-name" placeholder="Nombre del perfil" value="${escapeHTML(profile.name)}" aria-label="Nombre del perfil ${i + 1}" tabindex="0">
                        <input type="text" class="form-control profile-pin" placeholder="PIN (opcional)" value="${escapeHTML(profile.pin)}" aria-label="PIN del perfil ${i + 1}" tabindex="0">
                        <button type="button" class="btn btn-danger btn-sm remove-profile" onclick="removeProfile(this)" ${i === 0 && deviceCount === 1 ? 'style="display: none;"' : ''} aria-label="Eliminar perfil" tabindex="0">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                    </div>
                `;
                container.appendChild(profileDiv);
            }
        }

        function addProfile() {
            const container = document.getElementById('profiles-container');
            const profileCount = container.children.length + 1;
            
            const profileDiv = document.createElement('div');
            profileDiv.className = 'profile-item';
            profileDiv.innerHTML = `
                <div class="profile-fields">
                    <input type="text" class="form-control profile-name" placeholder="Nombre del perfil" value="Perfil ${profileCount}" aria-label="Nombre del perfil ${profileCount}" tabindex="0">
                    <input type="text" class="form-control profile-pin" placeholder="PIN (opcional)" value="Sin pin" aria-label="PIN del perfil ${profileCount}" tabindex="0">
                    <button type="button" class="btn btn-danger btn-sm remove-profile" onclick="removeProfile(this)" aria-label="Eliminar perfil" tabindex="0">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                    </button>
                </div>
            `;
            container.appendChild(profileDiv);
            
            // Actualiza el campo de entrada de dispositivos
            document.getElementById('devices').value = container.children.length;
            calculateProfitMargin(); // Recalcula el margen de ganancia con el nuevo recuento de perfiles
        }

        function removeProfile(button) {
            const container = document.getElementById('profiles-container');
            if (container.children.length > 1) {
                button.closest('.profile-item').remove();
                
                // Actualiza los nombres de los perfiles y el campo de dispositivos
                const profiles = container.querySelectorAll('.profile-item');
                profiles.forEach((profile, index) => {
                    const nameInput = profile.querySelector('.profile-name');
                    if (nameInput.value.startsWith('Perfil ')) {
                        nameInput.value = `Perfil ${index + 1}`;
                    }
                });
                
                document.getElementById('devices').value = profiles.length;
                calculateProfitMargin(); // Recalcula el margen de ganancia con el nuevo recuento de perfiles
            }
        }

        async function saveAccount(accountId) {
            const form = document.getElementById('account-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const formData = new FormData(form);
            
            // Validaciones y sanitización básica
            const platform = sanitizeInput(formData.get('platform'));
            const customPlatform = sanitizeInput(formData.get('customPlatform'));
            const email = sanitizeInput(formData.get('email'));
            const password = sanitizeInput(formData.get('password'));
            const devices = parseInt(formData.get('devices'));
            const pricePerProfile = parseFloat(formData.get('pricePerProfile'));
            const fullAccountPrice = parseFloat(formData.get('fullAccountPrice'));
            const acquisitionCost = parseFloat(formData.get('acquisitionCost'));
            const renewalCost = parseFloat(formData.get('renewalCost'));
            const supplier = sanitizeInput(formData.get('supplier') || '');
            const renewalDate = formData.get('renewalDate') || null;
            
            if (platform === 'Otro' && !customPlatform) {
                modal.alert('Por favor especifica el nombre de la plataforma personalizada.', 'Plataforma Personalizada', 'warning');
                return;
            }
            
            // Recopilar perfiles
            const profiles = [];
            const profileItems = document.querySelectorAll('.profile-item');
            profileItems.forEach(item => {
                const nameInput = item.querySelector('.profile-name');
                const pinInput = item.querySelector('.profile-pin');
                if (nameInput && pinInput) {
                    const name = sanitizeInput(nameInput.value) || 'Sin nombre';
                    const pin = sanitizeInput(pinInput.value) || 'Sin pin';
                    profiles.push({
                        name: name,
                        pin: pin,
                        available: true // Los nuevos perfiles están disponibles por defecto
                    });
                }
            });

            let accountToSave;

            if (accountId) {
                // Editando cuenta existente
                accountToSave = accounts.find(acc => acc.id === accountId);
                if (!accountToSave) {
                    modal.alert('Error: Cuenta no encontrada para actualizar.', 'Error', 'error');
                    return;
                }
                // Actualizar propiedades existentes
                Object.assign(accountToSave, {
                    platform: platform === 'Otro' ? customPlatform : platform,
                    email: email,
                    password: password,
                    devices: devices,
                    pricePerProfile: pricePerProfile,
                    fullAccountPrice: fullAccountPrice,
                    acquisitionCost: acquisitionCost,
                    supplier: supplier,
                    renewalCost: renewalCost,
                    renewalDate: renewalDate,
                });

                // Actualizar perfiles: preservar el estado de venta para los perfiles existentes
                const existingProfilesMap = new Map(accountToSave.profiles.map(p => [p.name, p]));
                accountToSave.profiles = profiles.map(newProfile => {
                    const existing = existingProfilesMap.get(newProfile.name);
                    if (existing) {
                        // Si el perfil ya existe, actualiza el PIN y el nombre, pero mantiene el estado de disponibilidad y venta
                        return { 
                            ...existing, 
                            name: newProfile.name, // Permite actualizar el nombre del perfil
                            pin: newProfile.pin 
                        }; 
                    }
                    return newProfile; // Nuevo perfil
                });

            } else {
                // Creando nueva cuenta
                accountToSave = {
                    id: Date.now().toString(),
                    platform: platform === 'Otro' ? customPlatform : platform,
                    email: email,
                    password: password,
                    devices: devices,
                    pricePerProfile: pricePerProfile,
                    fullAccountPrice: fullAccountPrice,
                    profiles: profiles,
                    status: 'Disponible', // Las nuevas cuentas están disponibles
                    createdAt: new Date().toISOString(),
                    
                    acquisitionCost: acquisitionCost,
                    supplier: supplier,
                    renewalCost: renewalCost,
                    renewalDate: renewalDate,
                    totalEarned: 0 // Las nuevas cuentas comienzan con 0 ganancias
                };
                accounts.push(accountToSave);
            }
            
            try {
                await saveToFirebase('accounts', accountToSave);
                saveData(); // Guarda en localStorage después del éxito de Firebase
                renderAll();
                financialManager.updateFinancialDashboard();
                modal.close();
                modal.toast(`Cuenta ${accountId ? 'actualizada' : 'agregada'} correctamente.`, 'success'); // CHANGE: Use toast
            } catch (error) {
                console.error('Error saving account:', error);
                modal.toast(`Error al guardar la cuenta: ${error.message}`, 'error'); // CHANGE: Use toast
            }
        }

        function editAccount(id) {
            openAddAccountModal(id);
        }

        async function deleteAccount(id) {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar esta cuenta? Esto también eliminará las ventas asociadas.', 'Confirmar Eliminación');
            if (confirmed) {
                try {
                    // Eliminar ventas asociadas primero
                    const salesToDelete = sales.filter(s => s.accountId === id);
                    const deleteSalesPromises = salesToDelete.map(s => deleteFromFirebase('sales', s.id));

                    await Promise.all(deleteSalesPromises);
                    sales = sales.filter(s => s.accountId !== id); // Actualiza el array de ventas local

                    // Luego elimina la cuenta
                    accounts = accounts.filter(acc => acc.id !== id);

                    await deleteFromFirebase('accounts', id);
                    saveData(); // Guarda los cambios en localStorage
                    renderAll();
                    financialManager.updateFinancialDashboard();
                    modal.toast('✅ Cuenta y ventas asociadas eliminadas correctamente.', 'success'); // CHANGE: Use toast
                } catch (error) {
                    console.error('Error deleting account or associated sales:', error);
                    modal.toast(`Error al eliminar la cuenta: ${error.message}`, 'error'); // CHANGE: Use toast
                }
            }
        }

        // Funciones de modales para Clientes
        function openAddClientModal(clientId = null) {
            let client = null;
            if (clientId) {
                client = clients.find(c => c.id === clientId);
                if (!client) {
                    modal.alert('Cliente no encontrado para editar.', 'Error', 'error');
                    return;
                }
            }

            const formConfig = {
                fields: [
                    { type: 'text', name: 'name', label: 'Nombre Completo', required: true, value: client ? client.name : '' },
                    { type: 'text', name: 'whatsApp', label: 'WhatsApp', required: true, placeholder: '+593 99 123 4567', value: client ? client.whatsApp : '' },
                    { type: 'email', name: 'email', label: 'Email (opcional)', value: client ? client.email : '' },
                    { type: 'textarea', name: 'notes', label: 'Notas', placeholder: 'Información adicional del cliente...', value: client ? client.notes : '' }
                ]
            };

            modal.form(formConfig, `${clientId ? 'Editar Cliente' : 'Agregar Nuevo Cliente'}`).then(async data => {
                if (data) {
                    // Sanitización básica
                    const name = sanitizeInput(data.name);
                    const whatsApp = sanitizeInput(data.whatsApp);
                    const email = sanitizeInput(data.email || '');
                    const notes = sanitizeInput(data.notes || '');

                    let clientToSave;
                    if (clientId) {
                        clientToSave = clients.find(c => c.id === clientId);
                        Object.assign(clientToSave, {
                            name: name,
                            whatsApp: whatsApp,
                            email: email,
                            notes: notes
                        });
                    } else {
                        clientToSave = {
                            id: Date.now().toString(),
                            name: name,
                            whatsApp: whatsApp,
                            email: email,
                            notes: notes,
                            purchases: 0,
                            lastPurchase: null,
                            createdAt: new Date().toISOString()
                        };
                        clients.push(clientToSave);
                    }

                    try {
                        await saveToFirebase('clients', clientToSave);
                        saveData();
                        renderAll();
                        modal.toast(`Cliente ${clientId ? 'actualizado' : 'agregado'} correctamente.`, 'success'); // CHANGE: Use toast
                    } catch (error) {
                        console.error('Error saving client:', error);
                        modal.toast(`Error al guardar el cliente: ${error.message}`, 'error'); // CHANGE: Use toast
                    }
                }
            });
        }

        function editClient(id) {
            openAddClientModal(id);
        }

        async function deleteClient(id) {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar este cliente? Esto no eliminará las ventas asociadas, pero el cliente aparecerá como "eliminado".', 'Confirmar Eliminación');
            if (confirmed) {
                try {
                    clients = clients.filter(c => c.id !== id); // Eliminar del array local

                    await deleteFromFirebase('clients', id);
                    saveData(); // Guarda los cambios en localStorage
                    renderAll();
                    modal.toast('✅ Cliente eliminado correctamente.', 'success'); // CHANGE: Use toast
                } catch (error) {
                    console.error('Error deleting client:', error);
                    modal.toast(`Error al eliminar el cliente: ${error.message}`, 'error'); // CHANGE: Use toast
                }
            }
        }

        // Funciones de modales para Ventas
        function openSaleModal(saleId = null) {
            // FIX: Cierra cualquier modal de venta existente antes de abrir uno nuevo
            // Esto asegura que siempre se abra un formulario limpio y único.
            if (activeModalInstance) {
                activeModalInstance.close();
            }

            let sale = null;
            if (saleId) {
                sale = sales.find(s => s.id === saleId);
                if (!sale) {
                    modal.alert('Venta no encontrada para editar.', 'Error', 'error');
                    return;
                }
            }

            if (accounts.length === 0) {
                modal.alert('Primero debes agregar al menos una cuenta.', 'Sin Cuentas', 'warning');
                return;
            }

            if (clients.length === 0) {
                modal.alert('Primero debes agregar al menos un cliente.', 'Sin Clientes', 'warning');
                return;
            }

            const clientOptions = clients.map(c => ({ value: c.id, text: c.name }));
            const accountOptions = accounts.map(a => ({ 
                value: a.id, 
                text: `${a.platform} - ${a.email}` 
            }));

            const today = new Date();
            const endDateDefault = new Date();
            endDateDefault.setDate(today.getDate() + 30);

            const formConfig = {
                fields: [
                    { 
                        type: 'select', 
                        name: 'clientId', 
                        label: 'Cliente', 
                        required: true, 
                        options: [{ value: '', text: 'Seleccionar cliente...' }, ...clientOptions],
                        value: sale ? sale.clientId : ''
                    },
                    { 
                        type: 'select', 
                        name: 'accountId', 
                        label: 'Cuenta', 
                        required: true, 
                        options: [{ value: '', text: 'Seleccionar cuenta...' }, ...accountOptions],
                        value: sale ? sale.accountId : ''
                    },
                    { type: 'number', name: 'profilesCount', label: 'Número de Perfiles', required: true, placeholder: '1', value: sale ? sale.profilesCount : '1', min: '1' },
                    { 
                        type: 'date',
                        name: 'startDate', 
                        label: 'Fecha de Inicio', 
                        required: true, 
                        value: sale ? sale.startDate : today.toISOString().split('T')[0] 
                    },
                    { 
                        type: 'date',
                        name: 'endDate', 
                        label: 'Fecha de Fin', 
                        required: true, 
                        value: sale ? sale.endDate : endDateDefault.toISOString().split('T')[0] 
                    },
                    { type: 'number', name: 'total', label: 'Total ($)', required: true, placeholder: '0.00', value: sale ? (sale.total || 0).toFixed(2) : '', step: '0.01', min: '0' },
                    {
                        type: 'select',
                        name: 'status',
                        label: 'Estado',
                        required: true,
                        options: [
                            { value: 'Activa', text: 'Activa' },
                            { value: 'Inactiva', text: 'Inactiva' },
                            { value: 'Pendiente', text: 'Pendiente' }
                        ],
                        value: sale ? sale.status : 'Activa'
                    },
                    {
                        type: 'select',
                        name: 'paid',
                        label: 'Pagado',
                        required: true,
                        options: [
                            { value: 'true', text: 'Sí' },
                            { value: 'false', text: 'No' }
                        ],
                        value: sale ? sale.paid.toString() : 'false'
                    }
                ]
            };

            modal.form(formConfig, `${saleId ? 'Editar Venta' : 'Nueva Venta'}`).then(async data => {
                if (data) {
                    // 1. Validación de campos obligatorios
                    if (!data.clientId || !data.accountId || !data.profilesCount || !data.startDate || !data.endDate || !data.total || !data.status || !data.paid) {
                        modal.alert('Por favor, completa todos los campos obligatorios.', 'Campos Incompletos', 'warning');
                        return;
                    }

                    const newSaleData = {
                        clientId: data.clientId,
                        accountId: data.accountId,
                        profilesCount: parseInt(data.profilesCount),
                        startDate: data.startDate,
                        endDate: data.endDate,
                        total: parseFloat(data.total),
                        status: sanitizeInput(data.status),
                        paid: data.paid === 'true',
                    };

                    let saleToSave;
                    let oldAccount = null; // Para revertir cambios si se edita una venta
                    if (saleId) {
                        // Editando venta existente
                        saleToSave = sales.find(s => s.id === saleId);
                        if (!saleToSave) {
                            modal.alert('Error: Venta no encontrada para actualizar.', 'Error', 'error');
                            return;
                        }
                        // Revertir el totalEarned de la cuenta antigua y el estado del perfil si la cuenta cambió o los perfiles cambiaron
                        oldAccount = accounts.find(acc => acc.id === saleToSave.accountId);
                        if (oldAccount) {
                            oldAccount.totalEarned = (oldAccount.totalEarned || 0) - saleToSave.total;
                            oldAccount.profiles.forEach(p => {
                                if (p.saleId === saleToSave.id) {
                                    p.available = true;
                                    delete p.soldTo;
                                    delete p.saleId;
                                }
                            });
                        }
                        Object.assign(saleToSave, newSaleData);
                    } else {
                        // Creando nueva venta
                        saleToSave = {
                            id: Date.now().toString(),
                            ...newSaleData,
                            createdAt: new Date().toISOString()
                        };
                        sales.push(saleToSave);
                    }

                    const account = accounts.find(acc => acc.id === saleToSave.accountId);
                    if (account) {
                        // Actualizar totalEarned de la cuenta
                        account.totalEarned = (account.totalEarned || 0) + saleToSave.total;

                        // Marcar perfiles como ocupados para la venta nueva/actualizada
                        const availableProfiles = account.profiles.filter(p => p.available || p.saleId === saleToSave.id); // Incluye perfiles de esta venta si se está editando
                        let profilesAssigned = 0;
                        for (let i = 0; i < availableProfiles.length && profilesAssigned < saleToSave.profilesCount; i++) {
                            if (availableProfiles[i].available || availableProfiles[i].saleId === saleToSave.id) {
                                availableProfiles[i].available = false;
                                availableProfiles[i].soldTo = saleToSave.clientId;
                                availableProfiles[i].saleId = saleToSave.id;
                                profilesAssigned++;
                            }
                        }
                        // Si no hay suficientes perfiles, establece el estado de la cuenta como no disponible
                        if (profilesAssigned < saleToSave.profilesCount) {
                            modal.alert('No hay suficientes perfiles disponibles en esta cuenta para la cantidad solicitada. Se asignaron los perfiles disponibles.', 'Advertencia', 'warning');
                        }
                        // Actualiza el estado de la cuenta según la disponibilidad del perfil
                        account.status = account.profiles.some(p => p.available) ? 'Disponible' : 'Ocupado';

                        const client = clients.find(c => c.id === saleToSave.clientId);
                        if (client) {
                            if (!saleId) { // Solo incrementa las compras para nuevas ventas
                                client.purchases += 1;
                            }
                            client.lastPurchase = saleToSave.startDate;
                        }

                        // Guarda la venta y actualiza cuentas y clientes en Firebase y localStorage
                        try {
                            const savePromises = [
                                saveToFirebase('sales', saleToSave),
                                saveToFirebase('accounts', account), // Guarda la cuenta actualizada
                                saveToFirebase('clients', client)    // Guarda el cliente actualizado
                            ];
                            if (oldAccount && oldAccount.id !== account.id) { // Si la cuenta cambió en la edición
                                savePromises.push(saveToFirebase('accounts', oldAccount));
                            }
                            await Promise.all(savePromises);

                            saveData(); // Guarda en localStorage después del éxito de Firebase
                            renderAll();
                            financialManager.updateFinancialDashboard();
                            modal.close(); // Cierra el modal después de guardar
                            modal.toast(`Venta ${saleId ? 'actualizada' : 'completada'} correctamente.`, 'success'); // Muestra mensaje de éxito
                            if (!saleId) { // Solo genera el mensaje de WhatsApp para nuevas ventas
                                generateWhatsAppFromSale(saleToSave.id);
                            }
                        } catch (error) {
                            console.error('Error al completar/actualizar la venta y guardar datos:', error);
                            modal.toast(`Error al completar/actualizar la venta: ${error.message}`, 'error'); // Muestra mensaje de error
                        }
                    } else {
                        modal.alert('❌ Cuenta no encontrada. No se puede completar la venta.', 'Error', 'error');
                    }
                }
            });
        }

        async function deleteSale(id) {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar esta venta? Esto liberará los perfiles asociados y ajustará las ganancias de la cuenta.', 'Confirmar Eliminación');
            if (confirmed) {
                try {
                    const saleToDelete = sales.find(s => s.id === id);
                    if (!saleToDelete) {
                        modal.alert('Venta no encontrada.', 'Error', 'error');
                        return;
                    }

                    // Revertir cambios en la cuenta y el cliente
                    const account = accounts.find(acc => acc.id === saleToDelete.accountId);
                    if (account) {
                        account.totalEarned = (account.totalEarned || 0) - saleToDelete.total;
                        account.profiles.forEach(p => {
                            if (p.saleId === saleToDelete.id) {
                                p.available = true;
                                delete p.soldTo;
                                delete p.saleId;
                            }
                        });
                        account.status = account.profiles.some(p => p.available) ? 'Disponible' : 'Ocupado';
                        await saveToFirebase('accounts', account);
                    }

                    const client = clients.find(c => c.id === saleToDelete.clientId);
                    if (client) {
                        client.purchases = Math.max(0, client.purchases - 1); // Decrementar compras
                        // Reevaluar lastPurchase si esta fue la última
                        const remainingSalesForClient = sales.filter(s => s.clientId === client.id && s.id !== saleToDelete.id);
                        if (remainingSalesForClient.length > 0) {
                            client.lastPurchase = remainingSalesForClient.sort((a, b) => new Date(b.startDate) - new Date(a.startDate))[0].startDate;
                        } else {
                            client.lastPurchase = null;
                        }
                        await saveToFirebase('clients', client);
                    }

                    sales = sales.filter(s => s.id !== id); // Eliminar del array local

                    await deleteFromFirebase('sales', id);
                    saveData(); // Guarda los cambios en localStorage
                    renderAll();
                    financialManager.updateFinancialDashboard();
                    modal.toast('✅ Venta eliminada correctamente.', 'success'); // CHANGE: Use toast
                } catch (error) {
                    console.error('Error deleting sale:', error);
                    modal.toast(`Error al eliminar la venta: ${error.message}`, 'error'); // CHANGE: Use toast
                }
            }
        }

        // Funciones de visualización de detalles
        function viewAccountDetails(id) {
            const account = accounts.find(acc => acc.id === id);
            if (!account) return;

            let details = `
                <div class="modal-header">
                    <h3 id="modal-title"><i class="fas fa-tv" aria-hidden="true"></i> Detalles de la Cuenta</h3>
                    <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-section">
                        <h4>Información General</h4>
                        <p><strong>Plataforma:</strong> ${escapeHTML(account.platform)}</p>
                        <p><strong>Usuario:</strong> ${escapeHTML(account.email)}</p>
                        <p><strong>Contraseña:</strong> ${escapeHTML(account.password)}</p>
                        <p><strong>Dispositivos:</strong> ${account.devices}</p>
                        <p><strong>Estado:</strong> <span class="status-badge ${account.status === 'Disponible' ? 'available' : 'unavailable'}">${escapeHTML(account.status)}</span></p>
                    </div>
                    <div class="form-section">
                        <h4>Precios</h4>
                        <p><strong>Precio por Perfil:</strong> $${(account.pricePerProfile || 0).toFixed(2)}</p>
                        <p><strong>Precio Cuenta Completa:</strong> $${(account.fullAccountPrice || 0).toFixed(2)}</p>
                    </div>
                    <div class="form-section">
                        <h4>Información Financiera</h4>
                        <p><strong>Costo de Adquisición:</strong> $${(account.acquisitionCost || 0).toFixed(2)}</p>
                        <p><strong>Proveedor:</strong> ${escapeHTML(account.supplier || 'N/A')}</p>
                        <p><strong>Costo de Renovación:</strong> $${(account.renewalCost || 0).toFixed(2)}</p>
                        <p><strong>Próxima Renovación:</strong> ${account.renewalDate ? new Date(account.renewalDate).toLocaleDateString() : 'N/A'}</p>
                        <p><strong>Ganancia Total:</strong> $${(account.totalEarned || 0).toFixed(2)}</p>
                    </div>
                    <div class="form-section">
                        <h4>Perfiles (${account.profiles.length})</h4>
                        ${account.profiles.map((profile, index) => `
                            <p>${index + 1}. <strong>${escapeHTML(profile.name)}</strong> - PIN: ${escapeHTML(profile.pin)} - Estado: <span class="status-badge ${profile.available ? 'available' : 'unavailable'}">${profile.available ? 'Disponible' : 'Ocupado'}</span> ${profile.soldTo ? `(Cliente: ${escapeHTML(clients.find(c => c.id === profile.soldTo)?.name || 'Eliminado')})` : ''}</p>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="modal.close()" tabindex="0">Cerrar</button>
                    <button class="btn" onclick="editAccount('${account.id}')" tabindex="0">Editar Cuenta</button>
                </div>
            `;

            modal.open(details, { size: 'medium' });
        }

        // Función para generar mensaje de WhatsApp
        function generateWhatsAppFromSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                modal.alert('Venta no encontrada para generar mensaje.', 'Error', 'error');
                return;
            }

            const client = clients.find(c => c.id === sale.clientId);
            const account = accounts.find(acc => acc.id === sale.accountId);

            if (!client || !account) {
                modal.alert('Cliente o cuenta asociada a la venta no encontrada.', 'Error', 'error');
                return;
            }

            const assignedProfiles = account.profiles.filter(p => p.saleId === saleId);

            let message = `Hola! 😊 ${client.name},\n\n`;
            message += `Aquí tienes los datos de tu cuenta:\n\n`;
            message += `📲 *PLATAFORMA:* ${account.platform}\n`;
            message += `📧 *Usuario:* ${account.email}\n`;
            message += `🔐 *Contraseña:* ${account.password}\n`;
            message += `🆔 *Perfil${sale.profilesCount > 1 ? 'es' : ''}:* ${assignedProfiles.map(p => p.name).join(', ')}\n`;
            message += `🔑 *PIN:* ${assignedProfiles.map(p => p.pin).join(', ')}\n`;
            message += `📅 *Vigencia:* ${new Date(sale.startDate).toLocaleDateString()} - ${new Date(sale.endDate).toLocaleDateString()}\n\n`;
            message += `¡Que disfrutes tu servicio!`;

            navigator.clipboard.writeText(message).then(() => {
                modal.toast('📱 Mensaje copiado al portapapeles. ¡Listo para enviar por WhatsApp!', 'success'); // CHANGE: Use toast
            }).catch(err => {
                console.error('Error al copiar al portapapeles:', err);
                // Fallback para navegadores antiguos o si la API del portapapeles no está disponible
                const textArea = document.createElement('textarea');
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    modal.toast('📱 Mensaje copiado al portapapeles. ¡Listo para enviar por WhatsApp!', 'success'); // CHANGE: Use toast
                } catch (ex) {
                    modal.alert('No se pudo copiar automáticamente. Por favor, copia el siguiente texto manualmente:\n\n' + message, 'Error al Copiar', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            });
        }

        // Función para probar la conexión a Firebase
        async function testFirebaseConnection() {
            if (isClaudeEnvironment) {
                modal.alert('🎮 Estás en modo demo. Para probar Firebase, sube la aplicación a un servidor web real (GitHub Pages, Netlify, Vercel, etc.) y configura tus reglas de seguridad de Firebase.', 'Modo Demo', 'info');
                return;
            }

            if (!db) {
                modal.alert('❌ Error: Firebase no está inicializado. Revisa la consola para más detalles.', 'Error', 'error');
                return;
            }

            if (!currentUser) {
                modal.alert('❌ No estás autenticado. Por favor, inicia sesión primero.', 'Error', 'error');
                return;
            }

            try {
                // Intenta escribir un documento de prueba
                const testDocRef = db.collection('test').doc('connection-test');
                await testDocRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true,
                    user: currentUser.email,
                    message: 'Conexión exitosa'
                });
                // Intenta leer el documento de prueba
                const doc = await testDocRef.get();
                if (doc.exists) {
                    modal.toast(`✅ ¡Conexión perfecta!\n\n🔍 Autenticado como: ${currentUser.email}\n💾 Base de datos funcionando correctamente.`, 'success'); // CHANGE: Use toast
                } else {
                    modal.toast(`⚠️ Conexión a Firebase exitosa, pero el documento de prueba no se pudo leer. Revisa tus reglas de seguridad de Firestore.`, 'warning'); // CHANGE: Use toast
                }
            } catch (error) {
                console.error('Error de conexión a Firebase:', error);
                modal.toast(`❌ Error de conexión a Firebase: ${error.message}\n\nVerifica tu conexión a internet y las reglas de seguridad de Firestore.`, 'error'); // CHANGE: Use toast
            }
        }

        // Función para añadir estilos dinámicos (ya estaba en el original)
        function addModalStyles() {
            if (document.getElementById('modal-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'modal-styles';
            style.textContent = `
                .summary-stats {
                    display: grid;
                    gap: 8px;
                }
                
                .summary-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 0;
                    border-bottom: 1px solid #e9ecef;
                }
                
                .summary-item:last-child {
                    border-bottom: none;
                }
                
                .summary-item .label {
                    color: #6c757d;
                }
                
                .summary-item .value {
                    font-weight: 600;
                    color: var(--dark-color);
                }
            `;
            
            document.head.appendChild(style);
        }

        // Función para migrar cuentas existentes y asegurar nuevos campos
        function migrateExistingAccounts() {
            let needsSave = false;
            
            accounts.forEach(account => {
                // Asegurar campos financieros
                if (!account.hasOwnProperty('acquisitionCost')) {
                    account.acquisitionCost = 0;
                    needsSave = true;
                }
                if (!account.hasOwnProperty('supplier')) {
                    account.supplier = '';
                    needsSave = true;
                }
                if (!account.hasOwnProperty('renewalCost')) {
                    account.renewalCost = 0;
                    needsSave = true;
                }
                if (!account.hasOwnProperty('renewalDate')) {
                    account.renewalDate = null;
                    needsSave = true;
                }
                if (!account.hasOwnProperty('totalEarned')) {
                    account.totalEarned = 0; // Se recalculará por FinancialManager
                    needsSave = true;
                }
                // Asegurar que los perfiles tengan 'available', 'soldTo', 'saleId'
                if (account.profiles && account.profiles.length > 0) {
                    account.profiles.forEach(profile => {
                        if (!profile.hasOwnProperty('available')) {
                            profile.available = true; // Asume disponible si no se especifica
                            needsSave = true;
                        }
                        if (!profile.hasOwnProperty('soldTo')) {
                            profile.soldTo = null;
                            needsSave = true;
                        }
                        if (!profile.hasOwnProperty('saleId')) {
                            profile.saleId = null;
                            needsSave = true;
                        }
                    });
                }
                // CHANGE: Ensure account status has a default if missing
                if (!account.hasOwnProperty('status')) {
                    account.status = 'Disponible';
                    needsSave = true;
                }
            });
            
            // CHANGE: Ensure sales have 'paid' status
            sales.forEach(sale => {
                if (!sale.hasOwnProperty('paid')) {
                    sale.paid = false; // Default to not paid
                    needsSave = true;
                }
            });
            // END CHANGE

            if (needsSave) {
                saveData(); // Guarda en localStorage
                // Si Firebase está activo, también actualiza en Firebase (considera escrituras por lotes para muchas cuentas)
                if (db && !isClaudeEnvironment && currentUser) {
                    console.log('Migrando cuentas y ventas en Firebase...');
                    const batch = db.batch();
                    accounts.forEach(account => {
                        batch.set(db.collection('accounts').doc(account.id), account, { merge: true });
                    });
                    sales.forEach(sale => { // CHANGE: Add sales to batch migration
                        batch.set(db.collection('sales').doc(sale.id), sale, { merge: true });
                    });
                    batch.commit().then(() => {
                        console.log('Cuentas y ventas migradas en Firebase correctamente.');
                    }).catch(error => {
                        console.error('Error migrando cuentas y ventas en Firebase:', error);
                    });
                }
                console.log('Cuentas y ventas existentes migradas con campos financieros y de perfil.');
            }
        }

        // Función de sanitización básica para prevenir XSS en la visualización
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // Función de sanitización de inputs para datos que se guardan
        function sanitizeInput(input) {
            if (typeof input !== 'string') {
                return input;
            }
            // Elimina etiquetas HTML y caracteres potencialmente peligrosos
            return input.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").trim();
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Inicializando aplicación...');
            
            // Añadir estilos dinámicos
            addModalStyles();

            // CHANGE: Initialize financialManager early
            financialManager = new FinancialManager();
            // END CHANGE

            if (!isClaudeEnvironment) {
                console.log('🔥 Inicializando Firebase...');
                const firebaseInitialized = initializeFirebase(firebaseConfig);
                
                if (firebaseInitialized) {
                    checkAuthState(); // Esto cargará los datos e inicializará financialManager
                } else {
                    console.warn('⚠️ Firebase no se pudo inicializar, usando modo local.');
                    showDemoMode();
                    loadDemoData(); // Cargar datos demo si Firebase falló
                }
            } else {
                console.log('🎮 Modo demo detectado.');
                showDemoMode();
                loadDemoData(); // Cargar datos demo para el entorno Claude
            }
            
            // Login con la tecla Enter
            document.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                    loginUser();
                }
            });
        });
    </script>

    <!-- ==================================================================================================== -->
    <!-- ===================================== DOCUMENTACIÓN Y CHECKLIST ==================================== -->
    <!-- ==================================================================================================== -->
    <!-- README: instrucciones para configurar Firebase y reglas -->
    <pre style="display:none;">
        ### 1. Cómo reemplazar el firebaseConfig por el tuyo:
        ----------------------------------------------------
        1.  **Crea un proyecto en Firebase:** Ve a la consola de Firebase (console.firebase.google.com)
            y crea un nuevo proyecto.
        2.  **Añade una aplicación web:** Dentro de tu proyecto, haz clic en el icono de "Web" (</>)
            para añadir una nueva aplicación web. Sigue los pasos y registra tu aplicación.
        3.  **Copia la configuración:** Firebase te proporcionará un objeto `firebaseConfig` similar a este:
            
