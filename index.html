<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Cuentas Streaming - Tu App</title>
    <meta name="description" content="Sistema de gestión de cuentas de streaming para administrar clientes, ventas, finanzas y cuentas de plataformas como Netflix, HBO Max, etc.">
    <meta name="keywords" content="streaming, cuentas, gestión, clientes, ventas, finanzas, Netflix, HBO Max, Disney+, Spotify, administrador">
    <meta name="author" content="Tu Nombre/Empresa">
    <meta property="og:title" content="Administrador de Cuentas Streaming">
    <meta property="og:description" content="Sistema de gestión de cuentas de streaming para administrar clientes, ventas, finanzas y cuentas de plataformas como Netflix, HBO Max, etc.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tudominio.com">
    <!-- <meta property="og:image" content="https://tudominio.com/imagen-preview.jpg"> -->

    <!-- Firebase Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    
    <!-- Font Awesome para iconos profesionales -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        /* ============= VARIABLES CSS ============= */
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a6fd8;
            --secondary-color: #6c757d;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.6;
            
            --border-radius: 12px;
            --border-radius-lg: 20px;
            --border-radius-xl: 24px;
            
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition-fast: 150ms ease;
            --transition-normal: 200ms ease;
            --transition-slow: 300ms ease;
        }

        /* ============= RESET Y BASE ============= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            color: var(--dark-color);
            background: linear-gradient(135deg, #f0f2f5 0%, #e2e8f0 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* ============= LOGIN SYSTEM ============= */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-card {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }

        .login-header .logo {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: var(--shadow-lg);
        }

        .login-header .logo i {
            color: white;
            font-size: 24px;
        }

        .login-header h1 {
            color: var(--dark-color);
            margin-bottom: 8px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .login-header p {
            color: var(--secondary-color);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: all var(--transition-normal);
            background: white;
            color: var(--dark-color);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

        .btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-full {
            width: 100%;
        }

        .btn-success {
            background: var(--gradient-success);
        }

        .btn-danger {
            background: var(--gradient-danger);
        }

        .btn-warning {
            background: var(--gradient-warning);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 13px;
        }

        .login-error {
            background: var(--gradient-danger);
            color: white;
            padding: 16px;
            border-radius: var(--border-radius);
            margin-top: 16px;
            font-size: 14px;
            white-space: pre-line;
            box-shadow: var(--shadow-md);
        }

        .login-loading {
            text-align: center;
            margin-top: 20px;
            color: var(--secondary-color);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Demo mode styles */
        .demo-alert {
            background: var(--gradient-warning);
            color: white;
            padding: 24px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
        }

        .demo-alert h3 {
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .demo-features {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius-lg);
            color: var(--dark-color);
            box-shadow: var(--shadow-md);
        }

        .demo-features h4 {
            margin-bottom: 16px;
            color: var(--dark-color);
        }

        .demo-features ul {
            list-style: none;
            padding: 0;
        }

        .demo-features li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .demo-features li i {
            color: var(--success-color);
            width: 16px;
        }

        /* ============= MAIN APPLICATION ============= */
        .main-app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            box-shadow: var(--shadow-md);
            padding: var(--spacing-lg) var(--spacing-xl);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-brand .logo {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-brand .logo i {
            color: white;
            font-size: 18px;
        }

        .header-brand h1 {
            color: var(--dark-color);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-email {
            background: var(--light-color);
            color: var(--dark-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tabs {
            background: white;
            box-shadow: var(--shadow-sm);
            padding: 0 var(--spacing-xl);
            overflow-x: auto;
        }

        .nav-tabs-content {
            display: flex;
            gap: 2px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 16px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-color);
            border-bottom: 3px solid transparent;
            transition: all var(--transition-normal);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            color: var(--primary-color);
            background: #f8fafc;
        }

        .nav-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #f8fafc;
        }

        /* Main content */
        .main-content {
            flex: 1;
            padding: var(--spacing-xl);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .section {
            display: none;
            animation: fadeInUp 0.3s ease;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between; /* Changed from 'between' to 'space-between' */
            align-items: center;
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-title {
            color: var(--dark-color);
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 0 var(--border-radius-lg) 0 60px;
            opacity: 0.1;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.success::before {
            background: var(--gradient-success);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.warning::before {
            background: var(--gradient-warning);
        }

        .stat-card.danger {
            border-left-color: var(--danger-color);
        }

        .stat-card.danger::before {
            background: var(--gradient-danger);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            background: var(--gradient-primary);
        }

        .stat-card.success .stat-icon {
            background: var(--gradient-success);
        }

        .stat-card.warning .stat-icon {
            background: var(--gradient-warning);
        }

        .stat-card.danger .stat-icon {
            background: var(--gradient-danger);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--dark-color);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--secondary-color);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Cards and Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-lg);
        }

        .card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all var(--transition-normal);
            border: 1px solid #f1f5f9;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
        }

        .card-header h3 {
            color: var(--dark-color);
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: var(--spacing-xl);
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-top: var(--spacing-lg);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        .table th {
            background: var(--gradient-dark);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: background-color var(--transition-fast);
        }

        .table tbody tr:hover {
            background-color: #f8fafc;
        }

        .table tbody tr:nth-child(even) {
            background-color: #fefefe;
        }

        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.unavailable {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-badge.active {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info-color);
        }

        /* CHANGE: Added styles for sale payment status */
        .status-badge.paid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-badge.overdue {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        /* END CHANGE */

        /* ============= MODALS ============= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: all var(--transition-normal);
            margin: var(--spacing-md);
            border: 1px solid #f1f5f9;
        }

        .modal.modal-show {
            transform: scale(1) translateY(0);
        }

        .modal-small { max-width: 400px; width: 100%; }
        .modal-medium { max-width: 600px; width: 100%; }
        .modal-large { max-width: 900px; width: 100%; }

        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--secondary-color);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background-color: #f1f5f9;
            color: var(--dark-color);
        }

        .modal-body {
            padding: var(--spacing-xl);
        }

        .modal-footer {
            padding: var(--spacing-xl);
            border-top: 1px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* CHANGE: Toast Notification Styles */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-notification.show {
            opacity: 1;
            visibility: visible;
        }

        .toast-notification.error {
            background-color: var(--danger-color);
        }

        .toast-notification.warning {
            background-color: var(--warning-color);
        }
        /* END CHANGE */

        /* Form sections */
        .form-section {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            border: 1px solid #f1f5f9;
            border-radius: var(--border-radius);
            background: #f8fafc;
        }

        .form-section h4 {
            margin-bottom: var(--spacing-md);
            color: var(--dark-color);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .form-text {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-top: 4px;
        }

        /* Financial specific styles */
        .profit-indicator {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: var(--border-radius);
        }

        .profit-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid #f1f5f9;
        }

        .metric.profit .value { color: var(--success-color); font-weight: 700; }
        .metric.loss .value { color: var(--danger-color); font-weight: 700; }
        .value.positive { color: var(--success-color); font-weight: 700; }
        .value.negative { color: var(--danger-color); font-weight: 700; }

        /* Finance tabs */
        .finance-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: var(--spacing-xl);
            background: #f1f5f9;
            border-radius: var(--border-radius);
            padding: 4px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary-color);
            transition: all var(--transition-fast);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .finance-tab-content {
            display: none;
        }

        .finance-tab-content.active {
            display: block;
        }

        /* Profile management */
        .profile-item {
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-md);
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: var(--border-radius);
        }

        .profile-fields {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--spacing-sm);
            align-items: center;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .main-content {
                padding: var(--spacing-md);
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .form-row,
            .profit-breakdown {
                grid-template-columns: 1fr;
            }

            .profile-fields {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .finance-tabs {
                overflow-x: auto;
                padding: 2px;
            }

            .tab-btn {
                white-space: nowrap;
            }

            /* Responsive table for smaller screens */
            .table-container {
                overflow-x: auto;
            }

            .table {
                min-width: 600px; /* Ensure table content doesn't collapse too much */
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs-content {
                overflow-x: auto;
            }

            .modal {
                margin: var(--spacing-sm);
                max-width: none;
                width: calc(100% - 2rem);
            }

            .form-row {
                grid-template-columns: 1fr; /* Stack form fields on very small screens */
            }

            .profile-fields {
                grid-template-columns: 1fr; /* Stack profile fields */
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in { animation: fadeIn 0.3s ease; }
        .fade-out { animation: fadeIn 0.3s ease reverse; }

        /* Utilities */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .d-flex { display: flex; }
        .d-none { display: none; }
        .gap-2 { gap: var(--spacing-sm); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mt-3 { margin-top: var(--spacing-md); }

        /* Specific styles for financial summary items */
        .summary-stats {
            display: grid;
            gap: 8px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-item .label {
            color: #6c757d;
        }
        
        .summary-item .value {
            font-weight: 600;
            color: var(--dark-color); /* Changed from #495057 to var(--dark-color) for consistency */
        }

        /* Styles for account profit/loss items in financial overview */
        .account-profit-item, .renewal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f8fafc;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
        }

        .account-profit-item .profit-info .profit {
            color: var(--success-color);
            font-weight: 700;
        }

        .account-profit-item .loss-info .loss {
            color: var(--danger-color);
            font-weight: 700;
        }

        .account-profit-item .profit-info .roi,
        .account-profit-item .loss-info .status {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        .renewal-item.urgent {
            border-left: 4px solid var(--danger-color);
            background: rgba(239, 68, 68, 0.05);
        }

        .renewal-item .renewal-info .cost {
            font-weight: 700;
            color: var(--primary-color);
        }

        .renewal-item .renewal-info .days {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: var(--secondary-color);
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--secondary-color);
        }

        /* ============= CLIENT PORTAL STYLES ============= */
        .client-portal-header {
            background: var(--gradient-primary);
            color: white;
            padding: var(--spacing-lg) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
        }

        .client-portal-header h1 {
            font-size: 1.8rem;
            margin: 0;
        }

        .client-portal-header .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .client-portal-header .user-info .balance {
            font-size: 1.2rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: var(--border-radius);
        }

        .client-portal-content {
            padding: var(--spacing-xl);
            max-width: 1200px;
            margin: 0 auto;
        }

        .client-section-title {
            font-size: 1.8rem;
            color: var(--dark-color);
            margin-bottom: var(--spacing-xl);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .account-card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            border: 1px solid #f1f5f9;
        }

        .account-card h3 {
            color: var(--dark-color);
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .account-card .price {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .account-card .description {
            color: var(--secondary-color);
        }

        .account-card .buy-btn {
            margin-top: var(--spacing-md);
        }

        .purchase-history-item {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border: 1px solid #f1f5f9;
        }

        .purchase-history-item strong {
            color: var(--dark-color);
        }

        .purchase-history-item .status-badge {
            margin-left: var(--spacing-sm);
        }

        .purchase-history-item .access-details {
            margin-top: var(--spacing-sm);
            background: #f8fafc;
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px dashed #e2e8f0;
        }

        .purchase-history-item .access-details p {
            margin: 0;
            padding: 4px 0;
        }

        .client-login-screen {
            background: var(--gradient-primary);
        }

        .client-register-card {
            max-width: 550px;
        }

        .client-register-card .form-row {
            grid-template-columns: 1fr 1fr;
        }

        .client-register-card .form-group.full-width {
            grid-column: 1 / -1;
        }

        .client-register-card .form-group.full-width input {
            width: 100%;
        }

        .client-register-card .form-group.full-width label {
            width: 100%;
        }

        /* Admin specific styles for client management */
        .client-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .client-status-badge.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .client-status-badge.pending-approval {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .client-status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .balance-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .balance-controls input {
            width: 80px;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
        }

        .balance-controls button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .balance-history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance-history-item:last-child {
            border-bottom: none;
        }

        .balance-history-item .amount {
            font-weight: 600;
        }

        .balance-history-item .amount.positive {
            color: var(--success-color);
        }

        .balance-history-item .amount.negative {
            color: var(--danger-color);
        }

        .balance-history-item .date {
            font-size: 0.8em;
            color: var(--secondary-color);
        }

        .whatsapp-button {
            background: #25D366;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .whatsapp-button:hover {
            background: #1DA851;
        }

        .whatsapp-button i {
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .client-register-card .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Styles for admin client management */
        .client-search-sort {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .client-search-sort input,
        .client-search-sort select {
            flex: 1;
            min-width: 150px;
        }

        .client-export-import {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        /* Styles for Recharge Requests */
        .recharge-request-item {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .recharge-request-item .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .recharge-request-item .details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xs);
            font-size: 0.9rem;
        }

        .recharge-request-item .actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .recharge-request-item .status-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .recharge-request-item .status-badge.pending-approval {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .recharge-request-item .status-badge.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .recharge-request-item .status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .bank-info-section {
            background: #f8fafc;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            border: 1px solid #e2e8f0;
        }

        .bank-info-section h4 {
            margin-bottom: var(--spacing-sm);
            color: var(--dark-color);
        }

        .bank-info-section p {
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .bank-info-section strong {
            color: var(--primary-color);
        }

        .bank-info-section .warning-text {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: var(--spacing-sm);
        }

        .recharge-min-amount {
            color: var(--warning-color);
            font-weight: 600;
            margin-top: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login (Admin) -->
    <div id="adminLoginScreen" class="login-screen" role="dialog" aria-modal="true" aria-labelledby="admin-login-title">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-user-shield" aria-hidden="true"></i>
                    </div>
                    <h1 id="admin-login-title">Admin Login</h1>
                    <p>Acceso al panel administrativo</p>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label for="adminLoginEmail">
                            <i class="fas fa-envelope" aria-hidden="true"></i> Email
                        </label>
                        <input type="email" id="adminLoginEmail" class="form-control" placeholder="admin@tudominio.com" autocomplete="username" aria-required="true" tabindex="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminLoginPassword">
                            <i class="fas fa-lock" aria-hidden="true"></i> Contraseña
                        </label>
                        <input type="password" id="adminLoginPassword" class="form-control" placeholder="Contraseña" autocomplete="current-password" aria-required="true" tabindex="0">
                    </div>
                    
                    <button class="btn btn-full" onclick="loginAdmin()" tabindex="0">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                        Iniciar Sesión Admin
                    </button>
                    <button class="btn btn-secondary btn-full mt-3" onclick="showClientLogin()" tabindex="0">
                        <i class="fas fa-user" aria-hidden="true"></i>
                        Acceso Cliente
                    </button>
                    
                    <div id="adminLoginError" class="login-error" style="display: none;" role="alert" aria-live="assertive"></div>
                    <div id="adminLoginLoading" class="login-loading" style="display: none;" aria-live="polite">
                        <div class="spinner" role="status" aria-label="Cargando"></div>
                        <p>Verificando credenciales...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Login (Cliente) -->
    <div id="clientLoginScreen" class="login-screen client-login-screen" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="client-login-title">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-user" aria-hidden="true"></i>
                    </div>
                    <h1 id="client-login-title">Acceso Cliente</h1>
                    <p>Ingresa a tu portal de cuentas</p>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label for="clientLoginEmail">
                            <i class="fas fa-envelope" aria-hidden="true"></i> Email
                        </label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="tu@email.com" autocomplete="username" aria-required="true" tabindex="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientLoginPassword">
                            <i class="fas fa-lock" aria-hidden="true"></i> Contraseña
                        </label>
                        <input type="password" id="clientLoginPassword" class="form-control" placeholder="Contraseña" autocomplete="current-password" aria-required="true" tabindex="0">
                    </div>
                    
                    <button class="btn btn-full" onclick="loginClient()" tabindex="0">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                        Iniciar Sesión Cliente
                    </button>
                    <button class="btn btn-secondary btn-full mt-3" onclick="showClientRegister()" tabindex="0">
                        <i class="fas fa-user-plus" aria-hidden="true"></i>
                        Registrarse
                    </button>
                    <button class="btn btn-secondary btn-full mt-3" onclick="showAdminLogin()" tabindex="0">
                        <i class="fas fa-user-shield" aria-hidden="true"></i>
                        Acceso Admin
                    </button>
                    
                    <div id="clientLoginError" class="login-error" style="display: none;" role="alert" aria-live="assertive"></div>
                    <div id="clientLoginLoading" class="login-loading" style="display: none;" aria-live="polite">
                        <div class="spinner" role="status" aria-label="Cargando"></div>
                        <p>Verificando credenciales...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Registro (Cliente) -->
    <div id="clientRegisterScreen" class="login-screen client-login-screen" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="client-register-title">
        <div class="login-container">
            <div class="login-card client-register-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-user-plus" aria-hidden="true"></i>
                    </div>
                    <h1 id="client-register-title">Registro de Cliente</h1>
                    <p>Crea tu cuenta para acceder a nuestros servicios</p>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label for="registerName">
                            <i class="fas fa-user" aria-hidden="true"></i> Nombre <span aria-hidden="true">*</span>
                        </label>
                        <input type="text" id="registerName" class="form-control" placeholder="Tu nombre" aria-required="true" tabindex="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="registerEmail">
                            <i class="fas fa-envelope" aria-hidden="true"></i> Email <span aria-hidden="true">*</span>
                        </label>
                        <input type="email" id="registerEmail" class="form-control" placeholder="tu@email.com" aria-required="true" tabindex="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="registerPassword">
                            <i class="fas fa-lock" aria-hidden="true"></i> Contraseña <span aria-hidden="true">*</span>
                        </label>
                        <input type="password" id="registerPassword" class="form-control" placeholder="Contraseña" aria-required="true" tabindex="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="registerConfirmPassword">
                            <i class="fas fa-lock" aria-hidden="true"></i> Confirmar Contraseña <span aria-hidden="true">*</span>
                        </label>
                        <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Repite tu contraseña" aria-required="true" tabindex="0">
                    </div>

                    <div class="form-group">
                        <label for="registerPhone">
                            <i class="fab fa-whatsapp" aria-hidden="true"></i> Teléfono (WhatsApp) <span aria-hidden="true">*</span>
                        </label>
                        <input type="tel" id="registerPhone" class="form-control" placeholder="Ej: 0912345678 o +593912345678" aria-required="true" tabindex="0">
                        <small class="form-text">Formato ecuatoriano (ej: 09XXXXXXXX o +593XXXXXXXXX)</small>
                    </div>
                    
                    <button class="btn btn-full" onclick="registerClient()" tabindex="0">
                        <i class="fas fa-user-plus" aria-hidden="true"></i>
                        Registrarse
                    </button>
                    <button class="btn btn-secondary btn-full mt-3" onclick="showClientLogin()" tabindex="0">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                        Ya tengo cuenta
                    </button>
                    
                    <div id="clientRegisterError" class="login-error" style="display: none;" role="alert" aria-live="assertive"></div>
                    <div id="clientRegisterLoading" class="login-loading" style="display: none;" aria-live="polite">
                        <div class="spinner" role="status" aria-label="Cargando"></div>
                        <p>Registrando usuario...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modo Demo (Admin) -->
    <div id="adminDemoScreen" class="login-screen" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="admin-demo-title">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-user-shield" aria-hidden="true"></i>
                    </div>
                    <h1 id="admin-demo-title">Streaming Admin</h1>
                    <p><strong>Modo Demo Activo (Admin)</strong></p>
                </div>
                
                <div class="demo-content">
                    <div class="demo-alert" role="alert">
                        <h3><i class="fas fa-info-circle" aria-hidden="true"></i> Modo de Demostración</h3>
                        <p>Firebase Authentication no está disponible en este entorno.</p>
                        <p><strong>Para funcionalidad completa:</strong> Implementa en tu servidor con Firebase configurado.</p>
                    </div>
                    
                    <button class="btn btn-success btn-full" onclick="enterAdminDemoMode()" tabindex="0">
                        <i class="fas fa-rocket" aria-hidden="true"></i>
                        Probar Modo Demo Admin
                    </button>
                    
                    <div class="demo-features">
                        <h4><i class="fas fa-list-check" aria-hidden="true"></i> Funcionalidades disponibles:</h4>
                        <ul>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Gestión completa de cuentas streaming</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Administración de clientes</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Sistema de ventas y rentabilidad</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Dashboard financiero avanzado</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Generación de mensajes WhatsApp</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Análisis de ROI y ganancias</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> **Gestión de Clientes Web (Aprobación, Saldo, Compras)**</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> **Módulo de verificación de comprobantes de pago**</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modo Demo (Cliente) -->
    <div id="clientDemoScreen" class="login-screen client-login-screen" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="client-demo-title">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-user" aria-hidden="true"></i>
                    </div>
                    <h1 id="client-demo-title">Portal Cliente</h1>
                    <p><strong>Modo Demo Activo (Cliente)</strong></p>
                </div>
                
                <div class="demo-content">
                    <div class="demo-alert" role="alert">
                        <h3><i class="fas fa-info-circle" aria-hidden="true"></i> Modo de Demostración</h3>
                        <p>Firebase Authentication no está disponible en este entorno.</p>
                        <p><strong>Para funcionalidad completa:</strong> Implementa en tu servidor con Firebase configurado.</p>
                    </div>
                    
                    <button class="btn btn-success btn-full" onclick="enterClientDemoMode()" tabindex="0">
                        <i class="fas fa-rocket" aria-hidden="true"></i>
                        Probar Modo Demo Cliente
                    </button>
                    
                    <div class="demo-features">
                        <h4><i class="fas fa-list-check" aria-hidden="true"></i> Funcionalidades disponibles:</h4>
                        <ul>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Dashboard con saldo</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Catálogo de cuentas disponibles</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Compra automática de perfiles</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Historial de compras con datos de acceso</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> Mensajes de stock inteligente</li>
                            <li><i class="fas fa-check" aria-hidden="true"></i> **Solicitud de recarga de saldo con comprobante**</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aplicación Principal (Admin) -->
    <div id="mainApp" class="main-app" style="display: none;">
        <!-- Header -->
        <header class="header" role="banner">
            <div class="header-content">
                <div class="header-brand">
                    <div class="logo">
                        <i class="fas fa-play-circle" aria-hidden="true"></i>
                    </div>
                    <h1>Streaming Admin</h1>
                </div>
                <div class="user-info">
                    <span id="userEmail" class="user-email" aria-label="Correo electrónico del usuario"></span>
                    <button class="btn btn-danger btn-sm" onclick="logoutAdmin()" aria-label="Cerrar sesión" tabindex="0">
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        Salir
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs" role="navigation" aria-label="Navegación principal">
            <div class="nav-tabs-content">
                <button class="nav-btn active" onclick="showSection('dashboard')" aria-controls="dashboard" aria-selected="true" role="tab" tabindex="0">
                    <i class="fas fa-chart-line" aria-hidden="true"></i> Dashboard
                </button>
                <button class="nav-btn" onclick="showSection('accounts')" aria-controls="accounts" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-tv" aria-hidden="true"></i> Cuentas
                </button>
                <button class="nav-btn" onclick="showSection('clients')" aria-controls="clients" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-users" aria-hidden="true"></i> Clientes
                </button>
                <button class="nav-btn" onclick="showSection('sales')" aria-controls="sales" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-shopping-cart" aria-hidden="true"></i> Ventas
                </button>
                <button class="nav-btn" onclick="showSection('finances')" aria-controls="finances" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-chart-pie" aria-hidden="true"></i> Finanzas
                </button>
                <button class="nav-btn" onclick="showSection('webClients')" aria-controls="webClients" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-globe" aria-hidden="true"></i> Clientes Web
                </button>
                <button class="nav-btn" onclick="showSection('rechargeRequests')" aria-controls="rechargeRequests" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-money-check-alt" aria-hidden="true"></i> Recargas
                </button>
                <button class="nav-btn" onclick="showSection('services')" aria-controls="services" aria-selected="false" role="tab" tabindex="0">
    <i class="fas fa-box" aria-hidden="true"></i> Servicios
</button>

                <button class="nav-btn" onclick="showSection('config')" aria-controls="config" aria-selected="false" role="tab" tabindex="0">
                    <i class="fas fa-cog" aria-hidden="true"></i> Config
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" role="main">
            <!-- Dashboard -->
            <section id="dashboard" class="section active" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line" aria-hidden="true"></i>
                        Dashboard
                    </h2>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" role="region" aria-labelledby="totalAccounts">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-tv" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalAccounts">0</div>
                        <div class="stat-label">Cuentas Totales</div>
                    </div>
                    <div class="stat-card success" role="region" aria-labelledby="totalClients">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-users" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Clientes Activos</div>
                    </div>
                    <div class="stat-card warning" role="region" aria-labelledby="totalSales">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalSales">0</div>
                        <div class="stat-label">Ventas del Mes</div>
                    </div>
                    <div class="stat-card danger" role="region" aria-labelledby="totalRevenue">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalRevenue">$0</div>
                        <div class="stat-label">Ingresos</div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card" role="region" aria-labelledby="quick-actions-title">
                        <div class="card-header">
                            <h3 id="quick-actions-title"><i class="fas fa-bolt" aria-hidden="true"></i> Acciones Rápidas</h3>
                        </div>
                        <div class="card-body">
                            <div class="action-buttons">
                                <button class="btn" onclick="openAddAccountModal()" tabindex="0">
                                    <i class="fas fa-plus" aria-hidden="true"></i> Nueva Cuenta
                                </button>
                                <button class="btn btn-success" onclick="openAddClientModal()" tabindex="0">
                                    <i class="fas fa-user-plus" aria-hidden="true"></i> Nuevo Cliente
                                </button>
                                <button class="btn btn-warning" onclick="openSaleModal()" tabindex="0">
                                    <i class="fas fa-cash-register" aria-hidden="true"></i> Nueva Venta
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card" role="region" aria-labelledby="platform-distribution-title">
                        <div class="card-header">
                            <h3 id="platform-distribution-title"><i class="fas fa-chart-bar" aria-hidden="true"></i> Distribución por Plataforma</h3>
                        </div>
                        <div class="card-body">
                            <div id="platformStats">No hay cuentas registradas</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Cuentas -->
            <section id="accounts" class="section" role="tabpanel" aria-labelledby="accounts-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tv" aria-hidden="true"></i>
                        Gestión de Cuentas
                    </h2>
                    <button class="btn" onclick="openAddAccountModal()" tabindex="0">
                        <i class="fas fa-plus" aria-hidden="true"></i> Nueva Cuenta
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="accountsTable" role="table" aria-label="Tabla de Cuentas">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-play-circle" aria-hidden="true"></i> Plataforma</th>
                                <th scope="col"><i class="fas fa-envelope" aria-hidden="true"></i> Usuario</th>
                                <th scope="col"><i class="fas fa-user-friends" aria-hidden="true"></i> Perfiles</th>
                                <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Precio/Perfil</th>
                                <th scope="col"><i class="fas fa-credit-card" aria-hidden="true"></i> Precio Total</th>
                                <th scope="col"><i class="fas fa-info-circle" aria-hidden="true"></i> Estado</th>
                                <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Clientes -->
            <section id="clients" class="section" role="tabpanel" aria-labelledby="clients-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-users" aria-hidden="true"></i>
                        Gestión de Clientes
                    </h2>
                    <button class="btn btn-success" onclick="openAddClientModal()" tabindex="0">
                        <i class="fas fa-user-plus" aria-hidden="true"></i> Nuevo Cliente
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="clientsTable" role="table" aria-label="Tabla de Clientes">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-user" aria-hidden="true"></i> Nombre</th>
                                <th scope="col"><i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp</th>
                                <th scope="col"><i class="fas fa-envelope" aria-hidden="true"></i> Email</th>
                                <th scope="col"><i class="fas fa-shopping-cart" aria-hidden="true"></i> Compras</th>
                                <th scope="col"><i class="fas fa-calendar" aria-hidden="true"></i> Última Compra</th>
                                <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Ventas -->
            <section id="sales" class="section" role="tabpanel" aria-labelledby="sales-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                        Gestión de Ventas
                    </h2>
                    <button class="btn btn-warning" onclick="openSaleModal()" tabindex="0">
                        <i class="fas fa-cash-register" aria-hidden="true"></i> Nueva Venta
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="salesTable" role="table" aria-label="Tabla de Ventas">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-user" aria-hidden="true"></i> Cliente</th>
                                <th scope="col"><i class="fas fa-play-circle" aria-hidden="true"></i> Plataforma</th>
                                <th scope="col"><i class="fas fa-user-friends" aria-hidden="true"></i> Perfiles</th>
                                <th scope="col"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Inicio</th>
                                <th scope="col"><i class="fas fa-calendar-times" aria-hidden="true"></i> Fin</th>
                                <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Total</th>
                                <th scope="col"><i class="fas fa-info-circle" aria-hidden="true"></i> Estado</th>
                                <th scope="col"><i class="fas fa-money-bill" aria-hidden="true"></i> Pago</th> <!-- CHANGE: Added Payment Status column -->
                                <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Finanzas -->
            <section id="finances" class="section" role="tabpanel" aria-labelledby="finances-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie" aria-hidden="true"></i>
                        Centro Financiero
                    </h2>
                </div>

                <!-- Métricas principales -->
                <div class="stats-grid">
                    <div class="stat-card success" role="region" aria-labelledby="netProfit">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="netProfit">$0.00</div>
                        <div class="stat-label">Ganancia Neta</div>
                    </div>
                    <div class="stat-card danger" role="region" aria-labelledby="totalInvestment">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-hand-holding-usd" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="totalInvestment">$0.00</div>
                        <div class="stat-label">Inversión Total</div>
                    </div>
                    <div class="stat-card" role="region" aria-labelledby="financialTotalRevenue">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="financialTotalRevenue">$0.00</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                    <div class="stat-card warning" role="region" aria-labelledby="averageROI">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-percentage" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="averageROI">0%</div>
                        <div class="stat-label">ROI Promedio</div>
                    </div>
                </div>

                <!-- Tabs financieros -->
                <div class="finance-tabs" role="tablist" aria-label="Pestañas financieras">
                    <button class="tab-btn active" onclick="financialManager.showFinanceTab('overview', event)" aria-controls="finance-overview" aria-selected="true" role="tab" tabindex="0">
                        <i class="fas fa-eye" aria-hidden="true"></i> Resumen
                    </button>
                    <button class="tab-btn" onclick="financialManager.showFinanceTab('accounts', event)" aria-controls="finance-accounts" aria-selected="false" role="tab" tabindex="0">
                        <i class="fas fa-tv" aria-hidden="true"></i> Cuentas
                    </button>
                    <button class="tab-btn" onclick="financialManager.showFinanceTab('expenses', event)" aria-controls="finance-expenses" aria-selected="false" role="tab" tabindex="0">
                        <i class="fas fa-receipt" aria-hidden="true"></i> Gastos
                    </button>
                    <button class="tab-btn" onclick="financialManager.showFinanceTab('reports', event)" aria-controls="finance-reports" aria-selected="false" role="tab" tabindex="0">
                        <i class="fas fa-file-alt" aria-hidden="true"></i> Reportes
                    </button>
                </div>

                <!-- Tab: Resumen -->
                <div id="finance-overview" class="finance-tab-content active" role="tabpanel" aria-labelledby="overview-tab">
                    <div class="cards-grid">
                        <div class="card" role="region" aria-labelledby="profitable-accounts-title">
                            <div class="card-header">
                                <h3 id="profitable-accounts-title"><i class="fas fa-trophy" aria-hidden="true"></i> Cuentas Más Rentables</h3>
                            </div>
                            <div class="card-body">
                                <div id="topProfitableAccounts">
                                    <div class="loading">Calculando...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" role="region" aria-labelledby="losing-accounts-title">
                            <div class="card-header">
                                <h3 id="losing-accounts-title"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Cuentas con Pérdidas</h3>
                            </div>
                            <div class="card-body">
                                <div id="losingAccounts">
                                    <div class="loading">Calculando...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" role="region" aria-labelledby="upcoming-renewals-title">
                            <div class="card-header">
                                <h3 id="upcoming-renewals-title"><i class="fas fa-calendar-exclamation" aria-hidden="true"></i> Renovaciones Próximas</h3>
                            </div>
                            <div class="card-body">
                                <div id="upcomingRenewals">
                                    <div class="loading">Cargando...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" role="region" aria-labelledby="general-summary-title">
                            <div class="card-header">
                                <h3 id="general-summary-title"><i class="fas fa-chart-bar" aria-hidden="true"></i> Resumen General</h3>
                            </div>
                            <div class="card-body">
                                <div id="generalSummary">
                                    <div class="loading">Cargando...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Análisis por Cuentas -->
                <div id="finance-accounts" class="finance-tab-content" role="tabpanel" aria-labelledby="accounts-tab" hidden>
                    <div class="table-container">
                        <table class="table" id="financialAccountsTable" role="table" aria-label="Tabla de Análisis Financiero por Cuentas">
                            <thead>
                                <tr>
                                    <th scope="col"><i class="fas fa-play-circle" aria-hidden="true"></i> Plataforma</th>
                                    <th scope="col"><i class="fas fa-envelope" aria-hidden="true"></i> Email</th>
                                    <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Costo</th>
                                    <th scope="col"><i class="fas fa-chart-line" aria-hidden="true"></i> Ingresos</th>
                                    <th scope="col"><i class="fas fa-hand-holding-usd" aria-hidden="true"></i> Ganancia</th>
                                    <th scope="col"><i class="fas fa-percentage" aria-hidden="true"></i> ROI</th>
                                    <th scope="col"><i class="fas fa-info-circle" aria-hidden="true"></i> Estado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Gestión de Gastos -->
                <div id="finance-expenses" class="finance-tab-content" role="tabpanel" aria-labelledby="expenses-tab" hidden>
                    <div class="section-header">
                        <button class="btn btn-success" onclick="financialManager.openAddExpenseModal()" tabindex="0">
                            <i class="fas fa-plus" aria-hidden="true"></i> Agregar Gasto
                        </button>
                    </div>
                    
                    <div class="stats-grid mb-3">
                        <div class="stat-card warning" role="region" aria-labelledby="monthlyExpenses">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="monthlyExpenses">$0.00</div>
                            <div class="stat-label">Gastos del Mes</div>
                        </div>
                        <div class="stat-card danger" role="region" aria-labelledby="yearlyExpenses">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar" aria-hidden="true"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="yearlyExpenses">$0.00</div>
                            <div class="stat-label">Gastos del Año</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table" id="expensesTable" role="table" aria-label="Tabla de Gastos">
                            <thead>
                                <tr>
                                    <th scope="col"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Fecha</th>
                                    <th scope="col"><i class="fas fa-file-text" aria-hidden="true"></i> Descripción</th>
                                    <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Monto</th>
                                    <th scope="col"><i class="fas fa-tag" aria-hidden="true"></i> Categoría</th>
                                    <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Reportes -->
                <div id="finance-reports" class="finance-tab-content" role="tabpanel" aria-labelledby="reports-tab" hidden>
                    <div class="cards-grid">
                        <div class="card report-card" onclick="financialManager.generateMonthlyReport()" role="button" tabindex="0" aria-label="Generar Reporte Mensual"> <!-- CHANGE: Updated onclick to generateMonthlyReport -->
                            <div class="card-header">
                                <h3><i class="fas fa-chart-bar" aria-hidden="true"></i> Reporte Mensual</h3>
                            </div>
                            <div class="card-body">
                                <p>Resumen de ingresos, gastos y rentabilidad del mes actual.</p>
                            </div>
                        </div>
                        
                        <div class="card report-card" onclick="financialManager.generateAccountReport()" role="button" tabindex="0" aria-label="Generar Reporte por Cuentas">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Reporte por Cuentas</h3>
                            </div>
                            <div class="card-body">
                                <p>Análisis detallado de rentabilidad por cuenta.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clientes Web (Nueva Sección Admin) -->
            <section id="webClients" class="section" role="tabpanel" aria-labelledby="web-clients-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-globe" aria-hidden="true"></i>
                        Gestión de Clientes Web
                    </h2>
                </div>

                <div class="client-search-sort">
                    <input type="text" id="clientSearchInput" class="form-control" placeholder="Buscar por nombre o email..." onkeyup="webClientManager.filterAndSortUsers()">
                    <select type="text" id="clientSortBy" class="form-control" onchange="webClientManager.filterAndSortUsers()">
                        <option value="name">Ordenar por Nombre</option>
                        <option value="email">Ordenar por Email</option>
                        <option value="balance">Ordenar por Saldo</option>
                        <option value="createdAt">Ordenar por Fecha de Registro</option>
                    </select>
                    <select type="text" id="clientSortOrder" class="form-control" onchange="webClientManager.filterAndSortUsers()">
                        <option value="asc">Ascendente</option>
                        <option value="desc">Descendente</option>
                    </select>
                </div>

                <div class="client-export-import">
                    <button class="btn btn-secondary" onclick="webClientManager.exportUsersToCsv()">
                        <i class="fas fa-file-csv" aria-hidden="true"></i> Exportar a CSV
                    </button>
                    <button class="btn btn-secondary" onclick="webClientManager.exportDatabaseToJson()">
                        <i class="fas fa-file-export" aria-hidden="true"></i> Exportar DB (JSON)
                    </button>
                    <input type="file" id="importJsonFile" accept=".json" style="display: none;" onchange="webClientManager.importDatabaseFromJson(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('importJsonFile').click()">
                        <i class="fas fa-file-import" aria-hidden="true"></i> Importar DB (JSON)
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="allClientsTable" role="table" aria-label="Tabla de Todos los Clientes">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-user" aria-hidden="true"></i> Nombre</th>
                                <th scope="col"><i class="fas fa-envelope" aria-hidden="true"></i> Email</th>
                                <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Saldo</th>
                                <th scope="col"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Fecha Registro</th>
                                <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Módulo de Verificación de Comprobantes de Pago (Admin) -->
            <section id="rechargeRequests" class="section" role="tabpanel" aria-labelledby="recharge-requests-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-money-check-alt" aria-hidden="true"></i>
                        Solicitudes de Recarga
                    </h2>
                </div>

                <div id="pendingRechargeRequests">
                    <div class="loading">Cargando solicitudes pendientes...</div>
                </div>

                <h3 class="section-title mt-3">
                    <i class="fas fa-history" aria-hidden="true"></i>
                    Historial de Recargas
                </h3>
                <div id="processedRechargeRequests">
                    <div class="loading">Cargando historial de recargas...</div>
                </div>
            </section>

            <section id="services" class="section" role="tabpanel" aria-labelledby="services-tab" hidden>
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-box" aria-hidden="true"></i>
            Gestión de Servicios/Planes
        </h2>
        <button class="btn" onclick="openAddServiceModal()" tabindex="0">
            <i class="fas fa-plus" aria-hidden="true"></i> Nuevo Servicio
        </button>
    </div>

    <div class="table-container">
        <table class="table" id="servicesTable" role="table" aria-label="Tabla de Servicios">
            <thead>
                <tr>
                    <th scope="col"><i class="fas fa-image" aria-hidden="true"></i> Imagen</th>
                    <th scope="col"><i class="fas fa-tag" aria-hidden="true"></i> Nombre</th>
                    <th scope="col"><i class="fas fa-dollar-sign" aria-hidden="true"></i> Precio</th>
                    <th scope="col"><i class="fas fa-info-circle" aria-hidden="true"></i> Descripción</th>
                    <th scope="col"><i class="fas fa-tv" aria-hidden="true"></i> Cuentas Disponibles</th>
                    <th scope="col"><i class="fas fa-tools" aria-hidden="true"></i> Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6" class="no-data">No hay servicios registrados.</td></tr>
            </tbody>
        </table>
    </div>
</section>

            <!-- Configuración -->
            <section id="config" class="section" role="tabpanel" aria-labelledby="config-tab" hidden>
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-cog" aria-hidden="true"></i>
                        Configuración
                    </h2>
                </div>

                <div class="card" role="region" aria-labelledby="firebase-status-title">
                    <div class="card-header">
                        <h3 id="firebase-status-title"><i class="fas fa-database" aria-hidden="true"></i> Estado de Firebase</h3>
                    </div>
                    <div class="card-body">
                        <div id="configStatus">
                            <p id="configInfo"><strong>Modo Demo:</strong> Funcionando con datos locales</p>
                        </div>
                        <button class="btn" onclick="testFirebaseConnection()" tabindex="0">
                            <i class="fas fa-plug" aria-hidden="true"></i> Probar Conexión
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Aplicación Principal (Cliente) -->
    <div id="clientApp" class="main-app" style="display: none;">
        <header class="client-portal-header" role="banner">
            <div class="header-brand">
                <div class="logo">
                    <i class="fas fa-user" aria-hidden="true"></i>
                </div>
                <h1>Mi Portal</h1>
            </div>
            <div class="user-info">
                <span id="clientDisplayName" class="user-email" aria-label="Nombre del cliente"></span>
                <span id="clientBalance" class="balance" aria-label="Saldo actual del cliente">$0.00</span>
                <button class="btn btn-danger btn-sm" onclick="logoutClient()" aria-label="Cerrar sesión" tabindex="0">
                    <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                    Salir
                </button>
            </div>
        </header>

        <main class="client-portal-content" role="main">
            <h2 class="client-section-title">
                <i class="fas fa-wallet" aria-hidden="true"></i>
                Mi Saldo y Transacciones
            </h2>
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-dollar-sign" aria-hidden="true"></i> Saldo Actual</h3>
                    </div>
                    <div class="card-body text-center">
                        <p style="font-size: 2.5rem; font-weight: 700;" id="userCurrentBalance">$0.00</p>
                        <button class="btn btn-success mt-3" onclick="openRechargeModal()">
                            <i class="fas fa-plus-circle" aria-hidden="true"></i> Recargar Saldo
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-history" aria-hidden="true"></i> Historial de Transacciones</h3>
                    </div>
                    <div class="card-body">
                        <div id="transactionHistory">
                            <div class="no-data">No hay transacciones registradas.</div>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="client-section-title mt-3">
                <i class="fas fa-store" aria-hidden="true"></i>
                Catálogo de Cuentas
            </h2>

            <div id="availableAccountsCatalog" class="cards-grid">
                <!-- Cuentas disponibles se renderizarán aquí -->
                <div class="loading">Cargando catálogo...</div>
            </div>

            <h2 class="client-section-title mt-3">
                <i class="fas fa-history" aria-hidden="true"></i>
                Mi Historial de Compras
            </h2>

            <div id="clientPurchaseHistory">
                <!-- Historial de compras se renderizará aquí -->
                <div class="no-data">No tienes compras registradas aún.</div>
            </div>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay" role="presentation"></div>

    <!-- Toast Notification Element -->
    <div id="toastNotification" class="toast-notification" role="alert" aria-live="assertive">
        <span id="toastIcon"></span>
        <span id="toastMessage"></span>
    </div>

    <script>
        // ============= CONFIGURACIÓN FIREBASE =============
        // Reemplaza esta configuración con la de tu proyecto Firebase
        // Obtén los SDK que necesitas aquí: https://firebase.google.com/docs/web/setup#available-libraries

            const firebaseConfig = {
            apiKey: "AIzaSyDNINcVmzUG65S75zDp_7yPN41zyfLunr0",
            authDomain: "control-de-c.firebaseapp.com",
            databaseURL: "https://control-de-c-default-rtdb.firebaseio.com",
            projectId: "control-de-c",
            storageBucket: "control-de-c.firebasestorage.app",
            messagingSenderId: "332573734404",
            appId: "1:332573734404:web:6f2a4a064bac6febec6751"
            };
        /* REEMPLAZAR_CON_TU_CONFIG */

        // ============= CONFIGURACIÓN IMGBB =============
        const IMGBB_API_KEY = "8ce353ca72771ab928e15bd597685042"; // Obtén tu API Key gratuita en https://api.imgbb.com/

        // ============= VARIABLES GLOBALES =============
        let activeModalInstance = null;
        let db; // Instancia de Firestore
        let accounts = [];
        let services = [];
        let clients = []; // Clientes del admin (manuales)
        let sales = [];
        let expenses = [];
        let webClients = []; // Clientes del portal web (ahora 'users' en Firestore)
        let rechargeRequests = []; // Solicitudes de recarga
        let currentUser = null; // Usuario logeado (admin o cliente web)
        let financialManager = null;
        let webClientManager = null; // Renombrado a UserManager para manejar todos los usuarios
        let rechargeManager = null; // Declarar rechargeManager globalmente

        // UID del administrador para las reglas de Firebase (debe coincidir con el UID del usuario admin en Firebase Auth)
        const ADMIN_UID = '6MoZbkXBd8QCDh3QzQwDkiviw6u2'; // REEMPLAZAR CON EL UID REAL DE TU ADMIN

        // Número de WhatsApp del administrador para notificaciones
        const ADMIN_WHATSAPP_NUMBER = '593984952217'; // Formato sin '+' para la URL de WhatsApp

        // Monto mínimo de recarga
        const MIN_RECHARGE_AMOUNT = 5.00;

        // Detectar entorno (para modo demo en entornos específicos como Claude.ai o archivos locales)
        const isClaudeEnvironment = false; // Forzar modo producción para pruebas locales

                                   // Función global para normalizar fechas
function normalizeDate(value) {
    if (!value) return new Date(0); // fecha mínima
    if (typeof value.toDate === "function") return value.toDate(); // Timestamp Firestore
    if (typeof value === "string" || typeof value === "number") return new Date(value);
    return new Date(0);
}

// Funciones de modales para Clientes
        function openAddClientModal(clientId = null) {
            let client = null;
            if (clientId) {
                client = clients.find(c => c.id === clientId);
                if (!client) {
                    modal.alert('Cliente no encontrado para editar.', 'Error', 'error');
                    return;
                }
            }

            const formConfig = {
                fields: [
                    { type: 'text', name: 'name', label: 'Nombre Completo', required: true, value: client ? client.name : '' },
                    { type: 'tel', name: 'whatsApp', label: 'WhatsApp', required: true, placeholder: '+593 99 123 4567', value: client ? client.whatsApp : '' },
                    { type: 'email', name: 'email', label: 'Email (opcional)', value: client ? client.email : '' },
                    { type: 'textarea', name: 'notes', label: 'Notas', placeholder: 'Información adicional del cliente...', value: client ? client.notes : '' }
                ]
            };

            modal.form(formConfig, `${clientId ? 'Editar Cliente' : 'Agregar Nuevo Cliente'}`).then(async data => {
                if (data) {
                    const name = sanitizeInput(data.name);
                    const whatsApp = formatEcuadorianPhone(data.whatsApp);
                    const email = sanitizeInput(data.email || '');
                    const notes = sanitizeInput(data.notes || '');

                    if (!whatsApp) {
                        modal.alert('Formato de teléfono ecuatoriano inválido. Ej: 09XXXXXXXX o +593XXXXXXXXX', 'Error de Teléfono', 'error');
                        return;
                    }
                    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        modal.alert('El formato del email es inválido.', 'Error de Email', 'error');
                        return;
                    }

                    let clientToSave;
                    if (clientId) {
                        clientToSave = clients.find(c => c.id === clientId);
                        Object.assign(clientToSave, {
                            name: name,
                            whatsApp: whatsApp,
                            email: email,
                            notes: notes
                        });
                    } else {
                        clientToSave = {
                            id: Date.now().toString(),
                            name: name,
                            whatsApp: whatsApp,
                            email: email,
                            notes: notes,
                            purchases: 0,
                            lastPurchase: null,
                            createdAt: new Date().toISOString()
                        };
                        clients.push(clientToSave);
                    }

                    try {
                        await saveToFirebase('clients', clientToSave);
                        renderAll();
                        modal.toast(`Cliente ${clientId ? 'actualizado' : 'agregado'} correctamente.`, 'success');
                    } catch (error) {
                        console.error('Error saving client:', error);
                        modal.toast(`Error al guardar el cliente: ${error.message}`, 'error');
                    }
                }
            });
        }

        // Add this function to your JavaScript code (around line 1000, near other modal functions)

function openAddServiceModal(serviceId = null) {
    let service = null;
    if (serviceId) {
        service = services.find(s => s.id === serviceId);
        if (!service) {
            modal.alert('Servicio no encontrado para editar.', 'Error', 'error');
            return;
        }
    }

    // Get unique platforms from existing accounts
    const platforms = [...new Set(accounts.map(acc => acc.platform))];
    const platformOptions = [
        { value: '', text: 'Seleccionar plataforma...' },
        ...platforms.map(platform => ({ value: platform, text: platform }))
    ];

    const formConfig = {
        fields: [
            { type: 'text', name: 'name', label: 'Nombre del Servicio', required: true, value: service ? service.name : '', placeholder: 'Ej: Netflix Premium' },
            { type: 'textarea', name: 'description', label: 'Descripción', required: true, value: service ? service.description : '', placeholder: 'Describe las características del servicio...' },
            { type: 'number', name: 'price', label: 'Precio ($)', required: true, value: service ? (service.price || 0).toFixed(2) : '', step: '0.01', min: '0', placeholder: '0.00' },
            { type: 'select', name: 'platform', label: 'Plataforma Asociada', required: true, options: platformOptions, value: service ? service.platform : '' },
            { type: 'number', name: 'profilesPerPurchase', label: 'Perfiles por Compra', required: true, value: service ? (service.profilesPerPurchase || 1) : '1', min: '1', placeholder: '1' },
            { type: 'text', name: 'imageUrl', label: 'URL de Imagen', required: true, value: service ? service.imageUrl : '', placeholder: 'https://ejemplo.com/imagen.jpg' }
        ]
    };

    modal.form(formConfig, `${serviceId ? 'Editar Servicio' : 'Agregar Nuevo Servicio'}`).then(async data => {
        if (data) {
            const name = sanitizeInput(data.name);
            const description = sanitizeInput(data.description);
            const price = parseFloat(data.price);
            const platform = sanitizeInput(data.platform);
            const profilesPerPurchase = parseInt(data.profilesPerPurchase);
            const imageUrl = sanitizeInput(data.imageUrl);

            // Validations
            if (isNaN(price) || price < 0) {
                modal.alert('El precio debe ser un número positivo.', 'Error de Precio', 'error');
                return;
            }
            if (isNaN(profilesPerPurchase) || profilesPerPurchase < 1) {
                modal.alert('El número de perfiles por compra debe ser al menos 1.', 'Error de Perfiles', 'error');
                return;
            }
            if (!imageUrl.startsWith('http')) {
                modal.alert('La URL de la imagen debe comenzar con http:// o https://', 'URL Inválida', 'error');
                return;
            }

            let serviceToSave;
            if (serviceId) {
                serviceToSave = services.find(s => s.id === serviceId);
                Object.assign(serviceToSave, {
                    name: name,
                    description: description,
                    price: price,
                    platform: platform,
                    profilesPerPurchase: profilesPerPurchase,
                    imageUrl: imageUrl
                });
            } else {
                serviceToSave = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    price: price,
                    platform: platform,
                    profilesPerPurchase: profilesPerPurchase,
                    imageUrl: imageUrl,
                    createdAt: new Date().toISOString()
                };
                services.push(serviceToSave);
            }

            try {
                await saveToFirebase('services', serviceToSave);
                renderServices();
                renderAvailableAccountsCatalog(); // Update client catalog
                modal.toast(`Servicio ${serviceId ? 'actualizado' : 'agregado'} correctamente.`, 'success');
            } catch (error) {
                console.error('Error saving service:', error);
                modal.toast(`Error al guardar el servicio: ${error.message}`, 'error');
            }
        }
    });
}

        function editClient(id) {
            openAddClientModal(id);
        }

        async function deleteClient(id) {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar este cliente? Esto no eliminará las ventas asociadas, pero el cliente aparecerá como "eliminado".', 'Confirmar Eliminación');
            if (confirmed) {
                try {
                    clients = clients.filter(c => c.id !== id);

                    await deleteFromFirebase('clients', id);
                    renderAll();
                    modal.toast('✅ Cliente eliminado correctamente.', 'success');
                } catch (error) {
                    console.error('Error deleting client:', error);
                    modal.toast(`Error al eliminar el cliente: ${error.message}`, 'error');
                }
            }
        }


// Funciones de modales para Ventas
function openSaleModal(saleId = null) {
    // Cerrar modal anterior si existe
    if (activeModalInstance) {
        activeModalInstance.close();
        activeModalInstance = null;
    }

    let sale = null;
    if (saleId) {
        sale = sales.find(s => s.id === saleId);
        if (!sale) {
            modal.alert('Venta no encontrada para editar.', 'Error', 'error');
            return;
        }
    }

    if (accounts.length === 0) {
        modal.alert('Primero debes agregar al menos una cuenta.', 'Sin Cuentas', 'warning');
        return;
    }

    if (clients.length === 0 && webClients.filter(wc => wc.status === 'approved').length === 0) {
        modal.alert('Primero debes agregar al menos un cliente (manual o web aprobado).', 'Sin Clientes', 'warning');
        return;
    }

    const allClients = [
        ...clients.map(c => ({ value: c.id, text: `${c.name} (Manual)` })),
        ...webClients.filter(wc => wc.status === 'approved').map(wc => ({ value: wc.id, text: `${wc.name} ${wc.lastName || ''} (Web)` }))
    ];

    const clientOptions = allClients.map(c => ({ value: c.value, text: c.text }));
    const accountOptions = accounts.map(a => ({ 
        value: a.id, 
        text: `${a.platform} - ${a.email}` 
    }));

    const today = new Date();
    const endDateDefault = new Date();
    endDateDefault.setDate(today.getDate() + 30);

    const formConfig = {
        fields: [
            { type: 'select', name: 'clientId', label: 'Cliente', required: true, options: [{ value: '', text: 'Seleccionar cliente...' }, ...clientOptions], value: sale ? sale.clientId : '' },
            { type: 'select', name: 'accountId', label: 'Cuenta', required: true, options: [{ value: '', text: 'Seleccionar cuenta...' }, ...accountOptions], value: sale ? sale.accountId : '' },
            { type: 'number', name: 'profilesCount', label: 'Número de Perfiles', required: true, placeholder: '1', value: sale ? sale.profilesCount : '1', min: '1' },
            { type: 'date', name: 'startDate', label: 'Fecha de Inicio', required: true, value: sale ? sale.startDate : today.toISOString().split('T')[0] },
            { type: 'date', name: 'endDate', label: 'Fecha de Fin', required: true, value: sale ? sale.endDate : endDateDefault.toISOString().split('T')[0] },
            { type: 'number', name: 'total', label: 'Total ($)', required: true, placeholder: '0.00', value: sale ? (sale.total || 0).toFixed(2) : '', step: '0.01', min: '0' },
            { type: 'select', name: 'status', label: 'Estado', required: true, options: [
                { value: 'Activa', text: 'Activa' },
                { value: 'Inactiva', text: 'Inactiva' },
                { value: 'Pendiente', text: 'Pendiente' }
            ], value: sale ? sale.status : 'Activa' },
            { type: 'select', name: 'paid', label: 'Pagado', required: true, options: [
                { value: 'true', text: 'Sí' },
                { value: 'false', text: 'No' }
            ], value: sale ? sale.paid.toString() : 'false' }
        ]
    };

    // Abrir el modal y guardar la instancia
    activeModalInstance = modal.form(formConfig, `${saleId ? 'Editar Venta' : 'Nueva Venta'}`);

    activeModalInstance.then(async data => {
        // Limpiar referencia al cerrar el modal
        activeModalInstance = null;

        if (!data) return;

        // Validaciones
        if (!data.clientId || !data.accountId || !data.profilesCount || !data.startDate || !data.endDate || !data.total || !data.status || !data.paid) {
            modal.alert('Por favor, completa todos los campos obligatorios.', 'Campos Incompletos', 'warning');
            return;
        }
        if (isNaN(parseFloat(data.total)) || parseFloat(data.total) < 0) {
            modal.alert('El total debe ser un número positivo.', 'Error de Monto', 'error');
            return;
        }
        if (parseInt(data.profilesCount) <= 0) {
            modal.alert('El número de perfiles debe ser al menos 1.', 'Error de Perfiles', 'error');
            return;
        }

        const newSaleData = {
            clientId: data.clientId,
            accountId: data.accountId,
            profilesCount: parseInt(data.profilesCount),
            startDate: data.startDate,
            endDate: data.endDate,
            total: parseFloat(data.total),
            status: sanitizeInput(data.status),
            paid: data.paid === 'true',
            isAutoPurchase: false
        };

        let saleToSave;
        let oldAccount = null;
        let oldClient = null;

        if (saleId) {
            saleToSave = sales.find(s => s.id === saleId);
            if (!saleToSave) {
                modal.alert('Error: Venta no encontrada para actualizar.', 'Error', 'error');
                return;
            }

            oldAccount = accounts.find(acc => acc.id === saleToSave.accountId);
            if (oldAccount) {
                oldAccount.totalEarned = (oldAccount.totalEarned || 0) - saleToSave.total;
                oldAccount.profiles.forEach(p => {
                    if (p.saleId === saleToSave.id) {
                        p.available = true;
                        delete p.soldTo;
                        delete p.saleId;
                    }
                });
                oldAccount.status = oldAccount.profiles.some(p => p.available) ? 'Disponible' : 'Ocupado';
            }

            oldClient = clients.find(c => c.id === saleToSave.clientId) || webClients.find(wc => wc.id === saleToSave.clientId);
            if (oldClient) {
                oldClient.purchases = Math.max(0, (oldClient.purchases || 0) - 1);
            }

            Object.assign(saleToSave, newSaleData);
        } else {
            saleToSave = { id: Date.now().toString(), ...newSaleData, createdAt: new Date().toISOString() };
            sales.push(saleToSave);
        }

        const account = accounts.find(acc => acc.id === saleToSave.accountId);
        if (account) {
            account.totalEarned = (account.totalEarned || 0) + saleToSave.total;

            const availableProfiles = account.profiles.filter(p => p.available);
            let profilesAssigned = 0;
            for (let i = 0; i < availableProfiles.length && profilesAssigned < saleToSave.profilesCount; i++) {
                availableProfiles[i].available = false;
                availableProfiles[i].soldTo = saleToSave.clientId;
                availableProfiles[i].saleId = saleToSave.id;
                profilesAssigned++;
            }
            if (profilesAssigned < saleToSave.profilesCount) {
                modal.alert('No hay suficientes perfiles disponibles en esta cuenta. Se asignaron los disponibles.', 'Advertencia', 'warning');
            }
            account.status = account.profiles.some(p => p.available) ? 'Disponible' : 'Ocupado';

            const client = clients.find(c => c.id === saleToSave.clientId) || webClients.find(wc => wc.id === saleToSave.clientId);
            if (client) {
                client.purchases = (client.purchases || 0) + 1;
                client.lastPurchase = saleToSave.startDate;
            }

            try {
                const savePromises = [
                    saveToFirebase('sales', saleToSave),
                    saveToFirebase('accounts', account)
                ];
                if (client) savePromises.push(saveToFirebase(client.isWebClient ? 'webClients' : 'clients', client));
                if (oldAccount && oldAccount.id !== account.id) savePromises.push(saveToFirebase('accounts', oldAccount));
                if (oldClient && oldClient.id !== client.id) savePromises.push(saveToFirebase(oldClient.isWebClient ? 'webClients' : 'clients', oldClient));

                await Promise.all(savePromises);
                renderAll();
                financialManager.updateFinancialDashboard();
                modal.close();
                modal.toast(`Venta ${saleId ? 'actualizada' : 'completada'} correctamente.`, 'success');

                if (!saleId) generateWhatsAppFromSale(saleToSave.id);

            } catch (error) {
                console.error('Error al guardar la venta:', error);
                modal.toast(`Error al completar/actualizar la venta: ${error.message}`, 'error');
            }
        } else {
            modal.alert('❌ Cuenta no encontrada. No se puede completar la venta.', 'Error', 'error');
        }
    });
}

// Función para eliminar venta
async function deleteSale(id) {
    const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar esta venta? Esto liberará los perfiles asociados y ajustará las ganancias de la cuenta.', 'Confirmar Eliminación');
    if (!confirmed) return;

    try {
        const saleToDelete = sales.find(s => s.id === id);
        if (!saleToDelete) return modal.alert('Venta no encontrada.', 'error');

        const account = accounts.find(acc => acc.id === saleToDelete.accountId);
        if (account) {
            account.totalEarned = (account.totalEarned || 0) - saleToDelete.total;
            account.profiles.forEach(p => {
                if (p.saleId === saleToDelete.id) {
                    p.available = true;
                    delete p.soldTo;
                    delete p.saleId;
                }
            });
            account.status = account.profiles.some(p => p.available) ? 'Disponible' : 'Ocupado';
            await saveToFirebase('accounts', account);
        }

        const client = clients.find(c => c.id === saleToDelete.clientId) || webClients.find(wc => wc.id === saleToDelete.clientId);
        if (client) {
            client.purchases = Math.max(0, (client.purchases || 0) - 1);
            const remainingSalesForClient = sales.filter(s => s.clientId === client.id && s.id !== saleToDelete.id);
            client.lastPurchase = remainingSalesForClient.length
                ? remainingSalesForClient.sort((a, b) => new Date(b.startDate) - new Date(a.startDate))[0].startDate
                : null;
            await saveToFirebase(client.isWebClient ? 'webClients' : 'clients', client);
        }

        sales = sales.filter(s => s.id !== id);
        await deleteFromFirebase('sales', id);

        renderAll();
        financialManager.updateFinancialDashboard();
        modal.toast('✅ Venta eliminada correctamente.', 'success');
    } catch (error) {
        console.error('Error deleting sale:', error);
        modal.toast(`Error al eliminar la venta: ${error.message}`, 'error');
    }
}


        function generateWhatsAppFromSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                modal.alert('Venta no encontrada para generar mensaje.', 'Error', 'error');
                return;
            }

            const client = clients.find(c => c.id === sale.clientId) || webClients.find(wc => wc.id === sale.clientId);
            const account = accounts.find(acc => acc.id === sale.accountId);

            if (!client || !account) {
                modal.alert('Cliente o cuenta asociada a la venta no encontrada.', 'Error', 'error');
                return;
            }

            const assignedProfiles = account.profiles.filter(p => p.saleId === saleId);

            let message = `Hola! 😊 ${client.name},\n\n`;
            message += `Aquí tienes los datos de tu cuenta:\n\n`;
            message += `📲 *PLATAFORMA:* ${account.platform}\n`;
            message += `📧 *Usuario:* ${account.email}\n`;
            message += `🔐 *Contraseña:* ${account.password}\n`;
            message += `🆔 *Perfil${assignedProfiles.length > 1 ? 'es' : ''}:* ${assignedProfiles.map(p => p.name).join(', ')}\n`;
            message += `🔑 *PIN:* ${assignedProfiles.map(p => p.pin).join(', ')}\n`;
            message += `📅 *Vigencia:* ${new Date(sale.startDate).toLocaleDateString()} - ${new Date(sale.endDate).toLocaleDateString()}\n\n`;
            message += `¡Que disfrutes tu servicio!`;

            navigator.clipboard.writeText(message).then(() => {
                modal.toast('📱 Mensaje copiado al portapapeles. ¡Listo para enviar por WhatsApp!', 'success');
            }).catch(err => {
                console.error('Error al copiar al portapapeles:', err);
                const textArea = document.createElement('textarea');
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    modal.toast('📱 Mensaje copiado al portapapeles. ¡Listo para enviar por WhatsApp!', 'success');
                } catch (ex) {
                    modal.alert('No se pudo copiar automáticamente. Por favor, copia el siguiente texto manualmente:\n\n' + message, 'Error al Copiar', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            });
        }

// Función para escapar HTML y prevenir XSS
    function escapeHTML(unsafe) {
    if (typeof unsafe !== "string") {
        if (unsafe === null || unsafe === undefined) return "";
        return String(unsafe);
    }
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;")
        .trim();
}

            function renderAccounts(accounts) {
    const tbody = document.querySelector('#accountsTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">No hay cuentas registradas.</td></tr>';
        return;
    }

    accounts.forEach(account => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${escapeHTML(account.platform)}</td>
            <td>${escapeHTML(account.email)}</td>
            <td>${account.profiles.length}</td>
            <td>$${(account.pricePerProfile || 0).toFixed(2)}</td>
            <td>$${(account.fullAccountPrice || 0).toFixed(2)}</td>
            <td>
                <select class="form-control status-dropdown"
                        onchange="updateAccountStatus('${account.id}', this.value)">
                    <option value="Disponible" ${account.status === 'Disponible' ? 'selected' : ''}>Disponible</option>
                    <option value="Ocupado" ${account.status === 'Ocupado' ? 'selected' : ''}>Ocupado</option>
                    <option value="No disponible" ${account.status === 'No disponible' ? 'selected' : ''}>No disponible</option>
                    <option value="Renovar" ${account.status === 'Renovar' ? 'selected' : ''}>Renovar</option>
                </select>
            </td>
            <td>
                <button class="btn btn-sm" onclick="editAccount('${account.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-sm" onclick="deleteAccount('${account.id}')"><i class="fas fa-trash"></i></button>
                <button class="btn btn-secondary btn-sm" onclick="viewAccountDetails('${account.id}')"><i class="fas fa-eye"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Función para mostrar la sección de servicios (admin)
function renderServices() {
    const tbody = document.querySelector('#servicesTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (services.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No hay servicios registrados.</td></tr>';
        return;
    }

    services.forEach(service => {
        // Calcular perfiles disponibles para la plataforma del servicio
        const availableProfilesCount = accounts.filter(acc => 
            acc.platform === service.platform && acc.status === 'Disponible' && acc.profiles.some(p => p.available)
        ).reduce((sum, acc) => sum + acc.profiles.filter(p => p.available).length, 0);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><img src="${escapeHTML(service.imageUrl)}" alt="${escapeHTML(service.name)}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
            <td>${escapeHTML(service.name)}</td>
            <td>$${(service.price || 0).toFixed(2)}</td>
            <td>${escapeHTML(service.description.substring(0, 50))}...</td>
            <td>${availableProfilesCount}</td>
            <td>
                <button class="btn btn-sm" onclick="editService('${service.id}')" title="Editar" aria-label="Editar servicio ${escapeHTML(service.name)}" tabindex="0"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-sm" onclick="deleteService('${service.id}')" title="Eliminar" aria-label="Eliminar servicio ${escapeHTML(service.name)}" tabindex="0"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });
}



function editService(id) {
    openAddServiceModal(id);
}

async function deleteService(id) {
    const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar este servicio? Esta acción es irreversible.', 'Eliminar Servicio');
    if (confirmed) {
        try {
            await deleteFromFirebase('services', id);
            services = services.filter(s => s.id !== id);
            renderServices();
            modal.toast('Servicio eliminado correctamente.', 'success');
        } catch (error) {
            console.error('Error deleting service:', error);
            modal.toast(`Error al eliminar el servicio: ${error.message}`, 'error');
        }
    }
}

// Mostrar catálogo de servicios en portal cliente
function renderAvailableAccountsCatalog() {
    const catalogElement = document.getElementById('availableAccountsCatalog');
    if (!catalogElement) return;

    if (services.length === 0) {
        catalogElement.innerHTML = '<div class="no-data">No hay servicios disponibles en este momento.</div>';
        return;
    }

    catalogElement.innerHTML = '';

    services.forEach(service => {
        // Calcular perfiles disponibles para la plataforma del servicio
        const availableProfilesCount = accounts.filter(acc => 
            acc.platform === service.platform && acc.status === 'Disponible' && acc.profiles.some(p => p.available)
        ).reduce((sum, acc) => sum + acc.profiles.filter(p => p.available).length, 0);

        const card = document.createElement('div');
        card.className = 'account-card';
        card.innerHTML = `
            <img src="${escapeHTML(service.imageUrl)}" alt="${escapeHTML(service.name)}" style="width: 100%; height: 150px; object-fit: cover; border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;">
            <h3 style="margin-top: 15px;"><i class="fas fa-box" aria-hidden="true"></i> ${escapeHTML(service.name)}</h3>
            <p class="description">${escapeHTML(service.description)}</p>
            <p class="price">Precio: $${(service.price || 0).toFixed(2)}</p>
            <p class="description">Disponibles: ${availableProfilesCount} perfiles</p>
            <button class="btn btn-success buy-btn" ${availableProfilesCount === 0 ? 'disabled' : ''} onclick="openPurchaseModal('${service.id}')">
                <i class="fas fa-shopping-cart" aria-hidden="true"></i> ${availableProfilesCount === 0 ? 'Agotado' : 'Comprar Ahora'}
            </button>
        `;
        catalogElement.appendChild(card);
    });
}

// Abrir modal de compra para un servicio
async function openPurchaseModal(serviceId) {
    const service = services.find(s => s.id === serviceId);
    if (!service) {
        modal.alert('Servicio no encontrado.', 'Error', 'error');
        return;
    }

    // Buscar perfiles disponibles para la plataforma del servicio
    const availableProfiles = accounts.filter(acc => 
        acc.platform === service.platform && acc.status === 'Disponible' && acc.profiles.some(p => p.available)
    ).flatMap(acc => acc.profiles.filter(p => p.available));

    if (availableProfiles.length < service.profilesPerPurchase) {
        modal.alert(`No hay suficientes perfiles disponibles para ${service.name}.`, 'Agotado', 'warning');
        return;
    }

    const formConfig = {
        fields: [
            { type: 'html', value: `<p>Estás a punto de comprar <strong>${escapeHTML(service.name)}</strong>.</p>` },
            { type: 'html', value: `<p><strong>Descripción:</strong> ${escapeHTML(service.description)}</p>` },
            { type: 'html', value: `<p><strong>Precio:</strong> $${(service.price || 0).toFixed(2)}</p>` },
            { type: 'html', value: `<p><strong>Perfiles a asignar:</strong> ${service.profilesPerPurchase}</p>` },
            { type: 'hidden', name: 'profilesToBuy', value: service.profilesPerPurchase.toString() }
        ]
    };

    modal.form(formConfig, `Comprar ${service.name}`).then(async data => {
        if (data) {
            const profilesToBuy = parseInt(data.profilesToBuy);
            const totalCost = service.price;
            const clientData = webClients.find(u => u.id === currentUser .uid);

            if (!clientData || (clientData.balance || 0) < totalCost) {
                modal.alert(`Saldo insuficiente. Necesitas $${totalCost.toFixed(2)} y tienes $${(clientData?.balance || 0).toFixed(2)}.`, 'Saldo Insuficiente', 'error');
                return;
            }

            const confirmed = await modal.confirm(`Confirmar compra de ${service.name} por $${totalCost.toFixed(2)}?`, 'Confirmar Compra');
            if (!confirmed) return;

            await processPurchase(serviceId, profilesToBuy, totalCost);
        }
    });
}

// Procesar la compra: asignar perfiles, descontar saldo, crear venta
async function processPurchase(serviceId, profilesToBuy, totalCost) {
    if (isClaudeEnvironment) {
        modal.toast('Funcionalidad de compra no disponible en modo demo.', 'warning', 5000);
        return;
    }

    const service = services.find(s => s.id === serviceId);
    if (!service) {
        modal.toast('Error: Servicio no encontrado.', 'error');
        return;
    }

    const clientRef = db.collection('users').doc(currentUser .uid);
    const clientDoc = await clientRef.get();
    if (!clientDoc.exists) {
        modal.toast('Error: Cliente no encontrado.', 'error');
        return;
    }
    const clientData = clientDoc.data();

    if ((clientData.balance || 0) < totalCost) {
        modal.toast('Saldo insuficiente. Por favor, recarga tu saldo.', 'error');
        return;
    }

    // Buscar cuenta con suficientes perfiles disponibles
    let assignedAccount = null;
    let assignedProfiles = [];

    for (const acc of accounts) {
        if (acc.platform === service.platform && acc.status === 'Disponible') {
            const availableInThisAccount = acc.profiles.filter(p => p.available);
            if (availableInThisAccount.length >= profilesToBuy) {
                assignedAccount = acc;
                assignedProfiles = availableInThisAccount.slice(0, profilesToBuy);
                break;
            }
        }
    }

    if (!assignedAccount) {
        modal.toast('No se encontraron suficientes perfiles disponibles para este servicio.', 'warning');
        return;
    }

    // Descontar saldo cliente
    const newClientBalance = (clientData.balance || 0) - totalCost;
    await clientRef.update({ balance: newClientBalance });
    await clientRef.collection('transactions').add({
        type: 'Compra de Servicio',
        amount: -totalCost,
        comment: `Compra de ${service.name}`,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Crear venta
    const newSale = {
        clientId: currentUser .uid,
        accountId: assignedAccount.id,
        profilesCount: profilesToBuy,
        startDate: new Date().toISOString().split('T')[0],
        endDate: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0],
        total: totalCost,
        status: 'Activa',
        paid: true,
        isAutoPurchase: true,
        serviceId: serviceId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const saleRef = await db.collection('sales').add(newSale);
    const saleId = saleRef.id;

    // Actualizar perfiles asignados
    const updatedProfiles = assignedAccount.profiles.map(p => {
        const assigned = assignedProfiles.find(ap => ap.name === p.name && ap.pin === p.pin);
        if (assigned) {
            return { ...p, available: false, soldTo: currentUser .uid, saleId: saleId };
        }
        return p;
    });

    // Actualizar cuenta
    const newAccountStatus = updatedProfiles.some(p => p.available) ? 'Disponible' : 'Ocupado';
    await db.collection('accounts').doc(assignedAccount.id).update({
        profiles: updatedProfiles,
        status: newAccountStatus,
        totalEarned: (assignedAccount.totalEarned || 0) + totalCost
    });

    // Actualizar localmente para UI
    const accountIndex = accounts.findIndex(acc => acc.id === assignedAccount.id);
    if (accountIndex !== -1) {
        accounts[accountIndex].profiles = updatedProfiles;
        accounts[accountIndex].status = newAccountStatus;
        accounts[accountIndex].totalEarned = (accounts[accountIndex].totalEarned || 0) + totalCost;
    }
    sales.push({ id: saleId, ...newSale });

    modal.toast('Compra realizada con éxito!', 'success');
    await loadServices();
    await loadAccounts();
    renderAvailableAccountsCatalog();
    renderClientDashboard();
}




    

        // ============= SISTEMA DE MODALES =============
        class ModalManager {
            constructor() {
                this.activeModal = null;
                this.init();
                this.lastFocusedElement = null;
            }

            init() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.activeModal) {
                        this.close();
                    }
                });

                document.getElementById('modal-overlay').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-overlay') {
                        this.close();
                    }
                });
            }

            open(content, options = {}) {
                // Close any existing modal before opening a new one
                if (this.activeModal) {
                    this.close();
                }
                this.lastFocusedElement = document.activeElement;

                const modal = this.createModal(content, options);
                this.showModal(modal);
                activeModalInstance = this; // Set global instance
                return modal;
            }

            confirm(message, title = 'Confirmar') {
                return new Promise((resolve) => {
                    const content = `
                        <div class="modal-header">
                            <h3><i class="fas fa-question-circle" aria-hidden="true"></i> ${title}</h3>
                            <button class="modal-close" onclick="modal.close(); modal.resolveConfirm(false)" aria-label="Cerrar modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>${message}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modal.close(); modal.resolveConfirm(false)" tabindex="0">Cancelar</button>
                            <button class="btn btn-danger" onclick="modal.close(); modal.resolveConfirm(true)" tabindex="0">Confirmar</button>
                        </div>
                    `;

                    this.resolveConfirm = resolve;
                    this.open(content, { size: 'small' });
                });
            }

            toast(message, type = 'info', duration = 3000) {
                const toast = document.getElementById('toastNotification');
                const toastMessage = document.getElementById('toastMessage');
                const toastIcon = document.getElementById('toastIcon');

                toastMessage.textContent = message;
                toast.className = 'toast-notification show'; // Reset classes

                let iconClass = '';
                switch (type) {
                    case 'success':
                        iconClass = 'fas fa-check-circle';
                        toast.classList.add('success');
                        break;
                    case 'error':
                        iconClass = 'fas fa-times-circle';
                        toast.classList.add('error');
                        break;
                    case 'warning':
                        iconClass = 'fas fa-exclamation-triangle';
                        toast.classList.add('warning');
                        break;
                    default:
                        iconClass = 'fas fa-info-circle';
                        toast.classList.add('info');
                }
                toastIcon.className = iconClass;

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.remove('success', 'error', 'warning', 'info'); // Clean up classes
                }, duration);
            }

            alert(message, title = 'Información', type = 'info') {
                const icons = {
                    'info': 'fas fa-info-circle',
                    'success': 'fas fa-check-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'error': 'fas fa-times-circle'
                };

                const content = `
                    <div class="modal-header">
                        <h3><i class="${icons[type]}" aria-hidden="true"></i> ${title}</h3>
                        <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="modal.close()" tabindex="0">Aceptar</button>
                    </div>
                `;

                this.open(content, { size: 'small' });
            }

            form(config, title) {
                return new Promise((resolve) => {
                    let formHTML = `
                        <div class="modal-header">
                            <h3><i class="fas fa-edit" aria-hidden="true"></i> ${title}</h3>
                            <button class="modal-close" onclick="modal.close(); modal.resolveForm(null)" aria-label="Cerrar modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="modal-form" aria-label="${title}">
                    `;
                    
                    config.fields.forEach(field => {
                        formHTML += this.createFormField(field);
                    });
                    
                    formHTML += `
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modal.close(); modal.resolveForm(null)" tabindex="0">Cancelar</button>
                            <button class="btn" onclick="modal.submitForm()" tabindex="0">Enviar</button>
                        </div>
                    `;

                    this.resolveForm = resolve;
                    this.open(formHTML, { size: 'medium' });
                });
            }

            submitForm() {
                const form = document.getElementById('modal-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                this.close();
                this.resolveForm(data);
            }

            createFormField(field) {
                const { type, name, label, placeholder, required, options, value, min, max, step, onchange, id, className, disabled, accept, multiple, helpText } = field;
                
                let fieldHTML = `<div class="form-group">`;
                if (label) fieldHTML += `<label for="${id || name}">${label}${required ? ' <span aria-hidden="true">*</span>' : ''}</label>`;
                
                switch (type) {
                    case 'text':
                    case 'email':
                    case 'password':
                    case 'tel':
                    case 'number':
                    case 'date':
                        fieldHTML += `<input type="${type}" name="${name}" id="${id || name}" class="form-control ${className || ''}" placeholder="${placeholder || ''}" ${required ? 'required' : ''} value="${value !== undefined ? escapeHTML(value) : ''}" tabindex="0" aria-required="${required ? 'true' : 'false'}" ${min !== undefined ? `min="${min}"` : ''} ${max !== undefined ? `max="${max}"` : ''} ${step !== undefined ? `step="${step}"` : ''} ${onchange ? `onchange="${onchange}"` : ''} ${disabled ? 'disabled' : ''}>`;
                        break;
                    case 'textarea':
                        fieldHTML += `<textarea name="${name}" id="${id || name}" class="form-control ${className || ''}" rows="3" placeholder="${placeholder || ''}" ${required ? 'required' : ''} tabindex="0" aria-required="${required ? 'true' : 'false'}" ${onchange ? `onchange="${onchange}"` : ''} ${disabled ? 'disabled' : ''}>${value !== undefined ? escapeHTML(value) : ''}</textarea>`;
                        break;
                    case 'select':
                        fieldHTML += `<select name="${name}" id="${id || name}" class="form-control ${className || ''}" ${required ? 'required' : ''} tabindex="0" aria-required="${required ? 'true' : 'false'}" ${onchange ? `onchange="${onchange}"` : ''} ${disabled ? 'disabled' : ''}>`;
                        if (options) {
                            options.forEach(option => {
                                fieldHTML += `<option value="${escapeHTML(option.value)}" ${value == option.value ? 'selected' : ''}>${escapeHTML(option.text)}</option>`;
                            });
                        }
                        fieldHTML += `</select>`;
                        break;
                    case 'file':
                        fieldHTML += `<input type="file" name="${name}" id="${id || name}" class="form-control ${className || ''}" ${required ? 'required' : ''} tabindex="0" aria-required="${required ? 'true' : 'false'}" ${onchange ? `onchange="${onchange}"` : ''} ${disabled ? 'disabled' : ''} ${accept ? `accept="${accept}"` : ''} ${multiple ? 'multiple' : ''}>`;
                        break;
                    case 'html': // For custom HTML content within a form group
                        fieldHTML += value;
                        break;
                }
                if (helpText) {
                    fieldHTML += `<small class="form-text">${helpText}</small>`;
                }
                fieldHTML += `</div>`;
                return fieldHTML;
            }

            createModal(content, options = {}) {
                const { size = 'medium' } = options;
                
                const modal = document.createElement('div');
                modal.className = `modal modal-${size}`;
                modal.setAttribute('role', 'dialog');
                modal.setAttribute('aria-modal', 'true');
                modal.setAttribute('aria-labelledby', 'modal-title');
                modal.innerHTML = `
                    <div class="modal-content">
                        ${content}
                    </div>
                `;

                return modal;
            }

            showModal(modal) {
                this.activeModal = modal;
                const overlay = document.getElementById('modal-overlay');
                
                overlay.appendChild(modal);
                overlay.classList.add('active');
                document.body.classList.add('modal-open');

                // Add a slight delay to ensure the modal is rendered before focusing
                setTimeout(() => {
                    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const firstFocusableElement = focusableElements[0];
                    if (firstFocusableElement) {
                        firstFocusableElement.focus();
                    }
                }, 50); // Small delay
            }

            close() {
                if (!this.activeModal) return;

                this.activeModal.classList.remove('modal-show');
                
                setTimeout(() => {
                    if (this.activeModal && this.activeModal.parentNode) {
                        this.activeModal.parentNode.removeChild(this.activeModal);
                    }
                    this.activeModal = null;
                    activeModalInstance = null; // Clear global instance
                    
                    const overlay = document.getElementById('modal-overlay');
                    overlay.classList.remove('active');
                    document.body.classList.remove('modal-open');

                    if (this.lastFocusedElement) {
                        this.lastFocusedElement.focus();
                        this.lastFocusedElement = null;
                    }
                }, 300);
            }
        }
        

        const modal = new ModalManager();

        

        // ============= SISTEMA FINANCIERO (ADMIN) =============
        class FinancialManager {
            constructor() {
                this.expenses = [];
                // Expenses are loaded via loadData() and loadExpensesFromFirebase()
            }

            calculateFinancialMetrics() {
                const metrics = {
                    totalInvestment: 0,
                    totalRevenue: 0,
                    totalExpenses: 0,
                    netProfit: 0,
                    averageROI: 0
                };

                accounts.forEach(account => {
                    metrics.totalInvestment += parseFloat(account.acquisitionCost) || 0;
                    
                    // Ensure totalEarned is calculated based on current sales data
                    const accountSales = sales.filter(sale => sale.accountId === account.id);
                    const accountRevenue = accountSales.reduce((sum, sale) => sum + parseFloat(sale.total), 0);
                    account.totalEarned = accountRevenue; // Update account's totalEarned
                });

                metrics.totalRevenue = sales.reduce((sum, sale) => sum + parseFloat(sale.total), 0);

                metrics.totalExpenses = this.expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                
                metrics.netProfit = metrics.totalRevenue - metrics.totalInvestment - metrics.totalExpenses;
                
                if (metrics.totalInvestment > 0) {
                    metrics.averageROI = ((metrics.netProfit / metrics.totalInvestment) * 100);
                }

                return metrics;
            }

            updateFinancialDashboard() {
                const metrics = this.calculateFinancialMetrics();
                
                this.updateElement('netProfit', `$${metrics.netProfit.toFixed(2)}`);
                this.updateElement('totalInvestment', `$${metrics.totalInvestment.toFixed(2)}`);
                this.updateElement('financialTotalRevenue', `$${metrics.totalRevenue.toFixed(2)}`);
                this.updateElement('averageROI', `${metrics.averageROI.toFixed(1)}%`);

                this.updateTopPerformingAccounts();
                this.updateUpcomingRenewals();
                this.updateGeneralSummary();
                this.renderFinancialAccountsTable();
                this.renderExpensesTable();
                this.updateExpensesSummary();
            }

            updateElement(id, content) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = content;
                }
            }

            getTopPerformingAccounts(limit = 5) {
                return accounts
                    .map(account => ({
                        ...account,
                        profit: (account.totalEarned || 0) - (parseFloat(account.acquisitionCost) || 0),
                        roi: (parseFloat(account.acquisitionCost) || 0) > 0 ? 
                            (((account.totalEarned || 0) - (parseFloat(account.acquisitionCost) || 0)) / (parseFloat(account.acquisitionCost) || 0) * 100) : 0
                    }))
                    .sort((a, b) => b.profit - a.profit)
                    .slice(0, limit);
            }

            getLosingAccounts() {
                return accounts
                    .map(account => ({
                        ...account,
                        profit: (account.totalEarned || 0) - (parseFloat(account.acquisitionCost) || 0)
                    }))
                    .filter(account => account.profit < 0)
                    .sort((a, b) => a.profit - b.profit);
            }

            updateTopPerformingAccounts() {
                const topAccounts = this.getTopPerformingAccounts(3);
                const container = document.getElementById('topProfitableAccounts');
                
                if (!container) return;

                if (topAccounts.length === 0 || topAccounts.every(acc => acc.profit === 0)) {
                    container.innerHTML = '<div class="no-data"><i class="fas fa-info-circle" aria-hidden="true"></i> Agrega cuentas con costos para ver análisis</div>';
                    return;
                }

                container.innerHTML = topAccounts.map(account => `
                    <div class="account-profit-item">
                        <div>
                            <strong><i class="fas fa-play-circle" aria-hidden="true"></i> ${escapeHTML(account.platform)}</strong><br>
                            <small>${escapeHTML(account.email)}</small>
                        </div>
                        <div class="profit-info">
                            <div class="profit">$${account.profit.toFixed(2)}</div>
                            <div class="roi">${account.roi.toFixed(1)}% ROI</div>
                        </div>
                    </div>
                `).join('');

                const losingAccounts = this.getLosingAccounts();
                const losingContainer = document.getElementById('losingAccounts');
                
                if (!losingContainer) return;
                
                if (losingAccounts.length === 0) {
                    losingContainer.innerHTML = '<div class="no-data"><i class="fas fa-check-circle" aria-hidden="true"></i> ¡Todas las cuentas son rentables!</div>';
                } else {
                    losingContainer.innerHTML = losingAccounts.map(account => `
                        <div class="account-profit-item loss">
                            <div>
                                <strong><i class="fas fa-play-circle" aria-hidden="true"></i> ${escapeHTML(account.platform)}</strong><br>
                                <small>${escapeHTML(account.email)}</small>
                            </div>
                            <div class="loss-info">
                                <div class="loss">-$${Math.abs(account.profit).toFixed(2)}</div>
                                <div class="status">Pérdida</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            getUpcomingRenewals(days = 30) {
                const now = new Date();
                
                return accounts
                    .filter(account => account.renewalDate)
                    .map(account => ({
                        ...account,
                        daysUntilRenewal: Math.ceil((new Date(account.renewalDate) - now) / (1000 * 60 * 60 * 24))
                    }))
                    .filter(account => account.daysUntilRenewal <= days && account.daysUntilRenewal >= 0)
                    .sort((a, b) => a.daysUntilRenewal - b.daysUntilRenewal);
            }

            updateUpcomingRenewals() {
                const renewals = this.getUpcomingRenewals();
                const container = document.getElementById('upcomingRenewals');
                
                if (!container) return;
                
                if (renewals.length === 0) {
                    container.innerHTML = '<div class="no-data"><i class="fas fa-calendar-check" aria-hidden="true"></i> No hay renovaciones próximas</div>';
                    return;
                }

                container.innerHTML = renewals.map(renewal => `
                    <div class="renewal-item ${renewal.daysUntilRenewal <= 3 ? 'urgent' : ''}">
                        <div>
                            <strong><i class="fas fa-play-circle" aria-hidden="true"></i> ${escapeHTML(renewal.platform)}</strong><br>
                            <small>${escapeHTML(renewal.email)}</small>
                        </div>
                        <div class="renewal-info">
                            <div class="cost">$${parseFloat(renewal.renewalCost || 0).toFixed(2)}</div>
                            <div class="days">${renewal.daysUntilRenewal} días</div>
                        </div>
                    </div>
                `).join('');
            }

            updateGeneralSummary() {
                const container = document.getElementById('generalSummary');
                if (!container) return;

                const totalAccounts = accounts.length;
                const rentableAccounts = accounts.filter(acc => 
                    (acc.totalEarned || 0) > (parseFloat(acc.acquisitionCost) || 0)
                ).length;
                const totalClients = clients.length + webClients.length; // All registered users
                const totalSales = sales.length;
                const activeSales = sales.filter(sale => sale.status === 'Activa').length;

                container.innerHTML = `
                    <div class="summary-stats">
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-tv" aria-hidden="true"></i> Total de cuentas:</span>
                            <span class="value">${totalAccounts}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-chart-line" aria-hidden="true"></i> Cuentas rentables:</span>
                            <span class="value">${rentableAccounts}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-users" aria-hidden="true"></i> Total de clientes:</span>
                            <span class="value">${totalClients}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-shopping-cart" aria-hidden="true"></i> Ventas realizadas:</span>
                            <span class="value">${totalSales}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label"><i class="fas fa-check-circle" aria-hidden="true"></i> Ventas activas:</span>
                            <span class="value">${activeSales}</span>
                        </div>
                    </div>
                `;
            }

            showFinanceTab(tabName, event) {
                document.querySelectorAll('.finance-tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.setAttribute('hidden', 'true');
                });
                
                document.querySelectorAll('.finance-tabs .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                
                const targetTab = document.getElementById(`finance-${tabName}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                    targetTab.removeAttribute('hidden');
                }
                
                const clickedButton = event.currentTarget; 
                if (clickedButton) {
                    clickedButton.classList.add('active');
                    clickedButton.setAttribute('aria-selected', 'true');
                }
                
                switch(tabName) {
                    case 'accounts':
                        this.renderFinancialAccountsTable();
                        break;
                    case 'expenses':
                        this.renderExpensesTable();
                        this.updateExpensesSummary();
                        break;
                    case 'overview':
                        this.updateTopPerformingAccounts();
                        this.updateUpcomingRenewals();
                        this.updateGeneralSummary();
                        break;
                    case 'reports':
                        break;
                }
            }

            renderFinancialAccountsTable() {
                const tbody = document.querySelector('#financialAccountsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                accounts.forEach(account => {
                    const totalEarned = account.totalEarned || 0;
                    const acquisitionCost = parseFloat(account.acquisitionCost) || 0;
                    const profit = totalEarned - acquisitionCost;
                    const roi = acquisitionCost > 0 ? ((profit / acquisitionCost) * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><i class="fas fa-play-circle" aria-hidden="true"></i> ${escapeHTML(account.platform)}</td>
                        <td>${escapeHTML(account.email)}</td>
                        <td>$${acquisitionCost.toFixed(2)}</td>
                        <td>$${totalEarned.toFixed(2)}</td>
                        <td class="${profit >= 0 ? 'profit' : 'loss'}">$${profit.toFixed(2)}</td>
                        <td class="${roi >= 0 ? 'positive' : 'negative'}">${roi.toFixed(1)}%</td>
                        <td>
                            <span class="status-badge ${profit >= 0 ? 'available' : 'unavailable'}">
                                ${profit >= 0 ? 'Rentable' : 'Con pérdida'}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            openAddExpenseModal() {
                const formConfig = {
                    fields: [
                        {
                            type: 'select',
                            name: 'type',
                            label: 'Tipo de Gasto',
                            required: true,
                            options: [
                                { value: '', text: 'Seleccionar tipo...' },
                                { value: 'renewal', text: 'Renovación de cuenta' },
                                { value: 'acquisition', text: 'Compra de cuenta nueva' },
                                { value: 'operational', text: 'Gasto operacional' },
                                { value: 'other', text: 'Otros' }
                            ]
                        },
                        { type: 'text', name: 'description', label: 'Descripción', required: true },
                        { type: 'number', name: 'amount', label: 'Monto ($)', required: true, placeholder: '0.00', step: '0.01', min: '0' },
                        { type: 'date', name: 'date', label: 'Fecha', required: true, value: new Date().toISOString().split('T')[0] },
                        { type: 'text', name: 'category', label: 'Categoría', placeholder: 'Ej: Suscripciones, Herramientas, etc.' }
                    ]
                };

                modal.form(formConfig, 'Agregar Nuevo Gasto').then(async data => {
                    if (data) {
                        await this.addExpense(data);
                    }
                });
            }

            async addExpense(expenseData) {
                const description = sanitizeInput(expenseData.description);
                const category = sanitizeInput(expenseData.category || 'General');

                const expense = {
                    id: Date.now().toString(),
                    type: expenseData.type,
                    description: description,
                    amount: parseFloat(expenseData.amount),
                    date: expenseData.date,
                    category: category,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                this.expenses.push(expense);
                
                try {
                    await db.collection('expenses').doc(expense.id).set(expense);
                    modal.toast('Gasto agregado correctamente', 'success');
                } catch (error) {
                    console.error('Error saving expense to Firebase:', error);
                    modal.toast('Error al guardar el gasto en la nube.', 'error');
                }

                this.renderExpensesTable();
                this.updateExpensesSummary();
                this.updateFinancialDashboard();
            }

            async loadExpensesFromFirebase() {
                if (db) {
                    try {
                        const expensesSnapshot = await db.collection('expenses').orderBy('createdAt', 'desc').get();
                        this.expenses = [];
                        expensesSnapshot.forEach((doc) => {
                            this.expenses.push({ id: doc.id, ...doc.data() });
                        });
                        console.log('✅ Gastos cargados desde Firebase correctamente.');
                    } catch (error) {
                        console.error('❌ Error al cargar gastos desde Firebase:', error);
                        modal.toast('Error al cargar gastos desde la nube.', 'error');
                    }
                }
            }

            renderExpensesTable() {
    const tbody = document.querySelector('#expensesTable tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    // Función segura para normalizar la fecha
    function normalizeDate(value) {
        if (!value) return new Date(0); // fecha mínima
        if (typeof value.toDate === "function") return value.toDate(); // Timestamp de Firestore
        if (typeof value === "string" || typeof value === "number") return new Date(value);
        return new Date(0);
    }

    const sortedExpenses = this.expenses.sort(
        (a, b) => normalizeDate(b.createdAt) - normalizeDate(a.createdAt)
    );

    if (sortedExpenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No hay gastos registrados.</td></tr>';
        return;
    }

    sortedExpenses.forEach(expense => {
        const row = document.createElement('tr');
        const createdAtDate = normalizeDate(expense.createdAt);

        row.innerHTML = `
            <td>${createdAtDate.toLocaleDateString()}</td>
            <td>${escapeHTML(expense.description || "")}</td>
            <td>$${(expense.amount || 0).toFixed(2)}</td>
            <td><span class="status-badge">${escapeHTML(expense.category || "Sin categoría")}</span></td>
            <td>
                <button class="btn btn-danger btn-sm" 
                        onclick="financialManager.deleteExpense('${expense.id}')"
                        aria-label="Eliminar gasto ${escapeHTML(expense.description || "")}" 
                        tabindex="0">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}


            updateExpensesSummary() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const monthlyExpenses = this.expenses.filter(expense => {
        const expenseDate = normalizeDate(expense.createdAt);
        return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
    }).reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);

    const yearlyExpenses = this.expenses.filter(expense => {
        const expenseDate = normalizeDate(expense.createdAt);
        return expenseDate.getFullYear() === currentYear;
    }).reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);

    this.updateElement('monthlyExpenses', `$${monthlyExpenses.toFixed(2)}`);
    this.updateElement('yearlyExpenses', `$${yearlyExpenses.toFixed(2)}`);
}


            async deleteExpense(id) {
                const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar este gasto?');
                if (confirmed) {
                    try {
                        this.expenses = this.expenses.filter(expense => expense.id !== id);
                        await db.collection('expenses').doc(id).delete();
                        this.renderExpensesTable();
                        this.updateExpensesSummary();
                        this.updateFinancialDashboard();
                        modal.toast('Gasto eliminado correctamente', 'success');
                    } catch (error) {
                        console.error('Error deleting expense:', error);
                        modal.toast(`Error al eliminar el gasto: ${error.message}`, 'error');
                    }
                }
            }

            generateMonthlyReport() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const monthSales = sales.filter(sale => {
        const saleDate = new Date(sale.startDate);
        return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
    });

    const monthlyRevenue = monthSales.reduce((sum, sale) => sum + parseFloat(sale.total || 0), 0);

    const monthlyExpenses = this.expenses.filter(expense => {
        const expenseDate = normalizeDate(expense.createdAt);
        return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
    }).reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);

    const monthlyNetProfit = monthlyRevenue - monthlyExpenses;

    const activeAccounts = accounts.filter(acc => acc.status === 'Disponible').length;
    const occupiedAccounts = accounts.filter(acc => acc.status === 'Ocupado').length;
    const unavailableAccounts = accounts.filter(acc => acc.status === 'No disponible').length;

    const reportContent = `
        <p><strong>Mes:</strong> ${new Date(currentYear, currentMonth).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</p>
        <p><strong>Ingresos Totales:</strong> $${monthlyRevenue.toFixed(2)}</p>
        <p><strong>Gastos Totales:</strong> $${monthlyExpenses.toFixed(2)}</p>
        <p><strong>Ganancia Neta:</strong> $${monthlyNetProfit.toFixed(2)}</p>
        <br>
        <p><strong>Cuentas Disponibles:</strong> ${activeAccounts}</p>
        <p><strong>Cuentas Ocupadas:</strong> ${occupiedAccounts}</p>
        <p><strong>Cuentas No Disponibles:</strong> ${unavailableAccounts}</p>
    `;

    modal.alert(reportContent, 'Reporte Mensual', 'info');
}


            generateAccountReport() {
                modal.alert('Generando reporte por cuentas... (Funcionalidad en desarrollo)', 'Reporte por Cuentas', 'info');
            }
        }

        // ============= GESTIÓN DE USUARIOS (ADMIN) =============
        class UserManager {
            constructor() {
                this.allUsers = []; // All users from Firestore 'users' collection
                this.filteredUsers = []; // Users after search/sort
            }

            async loadAllUsers() {
                if (!db || (currentUser && currentUser.uid !== ADMIN_UID && !isClaudeEnvironment)) {
                    console.warn('⚠️ Solo el administrador puede cargar todos los usuarios.');
                    return;
                }
                try {
                    const usersSnapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                    this.allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.filterAndSortUsers(); // Apply initial filter/sort
                    console.log('✅ Usuarios cargados desde Firebase correctamente.');
                } catch (error) {
                    console.error('❌ Error al cargar usuarios desde Firebase:', error);
                    modal.toast('Error al cargar usuarios desde la nube.', 'error');
                }
            }

            showWebClientTab(tabName, event) {
                document.querySelectorAll('#webClients .finance-tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.setAttribute('hidden', 'true');
                });
                
                document.querySelectorAll('#webClients .finance-tabs .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                
                const targetTab = document.getElementById(`web-clients-${tabName}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                    targetTab.removeAttribute('hidden');
                }
                
                const clickedButton = event.currentTarget; 
                if (clickedButton) {
                    clickedButton.classList.add('active');
                    clickedButton.setAttribute('aria-selected', 'true');
                }

                this.renderAllUsersTable();
            }

            filterAndSortUsers() {
                const searchTerm = document.getElementById('clientSearchInput').value.toLowerCase();
                const sortBy = document.getElementById('clientSortBy').value;
                const sortOrder = document.getElementById('clientSortOrder').value;

                this.filteredUsers = this.allUsers.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.lastName && user.lastName.toLowerCase().includes(searchTerm))
                );

                this.filteredUsers.sort((a, b) => {
                    let valA, valB;
                    if (sortBy === 'balance') {
                        valA = a.balance || 0;
                        valB = b.balance || 0;
                    } else if (sortBy === 'createdAt') {
                        valA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                        valB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                    } else {
                        valA = a[sortBy]?.toLowerCase() || '';
                        valB = b[sortBy]?.toLowerCase() || '';
                    }

                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                this.renderAllUsersTable();
            }

            renderAllUsersTable() {
                const tbody = document.querySelector('#allClientsTable tbody');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (this.filteredUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">No hay usuarios registrados que coincidan con la búsqueda.</td></tr>';
                    return;
                }

                this.filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${escapeHTML(user.name)} ${escapeHTML(user.lastName || '')}</td>
                        <td>${escapeHTML(user.email)}</td>
                        <td>$${(user.balance || 0).toFixed(2)}</td>
                        <td>${(user.createdAt?.toDate ? user.createdAt.toDate() : new Date(user.createdAt)).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="webClientManager.openBalanceModal('${user.id}')" title="Gestionar Saldo" aria-label="Gestionar saldo de ${escapeHTML(user.name)}" tabindex="0"><i class="fas fa-wallet" aria-hidden="true"></i></button>
                            <button class="btn btn-info btn-sm" onclick="webClientManager.viewBalanceHistory('${user.id}')" title="Ver Historial" aria-label="Ver historial de saldo de ${escapeHTML(user.name)}" tabindex="0"><i class="fas fa-history" aria-hidden="true"></i></button>
                            <button class="btn btn-warning btn-sm" onclick="webClientManager.resetUserPassword('${user.id}', '${user.email}')" title="Resetear Contraseña" aria-label="Resetear contraseña de ${escapeHTML(user.name)}" tabindex="0"><i class="fas fa-key" aria-hidden="true"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="webClientManager.deleteUser('${user.id}', '${user.email}')" title="Eliminar Usuario" aria-label="Eliminar usuario ${escapeHTML(user.name)}" tabindex="0"><i class="fas fa-trash" aria-hidden="true"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            openBalanceModal(userId) {
                const user = this.allUsers.find(u => u.id === userId);
                if (!user) return;

                const formConfig = {
                    fields: [
                        { type: 'number', name: 'amount', label: 'Monto ($)', required: true, placeholder: '0.00', step: '0.01' },
                        { 
                            type: 'select', 
                            name: 'type', 
                            label: 'Tipo de Transacción', 
                            required: true, 
                            options: [
                                { value: 'add', text: 'Agregar Saldo' },
                                { value: 'subtract', text: 'Quitar Saldo' }
                            ]
                        },
                        { type: 'textarea', name: 'comment', label: 'Comentario (opcional)', placeholder: 'Motivo de la transacción...' }
                    ]
                };

                modal.form(formConfig, `Gestionar Saldo de ${user.name}`).then(async data => {
                    if (data) {
                        const amount = parseFloat(data.amount);
                        const type = data.type;
                        const comment = sanitizeInput(data.comment || '');

                        if (isNaN(amount) || amount <= 0) {
                            modal.alert('El monto debe ser un número positivo.', 'Error de Monto', 'error');
                            return;
                        }
                        await this.updateUserBalance(userId, amount, type, comment);
                    }
                });
            }

            async updateUserBalance(userId, amount, type, comment) {
                if (isClaudeEnvironment) {
                    modal.toast('Funcionalidad no disponible en modo demo para la gestión de saldo.', 'warning');
                    return;
                }

                const userRef = db.collection('users').doc(userId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    modal.toast('Usuario no encontrado.', 'error');
                    return;
                }

                const userData = userDoc.data();
                let newBalance = userData.balance || 0;
                let transactionAmount = amount;
                let transactionType = type === 'add' ? 'Recarga' : 'Ajuste Negativo';

                if (type === 'add') {
                    newBalance += amount;
                } else if (type === 'subtract') {
                    newBalance -= amount;
                    transactionAmount = -amount;
                }

                if (newBalance < 0) {
                    modal.alert('El saldo no puede ser negativo.', 'Error de Saldo', 'error');
                    return;
                }

                try {
                    await userRef.update({ balance: newBalance });
                    await db.collection('users').doc(userId).collection('transactions').add({
                        type: transactionType,
                        amount: transactionAmount,
                        comment: comment,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    modal.toast(`Saldo de ${userData.name} actualizado a $${newBalance.toFixed(2)}.`, 'success');
                    await this.loadAllUsers(); // Reload users to update table
                } catch (error) {
                    console.error('Error updating user balance:', error);
                    modal.toast(`Error al actualizar saldo: ${error.message}`, 'error');
                }
            }

            async viewBalanceHistory(userId) {
                const user = this.allUsers.find(u => u.id === userId);
                if (!user) return;

                let historyHtml = `
                    <div class="modal-header">
                        <h3><i class="fas fa-history" aria-hidden="true"></i> Historial de Transacciones de ${escapeHTML(user.name)}</h3>
                        <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Saldo Actual:</strong> $${(user.balance || 0).toFixed(2)}</p>
                        <hr>
                        <div class="balance-history-list">
                `;

                if (isClaudeEnvironment) {
                    historyHtml += '<div class="no-data">Historial de transacciones no disponible en modo demo.</div>';
                } else {
                    try {
                        const transactionsSnapshot = await db.collection('users').doc(userId).collection('transactions').orderBy('createdAt', 'desc').get();
                        const transactions = transactionsSnapshot.docs.map(doc => doc.data());

                        if (transactions.length === 0) {
                            historyHtml += '<div class="no-data">No hay movimientos de saldo registrados.</div>';
                        } else {
                            transactions.forEach(entry => {
                                const amountClass = entry.amount >= 0 ? 'positive' : 'negative';
                                historyHtml += `
                                    <div class="balance-history-item">
                                        <div>
                                            <span class="amount ${amountClass}">${entry.amount >= 0 ? '+' : ''}$${entry.amount.toFixed(2)}</span>
                                            <br>
                                            <span class="date">${(entry.createdAt?.toDate() || new Date()).toLocaleString()}</span>
                                        </div>
                                        <div class="comment">${escapeHTML(entry.comment || entry.type || 'Sin comentario')}</div>
                                    </div>
                                `;
                            });
                        }
                    } catch (error) {
                        console.error('Error fetching transactions:', error);
                        historyHtml += '<div class="no-data">Error al cargar el historial de transacciones.</div>';
                    }
                }

                historyHtml += `
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="modal.close()" tabindex="0">Cerrar</button>
                    </div>
                `;

                modal.open(historyHtml, { size: 'medium' });
            }

            async deleteUser(userId, userEmail) {
                if (isClaudeEnvironment) {
                    modal.toast('Funcionalidad no disponible en modo demo para eliminar usuarios.', 'warning');
                    return;
                }

                const confirmed = await modal.confirm(`¿Estás seguro de que deseas eliminar al usuario ${userEmail}? Esto eliminará su cuenta de Firebase Authentication y todos sus datos en Firestore (saldo, transacciones, etc.). Esta acción es irreversible.`, 'Confirmar Eliminación de Usuario');
                if (confirmed) {
                    try {
                        // 1. Delete user from Firebase Authentication
                        // This requires a Cloud Function as direct client-side deletion of other users is not allowed.
                        // For demo purposes, we'll simulate or skip this if Cloud Function is not deployed.
                        // If you have a Cloud Function named 'deleteUser' deployed:
                        // const deleteAuthUser = firebase.functions().httpsCallable('deleteUser');
                        // await deleteAuthUser({ uid: userId });
                        // If not, you'll need to manually delete from Firebase Auth console or deploy the function.
                        modal.toast('Eliminación de usuario de Firebase Auth requiere Cloud Function. Si no la tienes, elimina manualmente desde la consola de Firebase Auth.', 'warning', 8000);

                        // 2. Delete user document from Firestore
                        await db.collection('users').doc(userId).delete();

                        // 3. Delete all subcollection documents (transactions)
                        const transactionsRef = db.collection('users').doc(userId).collection('transactions');
                        const transactionsSnapshot = await transactionsRef.get();
                        const batch = db.batch();
                        transactionsSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        modal.toast(`Usuario ${userEmail} eliminado correctamente de Firestore.`, 'success');
                        await this.loadAllUsers(); // Reload users to update table
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        let errorMessage = 'Error al eliminar el usuario.';
                        if (error.code === 'functions/not-found') {
                            errorMessage += ' Asegúrate de haber desplegado la función de Cloud Functions `deleteUser`.';
                        } else {
                            errorMessage += ` ${error.message}`;
                        }
                        modal.toast(errorMessage, 'error');
                    }
                }
            }

            async resetUserPassword(userId, userEmail) {
                if (isClaudeEnvironment) {
                    modal.toast('Funcionalidad no disponible en modo demo para resetear contraseñas.', 'warning');
                    return;
                }

                const confirmed = await modal.confirm(`¿Estás seguro de que deseas resetear la contraseña de ${userEmail}? Se enviará un email de restablecimiento de contraseña al usuario.`, 'Resetear Contraseña');
                if (confirmed) {
                    try {
                        await firebase.auth().sendPasswordResetEmail(userEmail);
                        modal.toast(`Se ha enviado un email de restablecimiento de contraseña a ${userEmail}.`, 'success');
                    } catch (error) {
                        console.error('Error resetting password:', error);
                        let errorMessage = 'Error al resetear la contraseña.';
                        if (error.code === 'auth/user-not-found') {
                            errorMessage = 'Usuario no encontrado. Verifica el email.';
                        } else {
                            errorMessage += ` ${error.message}`;
                        }
                        modal.toast(errorMessage, 'error');
                    }
                }
            }

            async exportUsersToCsv() {
                if (this.allUsers.length === 0) {
                    modal.alert('No hay usuarios para exportar.', 'Advertencia', 'warning');
                    return;
                }

                const headers = ['UID', 'Nombre', 'Apellido', 'Email', 'Teléfono', 'Saldo', 'Fecha Registro'];
                const rows = this.allUsers.map(user => [
                    user.id,
                    user.name,
                    user.lastName || '',
                    user.email,
                    user.phone || '',
                    (user.balance || 0).toFixed(2),
                    (user.createdAt?.toDate ? user.createdAt.toDate() : new Date(user.createdAt)).toISOString()
                ]);

                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'usuarios_export.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                modal.toast('Usuarios exportados a CSV correctamente.', 'success');
            }

            async exportDatabaseToJson() {
                if (!db && !isClaudeEnvironment) {
                    modal.alert('Firebase no está inicializado.', 'Error', 'error');
                    return;
                }

                try {
                    const data = {};
                    const collections = ['accounts', 'clients', 'sales', 'expenses', 'users', 'rechargeRequests']; // Add other collections if needed

                    for (const collectionName of collections) {
                        data[collectionName] = [];
                        let snapshot;
                        if (isClaudeEnvironment) {
                            // In demo mode, use local arrays
                            switch(collectionName) {
                                case 'accounts': snapshot = accounts; break;
                                case 'clients': snapshot = clients; break;
                                case 'sales': snapshot = sales; break;
                                case 'expenses': snapshot = financialManager.expenses; break;
                                case 'users': snapshot = webClients; break;
                                case 'rechargeRequests': snapshot = rechargeRequests; break;
                                default: snapshot = [];
                            }
                            snapshot.forEach(docData => {
                                const clonedData = JSON.parse(JSON.stringify(docData)); // Deep clone
                                // Convert Date objects to ISO strings for JSON export
                                for (const key in clonedData) {
                                    if (clonedData[key] instanceof Date) {
                                        clonedData[key] = clonedData[key].toISOString();
                                    }
                                }
                                data[collectionName].push(clonedData);
                            });
                        } else {
                            snapshot = await db.collection(collectionName).get();
                            for (const doc of snapshot.docs) {
                                const docData = doc.data();
                                // Convert Timestamps to ISO strings for JSON export
                                for (const key in docData) {
                                    if (docData[key] && typeof docData[key].toDate === 'function') {
                                        docData[key] = docData[key].toDate().toISOString();
                                    }
                                }
                                data[collectionName].push({ id: doc.id, ...docData });

                                // If it's the 'users' collection, also export subcollections (e.g., 'transactions')
                                if (collectionName === 'users') {
                                    const subCollections = ['transactions']; // Add other subcollections if needed
                                    for (const subColName of subCollections) {
                                        const subColSnapshot = await db.collection(collectionName).doc(doc.id).collection(subColName).get();
                                        if (!docData[subColName]) {
                                            docData[subColName] = [];
                                        }
                                        for (const subDoc of subColSnapshot.docs) {
                                            const subDocData = subDoc.data();
                                            for (const key in subDocData) {
                                                if (subDocData[key] && typeof subDocData[key].toDate === 'function') {
                                                    subDocData[key] = subDocData[key].toDate().toISOString();
                                                }
                                            }
                                            docData[subColName].push({ id: subDoc.id, ...subDocData });
                                        }
                                    }
                                }
                            }
                        }
                    }

                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;'});
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', 'database_export.json');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    modal.toast('Base de datos exportada a JSON correctamente.', 'success');

                        } catch (error) {
                            console.error('Error exporting database:', error);
                            modal.toast(`Error al exportar la base de datos: ${error.message}`, 'error');
                        }
            }

            async importDatabaseFromJson(event) {
                const file = event.target.files[0];
                if (!file) return;

                const confirmed = await modal.confirm('Importar una base de datos sobrescribirá los datos existentes. ¿Estás seguro de continuar? Esta acción es irreversible.', 'Confirmar Importación');
                if (!confirmed) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (isClaudeEnvironment) {
                            // In demo mode, directly update local arrays
                            accounts = importedData.accounts || [];
                            clients = importedData.clients || [];
                            sales = importedData.sales || [];
                            financialManager.expenses = importedData.expenses || [];
                            webClients = importedData.users || [];
                            rechargeRequests = importedData.rechargeRequests || [];
                            modal.toast('Base de datos importada en modo demo correctamente.', 'success');
                            await loadData(); // Re-render UI
                        } else {
                            const batch = db.batch();

                            // For a true "overwrite", you'd need to fetch all docs and batch.delete() them first.
                            // This example merges, which is safer but might leave old data if not careful.
                            // For full overwrite, implement a delete all function for each collection.

                            for (const collectionName in importedData) {
                                if (Array.isArray(importedData[collectionName])) {
                                    for (const docData of importedData[collectionName]) {
                                        const docId = docData.id;
                                        const dataToSet = { ...docData };
                                        delete dataToSet.id; // Remove id from data to be set

                                        // Convert ISO strings back to Timestamps
                                        for (const key in dataToSet) {
                                            if (typeof dataToSet[key] === 'string' && dataToSet[key].match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                                                dataToSet[key] = firebase.firestore.Timestamp.fromDate(new Date(dataToSet[key]));
                                            }
                                        }

                                        // Handle subcollections (e.g., 'transactions' for 'users')
                                        if (collectionName === 'users' && dataToSet.transactions) {
                                            const transactions = dataToSet.transactions;
                                            delete dataToSet.transactions; // Remove from main doc data

                                            // Set main user document
                                            batch.set(db.collection(collectionName).doc(docId), dataToSet, { merge: true });

                                            // Set subcollection documents
                                            for (const transaction of transactions) {
                                                const transactionId = transaction.id;
                                                const transactionData = { ...transaction };
                                                delete transactionData.id;
                                                for (const key in transactionData) {
                                                    if (typeof transactionData[key] === 'string' && transactionData[key].match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                                                        transactionData[key] = firebase.firestore.Timestamp.fromDate(new Date(transactionData[key]));
                                                    }
                                                    // Ensure createdAt is a Timestamp if it's a string
                                                    if (typeof transactionData.createdAt === 'string' && transactionData.createdAt.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                                                        transactionData.createdAt = firebase.firestore.Timestamp.fromDate(new Date(transactionData.createdAt));
                                                    }
                                                }
                                                batch.set(db.collection(collectionName).doc(docId).collection('transactions').doc(transactionId), transactionData, { merge: true });
                                            }
                                        } else {
                                            batch.set(db.collection(collectionName).doc(docId), dataToSet, { merge: true });
                                        }
                                    }
                                }
                            }

                            await batch.commit();
                            modal.toast('Base de datos importada correctamente.', 'success');
                            await loadData(); // Reload all data after import
                        }
                    } catch (error) {
                        console.error('Error importing database:', error);
                        modal.toast(`Error al importar la base de datos: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        // ============= GESTIÓN DE SOLICITUDES DE RECARGA (ADMIN) =============
        class RechargeManager {
            constructor() {
                this.rechargeRequests = [];
            }

            async loadRechargeRequests() {
                if (!db || (currentUser && currentUser.uid !== ADMIN_UID && !isClaudeEnvironment)) {
                    console.warn('⚠️ Solo el administrador puede cargar solicitudes de recarga.');
                    return;
                }
                try {
                    const requestsSnapshot = await db.collection('rechargeRequests').orderBy('createdAt', 'desc').get();
                    this.rechargeRequests = requestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderRechargeRequests();
                    console.log('✅ Solicitudes de recarga cargadas desde Firebase correctamente.');
                } catch (error) {
                    console.error('❌ Error al cargar solicitudes de recarga desde Firebase:', error);
                    modal.toast('Error al cargar solicitudes de recarga desde la nube.', 'error');
                }
            }

            renderRechargeRequests() {
                const pendingContainer = document.getElementById('pendingRechargeRequests');
                const processedContainer = document.getElementById('processedRechargeRequests');

                if (!pendingContainer || !processedContainer) return;

                pendingContainer.innerHTML = '';
                processedContainer.innerHTML = '';

                const pending = this.rechargeRequests.filter(req => req.status === 'pending');
                const processed = this.rechargeRequests.filter(req => req.status !== 'pending');

                if (pending.length === 0) {
                    pendingContainer.innerHTML = '<div class="no-data">No hay solicitudes de recarga pendientes.</div>';
                } else {
                    pending.forEach(request => {
                        pendingContainer.appendChild(this.createRequestCard(request));
                    });
                }

                if (processed.length === 0) {
                    processedContainer.innerHTML = '<div class="no-data">No hay historial de recargas.</div>';
                } else {
                    processed.forEach(request => {
                        processedContainer.appendChild(this.createRequestCard(request));
                    });
                }
            }

            createRequestCard(request) {
                const card = document.createElement('div');
                card.className = 'recharge-request-item';

                const client = webClients.find(wc => wc.id === request.clientId);
                const clientName = client ? `${client.name} ${client.lastName || ''}` : 'Usuario Desconocido';
                const clientEmail = client ? client.email : 'N/A';

                const statusClass = {
                    'pending': 'pending-approval',
                    'approved': 'approved',
                    'rejected': 'rejected'
                }[request.status];

                card.innerHTML = `
                    <div class="header">
                        <span>Solicitud de ${escapeHTML(clientName)}</span>
                        <span class="status-badge ${statusClass}">${escapeHTML(request.status)}</span>
                    </div>
                    <div class="details">
                        <div><strong>Monto:</strong> $${request.amount.toFixed(2)}</div>
                        <div><strong>Banco:</strong> ${escapeHTML(request.bank)}</div>
                        <div><strong>Email:</strong> ${escapeHTML(clientEmail)}</div>
                        <div><strong>Fecha:</strong> ${(request.createdAt?.toDate() || new Date()).toLocaleString()}</div>
                        ${request.comment ? `<div><strong>Comentario:</strong> ${escapeHTML(request.comment)}</div>` : ''}
                        ${request.processedBy ? `<div><strong>Procesado por:</strong> ${escapeHTML(request.processedBy)}</div>` : ''}
                        ${request.processedAt ? `<div><strong>Fecha Proceso:</strong> ${(request.processedAt?.toDate() || new Date()).toLocaleString()}</div>` : ''}
                    </div>
                    <div class="actions">
                        <a href="${escapeHTML(request.imageUrl)}" target="_blank" class="btn btn-info btn-sm">
                            <i class="fas fa-image" aria-hidden="true"></i> Ver Comprobante
                        </a>
                        ${request.status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="rechargeManager.approveRequest('${request.id}', ${request.amount}, '${request.clientId}')">
                                <i class="fas fa-check" aria-hidden="true"></i> Aprobar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rechargeManager.rejectRequest('${request.id}')">
                                <i class="fas fa-times" aria-hidden="true"></i> Rechazar
                            </button>
                        ` : ''}
                    </div>
                `;
                return card;
            }

            async approveRequest(requestId, amount, clientId) {
                const confirmed = await modal.confirm(`¿Estás seguro de aprobar esta recarga de $${amount.toFixed(2)} para el cliente? Se agregará el saldo automáticamente.`, 'Aprobar Recarga');
                if (!confirmed) return;

                if (isClaudeEnvironment) {
                    modal.toast('Funcionalidad no disponible en modo demo.', 'warning');
                    return;
                }

                try {
                    const requestRef = db.collection('rechargeRequests').doc(requestId);
                    await requestRef.update({
                        status: 'approved',
                        processedBy: currentUser.email,
                        processedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    const userRef = db.collection('users').doc(clientId);
                    const userDoc = await userRef.get();
                    if (userDoc.exists) {
                        const currentBalance = userDoc.data().balance || 0;
                        const newBalance = currentBalance + amount;
                        await userRef.update({ balance: newBalance });

                        await db.collection('users').doc(clientId).collection('transactions').add({
                            type: 'Recarga Aprobada',
                            amount: amount,
                            comment: `Recarga aprobada por admin. Solicitud ID: ${requestId}`,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        modal.toast(`Recarga aprobada y saldo de $${newBalance.toFixed(2)} agregado al cliente.`, 'success'); // Changed to newBalance
                    } else {
                        modal.toast('Cliente no encontrado, saldo no actualizado.', 'error');
                    }

                    await this.loadRechargeRequests();
                    await webClientManager.loadAllUsers(); // Update client list for balance changes
                } catch (error) {
                    console.error('Error approving recharge request:', error);
                    modal.toast(`Error al aprobar recarga: ${error.message}`, 'error');
                }
            }

            async rejectRequest(requestId) {
                const confirmed = await modal.confirm('¿Estás seguro de rechazar esta recarga? El saldo NO se agregará.', 'Rechazar Recarga');
                if (!confirmed) return;

                if (isClaudeEnvironment) {
                    modal.toast('Funcionalidad no disponible en modo demo.', 'warning');
                    return;
                }

                try {
                    const requestRef = db.collection('rechargeRequests').doc(requestId);
                    await requestRef.update({
                        status: 'rejected',
                        processedBy: currentUser.email,
                        processedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    modal.toast('Recarga rechazada.', 'info');
                    await this.loadRechargeRequests();
                } catch (error) {
                    console.error('Error rejecting recharge request:', error);
                    modal.toast(`Error al rechazar recarga: ${error.message}`, 'error');
                }
            }
        }

        // ============= INICIALIZACIÓN FIREBASE =============
        function initializeFirebase(config) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.firestore();
                // db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                //     if (err.code == 'failed-precondition') {
                //         console.warn('⚠️ Persistencia offline no disponible: múltiples pestañas abiertas o datos ya persistidos.');
                //     } else if (err.code == 'unimplemented') {
                //         console.warn('⚠️ Persistencia offline no soportada en este navegador.');
                //     } else {
                //         console.error('Error al habilitar persistencia offline:', err);
                //     }
                // });
                console.log('✅ Firebase inicializado correctamente.');
                return true;
            } catch (error) {
                console.error('❌ Error al inicializar Firebase:', error);
                return false;
            }
        }

        // ============= FUNCIONES DE AUTENTICACIÓN (ADMIN & CLIENT) =============
        let currentAuthMode = 'admin'; // 'admin' or 'client'

        function showAdminLogin() {
            document.getElementById('adminLoginScreen').style.display = 'flex';
            document.getElementById('clientLoginScreen').style.display = 'none';
            document.getElementById('clientRegisterScreen').style.display = 'none';
            document.getElementById('adminDemoScreen').style.display = 'none';
            document.getElementById('clientDemoScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('clientApp').style.display = 'none';
            currentAuthMode = 'admin';
            hideLoginError('admin');
            showLoginLoading('admin', false);
        }

        function showClientLogin() {
            document.getElementById('adminLoginScreen').style.display = 'none';
            document.getElementById('clientLoginScreen').style.display = 'flex';
            document.getElementById('clientRegisterScreen').style.display = 'none';
            document.getElementById('adminDemoScreen').style.display = 'none';
            document.getElementById('clientDemoScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('clientApp').style.display = 'none';
            currentAuthMode = 'client';
            hideLoginError('client');
            showLoginLoading('client', false);
        }

        function showClientRegister() {
            document.getElementById('adminLoginScreen').style.display = 'none';
            document.getElementById('clientLoginScreen').style.display = 'none';
            document.getElementById('clientRegisterScreen').style.display = 'flex';
            document.getElementById('adminDemoScreen').style.display = 'none';
            document.getElementById('clientDemoScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('clientApp').style.display = 'none';
            currentAuthMode = 'client_register';
            hideLoginError('register');
            showLoginLoading('register', false);
        }

        function showAdminDemoMode() {
            document.getElementById('adminLoginScreen').style.display = 'none';
            document.getElementById('clientLoginScreen').style.display = 'none';
            document.getElementById('clientRegisterScreen').style.display = 'none';
            document.getElementById('adminDemoScreen').style.display = 'flex';
            document.getElementById('clientDemoScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('clientApp').style.display = 'none';
            currentAuthMode = 'admin_demo';
        }

        function showClientDemoMode() {
            document.getElementById('adminLoginScreen').style.display = 'none';
            document.getElementById('clientLoginScreen').style.display = 'none';
            document.getElementById('clientRegisterScreen').style.display = 'none';
            document.getElementById('adminDemoScreen').style.display = 'none';
            document.getElementById('clientDemoScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('clientApp').style.display = 'none';
            currentAuthMode = 'client_demo';
        }

        async function enterAdminDemoMode() {
            currentUser = { email: 'admin@demo.com', displayName: 'Admin Demo', role: 'admin', uid: ADMIN_UID }; // Assign a dummy UID for demo
            loadDemoData(); // Load demo data first
            if (!financialManager) financialManager = new FinancialManager();
            if (!webClientManager) webClientManager = new UserManager(); // Use UserManager for demo
            if (!rechargeManager) rechargeManager = new RechargeManager(); // Initialize RechargeManager
            await loadData(); // Ensure data is loaded into managers
            showMainApp('admin');
            financialManager.updateFinancialDashboard();
            webClientManager.renderAllUsersTable(); // Render all users for admin demo
            rechargeManager.renderRechargeRequests(); // Render recharge requests for admin demo
        }

        async function enterClientDemoMode() {
            loadDemoData(); // Load demo data first
            if (!financialManager) financialManager = new FinancialManager();
            if (!webClientManager) webClientManager = new UserManager(); // Use UserManager for demo
            if (!rechargeManager) rechargeManager = new RechargeManager(); // Initialize RechargeManager
            await loadData(); // Ensure data is loaded into managers

            // Usar un cliente demo aprobado para el portal
            const demoClient = webClients.find(c => c.email === 'cliente@demo.com'); // All demo clients are "approved" in demo
            if (!demoClient) {
                modal.alert('No se encontró un cliente demo. Asegúrate de que los datos demo estén cargados y el cliente "cliente@demo.com" exista.', 'Error Demo', 'error');
                showClientLogin();
                return;
            }
            currentUser = { email: demoClient.email, displayName: demoClient.name, role: 'client', id: demoClient.id, uid: demoClient.id }; // Use client's ID as UID for demo
            showMainApp('client');
            renderClientDashboard();
        }

        function checkAuthState() {
            if (isClaudeEnvironment) {
                showAdminDemoMode();
                return;
            }

            firebase.auth().onAuthStateChanged(async (user) => {
                 if (user) {
    console.log('Usuario autenticado:', user.email, 'UID:', user.uid);
    console.log('ADMIN_UID esperado:', ADMIN_UID);
    console.log('¿Es admin?', user.uid === ADMIN_UID);
                    
                    // Initialize managers if they are not already
                    if (!financialManager) financialManager = new FinancialManager();
                    if (!webClientManager) webClientManager = new UserManager();
                    if (!rechargeManager) rechargeManager = new RechargeManager();

                    if (user.uid === ADMIN_UID) {
                        // Es admin - cargar todos los datos
                        currentUser = { email: user.email, displayName: 'Admin', role: 'admin', uid: user.uid };
                        await loadData(); // Load data after managers are initialized
                        showMainApp('admin');
                        financialManager.updateFinancialDashboard();
                        webClientManager.loadAllUsers(); // Load all users for admin view
                        rechargeManager.loadRechargeRequests(); // Load recharge requests for admin view
                        // migrateExistingAccounts();
                    } else {
                        // Es cliente regular - solo cargar sus datos
                        currentUser = { email: user.email, displayName: '', role: 'client', id: user.uid, uid: user.uid };
                        
                        try {
                            await loadClientData(user.uid);
                            // Aquí falta la carga explícita de servicios y cuentas para clientes
                            await loadServices();
                            await loadAccounts();
                            // Luego verificas y muestras la app cliente
                            const userData = webClients.find(u => u.id === user.uid);
                            if (userData) {
                                currentUser .displayName = userData.name;
                                showMainApp('client');
                                renderClientDashboard();
                            } else {
                                console.error('Usuario no encontrado en Firestore');
                                await firebase.auth().signOut();
                                modal.alert('Tu cuenta no está completamente configurada. Por favor, intenta registrarte de nuevo.', 'Error de Perfil', 'warning');
                                showClientLogin();
                                return;
                            }
                        } catch (error) {
                            console.error('Error cargando datos del cliente:', error);
                            await firebase.auth().signOut();
                            modal.toast('Error al cargar tu perfil. Intenta de nuevo.', 'error');
                            showClientLogin();
                        }
                    }
                } else {
                    // No hay usuario autenticado
                    console.log('No hay usuario autenticado');
                    currentUser = null;
                    
                    // Limpiar datos
                    accounts = [];
                    clients = [];
                    sales = [];
                    webClients = [];
                    rechargeRequests = [];
                    
                    showAdminLogin();
                }
            });
        }


async function loadClientData(userId) {
    if (db && !isClaudeEnvironment) {
        try {
            console.log('🔥 Cargando datos del cliente desde Firebase...');
            
            // Solo cargar el documento del usuario actual
            const userDocRef = db.collection('users').doc(userId);
            let attempts = 0;
            const maxAttempts = 5; // Número máximo de intentos
            const delay = 1000; // Retraso en milisegundos entre intentos

            while (attempts < maxAttempts) {
                const userDoc = await userDocRef.get();
                if (userDoc.exists) {
                    webClients = [{ id: userDoc.id, ...userDoc.data() }];
                    console.log('✅ Datos del cliente cargados desde Firebase correctamente.');
                    return; // Salir si se carga correctamente
                } else {
                    console.warn(`Intento ${attempts + 1}: Documento no encontrado. Reintentando...`);
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, delay)); // Esperar antes de reintentar
                }
            }

            console.error('❌ Error: No se pudo cargar el documento del cliente después de varios intentos.');
            modal.toast('Error al cargar tus datos. Por favor, intenta de nuevo.', 'error');
            throw new Error('Documento no encontrado después de varios intentos.');
        } catch (error) {
            console.error("Error cargando datos del cliente desde Firebase:", error);
            modal.toast('Error al cargar tus datos. Por favor, intenta de nuevo.', 'error');
            throw error; // Re-throw to be caught by checkAuthState
        }
    } else {
        // En modo demo, cargar todos los datos
        loadDemoData();
    }
}


        async function loginAdmin() {
            const email = document.getElementById('adminLoginEmail').value.trim();
            const password = document.getElementById('adminLoginPassword').value.trim();
            
            if (!email || !password) {
                showLoginError('Por favor completa todos los campos.', 'admin');
                return;
            }

            showLoginLoading('admin', true);
            hideLoginError('admin');

            if (isClaudeEnvironment) {
                if (email === 'admin@demo.com' && password === 'admin123') {
                    await enterAdminDemoMode(); // Use await here
                } else {
                    showLoginError('Credenciales de demo incorrectas. Usa admin@demo.com / admin123', 'admin');
                }
                showLoginLoading('admin', false);
                return;
            }

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                if (userCredential.user.uid !== ADMIN_UID) { // Ensure only specific admin email can log in as admin
                    await firebase.auth().signOut();
                    showLoginError('Acceso denegado. Este email no es un administrador.', 'admin');
                    return;
                }
                console.log('Admin autenticado con éxito.');
                // The onAuthStateChanged listener will handle the rest
            } catch (error) {
                console.error('Error de autenticación admin:', error);
                showLoginLoading('admin', false);
                showLoginError(getFirebaseErrorMessage(error), 'admin');
            }
        }

        async function loginClient() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('clientLoginPassword').value.trim();

            if (!email || !password) {
                showLoginError('Por favor completa todos los campos.', 'client');
                return;
            }

            showLoginLoading('client', true);
            hideLoginError('client');

            if (isClaudeEnvironment) {
                const demoClient = webClients.find(c => c.email === email && c.password === password);
                if (demoClient) {
                    currentUser = { email: demoClient.email, displayName: demoClient.name, role: 'client', id: demoClient.id, uid: demoClient.id };
                    showMainApp('client');
                    renderClientDashboard();
                } else {
                    showLoginError('Credenciales de demo incorrectas. Prueba cliente@demo.com / password123', 'client');
                }
                showLoginLoading('client', false);
                return;
            }

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Verificar si el usuario existe en Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    // Usuario existe en Auth y Firestore, proceder con el login
                    console.log('Cliente autenticado y datos en Firestore encontrados.');
                    // onAuthStateChanged se encargará de cargar los datos y mostrar la app
                } else {
                    // Usuario existe en Auth pero no en Firestore (posiblemente un registro incompleto o borrado manual)
                    await firebase.auth().signOut(); // Desconectar al usuario de Auth
                    showLoginError('Tu cuenta no está completamente configurada. Por favor, contacta a soporte o intenta registrarte de nuevo.', 'client');
                }
            } catch (error) {
                console.error('Error de autenticación cliente:', error);
                showLoginLoading('client', false);
                showLoginError(getFirebaseErrorMessage(error), 'client');
            }
        }

        async function loadAccounts() {
  const snapshot = await db.collection('accounts').get();
  accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}


        function sanitizeInput(input) {
    if (typeof input !== "string") return input;
    return input.replace(/</g, "&lt;").replace(/>/g, "&gt;").trim();
}

function formatEcuadorianPhone(phone) {
    phone = phone.replace(/\D/g, "");
    if (phone.startsWith("593")) {
        phone = phone.substring(3);
    }
    if (!phone.startsWith("0")) {
        phone = "0" + phone;
    }
    if (phone.length !== 10) {
        return null;
    }
    return phone;
}


        async function registerClient() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
            let phone = document.getElementById('registerPhone').value.trim();

            // Validaciones
            if (!name || !email || !password || !confirmPassword || !phone) {
                showLoginError('Por favor completa todos los campos obligatorios.', 'register');
                return;
            }
            if (password !== confirmPassword) {
                showLoginError('Las contraseñas no coinciden.', 'register');
                return;
            }
            if (password.length < 6) {
                showLoginError('La contraseña debe tener al menos 6 caracteres.', 'register');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showLoginError('El formato del email es inválido.', 'register');
                return;
            }

            phone = formatEcuadorianPhone(phone);
            if (!phone) {
                showLoginError('Formato de teléfono ecuatoriano inválido. Ej: 09XXXXXXXX o +593XXXXXXXXX', 'register');
                return;
            }

            showLoginLoading('register', true);
            hideLoginError('register');

            try {
                if (!isClaudeEnvironment) {
                    // 1. Crear usuario en Firebase Authentication
                    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                    const uid = userCredential.user.uid;

                    // 2. Guardar información adicional en Firestore
                    const newUserData = {
                        id: uid,
                        name: sanitizeInput(name),
                        email: sanitizeInput(email),
                        phone: phone,
                        balance: 0,
                        role: 'client',
                        adminUID: ADMIN_UID, // Asignar el UID del admin
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        purchases: [] // Inicializar array de compras
                    };
                    
                    await db.collection('users').doc(uid).set(newUserData);

                    modal.toast('Registro exitoso. Ya puedes iniciar sesión.', 'success');
                    showClientLogin();
                } else {
                    // Modo demo: simular registro
                    if (webClients.some(c => c.email === email)) {
                        showLoginError('Este email ya está registrado en modo demo.', 'register');
                        return;
                    }
                    const newUserData = {
                        id: Date.now().toString(),
                        name: sanitizeInput(name),
                        email: sanitizeInput(email),
                        password: password, // En demo, guardamos la contraseña para simular login
                        phone: phone,
                        balance: 0,
                        role: 'client',
                        adminUID: ADMIN_UID,
                        createdAt: new Date().toISOString(),
                        purchases: []
                    };
                    webClients.push(newUserData);
                    modal.toast('Registro exitoso (Modo Demo). Ya puedes iniciar sesión.', 'success');
                    showClientLogin();
                }
            } catch (error) {
                console.error('Error al registrar cliente:', error);
                // Si falla la creación en Auth, no se intenta guardar en Firestore
                showLoginError(getFirebaseErrorMessage(error), 'register');
            } finally {
                showLoginLoading('register', false);
            }
        }


        async function logoutAdmin() {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas cerrar sesión del administrador?');
            if (confirmed) {
                if (isClaudeEnvironment) {
                    currentUser = null;
                    showAdminDemoMode();
                } else {
                    try {
                        await firebase.auth().signOut();
                        console.log('Admin desconectado.');
                    } catch (error) {
                        console.error('Error al cerrar sesión admin:', error);
                        modal.alert('Error al cerrar sesión: ' + error.message, 'Error', 'error');
                    }
                }
            }
        }

        async function logoutClient() {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas cerrar sesión de tu portal?');
            if (confirmed) {
                if (isClaudeEnvironment) {
                    currentUser = null;
                    showClientDemoMode();
                } else {
                    try {
                        await firebase.auth().signOut();
                        console.log('Cliente desconectado.');
                    } catch (error) {
                        console.error('Error al cerrar sesión cliente:', error);
                        modal.alert('Error al cerrar sesión: ' + error.message, 'Error', 'error');
                    }
                }
            }
        }

        function showMainApp(role) {
            document.getElementById('adminLoginScreen').style.display = 'none';
            document.getElementById('clientLoginScreen').style.display = 'none';
            document.getElementById('clientRegisterScreen').style.display = 'none';
            document.getElementById('adminDemoScreen').style.display = 'none';
            document.getElementById('clientDemoScreen').style.display = 'none';

            if (role === 'admin') {
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('clientApp').style.display = 'none';
                const userEmailElement = document.getElementById('userEmail');
                if (userEmailElement) {
                    userEmailElement.textContent = currentUser.email;
                }
                updateDashboard();
                // Use setTimeout to ensure the DOM is ready and sections are properly displayed
                setTimeout(() => {
                    showSection('dashboard');
                }, 100);
            } else if (role === 'client') {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('clientApp').style.display = 'block';
                const clientDisplayNameElement = document.getElementById('clientDisplayName');
                if (clientDisplayNameElement) {
                    clientDisplayNameElement.textContent = currentUser.displayName;
                }
                renderClientDashboard();
            }
        }

        function showLoginError(message, type) {
            const errorDiv = document.getElementById(`${type}LoginError`) || document.getElementById(`${type}RegisterError`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function hideLoginError(type) {
            const errorDiv = document.getElementById(`${type}LoginError`) || document.getElementById(`${type}RegisterError`);
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        function showLoginLoading(type, show) {
            const loadingDiv = document.getElementById(`${type}LoginLoading`) || document.getElementById(`${type}RegisterLoading`);
            if (loadingDiv) {
                loadingDiv.style.display = show ? 'block' : 'none';
            }
        }

        function getFirebaseErrorMessage(error) {
            let errorMessage = 'Error de autenticación';
            let helpMessage = '';
            
            switch(error.code) {
                case 'auth/network-request-failed':
                    errorMessage = 'Error de conexión.';
                    helpMessage = 'Verifica tu conexión a internet.';
                    break;
                case 'auth/user-not-found':
                    errorMessage = 'Usuario no encontrado.';
                    helpMessage = 'Verifica tu email.';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'Contraseña incorrecta.';
                    helpMessage = 'Verifica tu contraseña.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Email inválido.';
                    helpMessage = 'Verifica que el email tenga formato correcto.';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Demasiados intentos fallidos.';
                    helpMessage = 'Espera unos minutos antes de intentar nuevamente.';
                    break;
                case 'auth/email-already-in-use':
                    errorMessage = 'El email ya está registrado.';
                    helpMessage = 'Intenta iniciar sesión o usa otro email.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Contraseña débil.';
                    helpMessage = 'La contraseña debe tener al menos 6 caracteres.';
                    break;
                default:
                    errorMessage = error.message;
                    helpMessage = 'Contacta a soporte si el problema persiste.';
            }
            return errorMessage + (helpMessage ? '\n\n💡 ' + helpMessage : '');
        }

        // ============= FUNCIONES DE DATOS (CRUD) =============
        async function loadData() {
            // Ensure managers are initialized before attempting to use them
            if (!financialManager) financialManager = new FinancialManager();
            if (!webClientManager) webClientManager = new UserManager();
            if (!rechargeManager) rechargeManager = new RechargeManager();
            
            if (db && !isClaudeEnvironment) {
                try {
                    await loadFromFirebase();
                } catch (error) {
                    console.error("Error cargando datos desde Firebase:", error);
                    // Fallback to demo data if Firebase fails in non-Claude env (e.g., bad config)
                    loadDemoData(); 
                }
            } else {
                loadDemoData(); // Always load demo data in Claude environment
            }
            
            // migrateExistingAccounts(); // Comentado porque no existe



            renderAll();
            updateDashboard();
            financialManager.updateFinancialDashboard();
            if (currentUser && currentUser.role === 'admin') {
                webClientManager.loadAllUsers(); // Load all users for admin view
                rechargeManager.loadRechargeRequests(); // Load recharge requests for admin view
            }
        }

        // Update your loadFromFirebase function to include services
// Find this function around line 1600 and replace the Promise.all section:

async function loadFromFirebase() {
    console.log('🔥 Cargando datos desde Firebase...');
    
    // Verificar que el usuario actual es admin
    if (!currentUser || currentUser.uid !== ADMIN_UID) {
        console.warn('⚠️ Solo el administrador puede cargar todos los datos.');
        return;
    }
    
    try {
        const [accountsSnapshot, clientsSnapshot, salesSnapshot, usersSnapshot, rechargeRequestsSnapshot, servicesSnapshot] = await Promise.all([
            db.collection('accounts').orderBy('createdAt', 'desc').get(),
            db.collection('clients').orderBy('createdAt', 'desc').get(),
            db.collection('sales').orderBy('createdAt', 'desc').get(),
            db.collection('users').orderBy('createdAt', 'desc').get(),
            db.collection('rechargeRequests').orderBy('createdAt', 'desc').get(),
            db.collection('services').orderBy('createdAt', 'desc').get()
        ]);

        accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        clients = clientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        webClients = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        rechargeRequests = rechargeRequestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        services = servicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (financialManager) {
            await financialManager.loadExpensesFromFirebase();
        }

        console.log('✅ Datos cargados desde Firebase correctamente.');
    } catch (error) {
        console.error('❌ Error al cargar datos desde Firebase:', error);
        modal.toast('Error al cargar datos desde la nube.', 'error');
        throw error;
    }
}

        async function saveToFirebase(collectionName, data) {
            if (!db || isClaudeEnvironment) {
                console.warn(`Saltando guardado en Firebase para ${collectionName}/${data.id}. No conectado o modo demo.`);
                return Promise.resolve();
            }

            // Special handling for 'users' collection: only admin can update all fields, user can only update specific fields (e.g., purchases)
            if (collectionName === 'users' && currentUser && currentUser.uid !== ADMIN_UID && currentUser.uid !== data.id) {
                console.warn(`Usuario ${currentUser.uid} intentó guardar datos de otro usuario ${data.id}. Operación denegada.`);
                modal.toast('No tienes permiso para modificar datos de otros usuarios.', 'error');
                return Promise.reject(new Error('Permission denied'));
            }

            console.log(`💾 Guardando en Firebase: ${collectionName}/${data.id}`);
            
            try {
                await db.collection(collectionName).doc(data.id).set(data, { merge: true }); // Use merge to avoid overwriting
                console.log(`✅ Guardado en Firebase: ${collectionName}/${data.id}`);
            } catch (error) {
                console.error(`❌ Error guardando en Firebase ${collectionName}/${data.id}:`, error);
                modal.toast(`Error al guardar en la nube: ${error.message}`, 'error');
                throw error;
            }
        }

        async function deleteFromFirebase(collectionName, id) {
            if (!db || isClaudeEnvironment) {
                console.warn(`Saltando eliminación en Firebase para ${collectionName}/${id}. No conectado o modo demo.`);
                return Promise.resolve();
            }

            // Only admin can delete
            if (currentUser && currentUser.uid !== ADMIN_UID) {
                console.warn(`Usuario ${currentUser.uid} intentó eliminar de ${collectionName}/${id}. Operación denegada.`);
                modal.toast('No tienes permiso para eliminar datos.', 'error');
                return Promise.reject(new Error('Permission denied'));
            }

            console.log(`🗑️ Eliminando de Firebase: ${collectionName}/${id}`);
            try {
                await db.collection(collectionName).doc(id).delete();
                console.log(`✅ Eliminado de Firebase: ${collectionName}/${id}`);
            } catch (error) {
                console.error(`❌ Error eliminando de Firebase ${collectionName}/${id}:`, error);
                modal.toast(`Error al eliminar en la nube: ${error.message}`, 'error');
                throw error;
            }
        }

        function loadDemoData() {
            // Only load if data is empty or explicitly requested for demo mode
            if (accounts.length === 0 || isClaudeEnvironment) {
                accounts = [
                    {
                        id: "demo1",
                        platform: "Netflix",
                        email: "netflix@ejemplo.com",
                        password: "password123",
                        devices: 4,
                        pricePerProfile: 2.50,
                        fullAccountPrice: 8.00,
                        profiles: [
                            { name: "Perfil 1", pin: "Sin pin", available: true, soldTo: null, saleId: null },
                            { name: "Perfil 2", pin: "1234", available: true, soldTo: null, saleId: null },
                            { name: "Perfil 3", pin: "Sin pin", available: false, soldTo: "web-client-1", saleId: "auto-sale-1" },
                            { name: "Perfil 4", pin: "5678", available: true, soldTo: null, saleId: null }
                        ],
                        status: "Disponible",
                        acquisitionCost: 5.00,
                        supplier: "Proveedor Demo",
                        renewalCost: 8.00,
                        renewalDate: "2024-12-15",
                        totalEarned: 7.50,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: "demo2",
                        platform: "HBO Max",
                        email: "hbo@ejemplo.com",
                        password: "hbopass456",
                        devices: 3,
                        pricePerProfile: 3.00,
                        fullAccountPrice: 10.00,
                        profiles: [
                            { name: "Usuario 1", pin: "Sin pin", available: true, soldTo: null, saleId: null },
                            { name: "Usuario 2", pin: "9999", available: true, soldTo: null, saleId: null },
                            { name: "Usuario 3", pin: "Sin pin", available: true, soldTo: null, saleId: null }
                        ],
                        status: "Disponible",
                        acquisitionCost: 7.00,
                        supplier: "Proveedor Demo",
                        renewalCost: 0,
                        renewalDate: null,
                        totalEarned: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: "demo3",
                        platform: "Spotify",
                        email: "spotify@ejemplo.com",
                        password: "spotifypass",
                        devices: 1,
                        pricePerProfile: 5.00,
                        fullAccountPrice: 5.00,
                        profiles: [
                            { name: "Usuario Principal", pin: "N/A", available: false, soldTo: "web-client-3", saleId: "auto-sale-2" }
                        ],
                        status: "Ocupado",
                        acquisitionCost: 6.00,
                        supplier: "Proveedor Demo",
                        renewalCost: 5.00,
                        renewalDate: "2024-11-01",
                        totalEarned: 5.00,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: "demo4",
                        platform: "Disney+",
                        email: "disney@ejemplo.com",
                        password: "disneypass",
                        devices: 5,
                        pricePerProfile: 2.00,
                        fullAccountPrice: 7.00,
                        profiles: [
                            { name: "Perfil A", pin: "1111", available: true, soldTo: null, saleId: null },
                            { name: "Perfil B", pin: "2222", available: true, soldTo: null, saleId: null },
                            { name: "Perfil C", pin: "3333", available: true, soldTo: null, saleId: null },
                            { name: "Perfil D", pin: "4444", available: true, soldTo: null, saleId: null },
                            { name: "Perfil E", pin: "5555", available: true, soldTo: null, saleId: null }
                        ],
                        status: "Disponible",
                        acquisitionCost: 4.00,
                        supplier: "Proveedor Demo",
                        renewalCost: 6.00,
                        renewalDate: "2025-01-20",
                        totalEarned: 0,
                        createdAt: new Date().toISOString()
                    }
                ];

                clients = [ // Manual clients (not used in new user management)
                    {
                        id: "demo-client-1",
                        name: "Juan Pérez",
                        whatsApp: "+593991234567",
                        email: "juan@ejemplo.com",
                        notes: "Cliente frecuente",
                        purchases: 1,
                        lastPurchase: "2024-08-20",
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: "demo-client-2",
                        name: "María García",
                        whatsApp: "+593987654321",
                        email: "maria@ejemplo.com",
                        notes: "Nuevo cliente",
                        purchases: 1,
                        lastPurchase: "2024-09-01",
                        createdAt: new Date().toISOString()
                    }
                ];

                sales = [
                    {
                        id: "demo-sale-1",
                        clientId: "demo-client-1",
                        accountId: "demo1",
                        profilesCount: 1,
                        startDate: "2024-08-20",
                        endDate: "2024-09-19",
                        total: 2.50,
                        status: "Activa",
                        paid: true,
                        isAutoPurchase: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: "demo-sale-2",
                        clientId: "demo-client-2",
                        accountId: "demo3",
                        profilesCount: 1,
                        startDate: "2024-09-01",
                        endDate: "2024-09-30",
                        total: 5.00,
                        status: "Activa",
                        paid: true,
                        isAutoPurchase: false,
                        createdAt: new Date().toISOString()
                    },
                    // Add demo auto purchases to sales array
                    {
                        id: "auto-sale-1",
                        clientId: "web-client-1", // This is a web client ID
                        accountId: "demo1",
                        profilesCount: 1,
                        startDate: "2024-09-10",
                        endDate: "2024-10-09",
                        total: 2.50,
                        status: "Activa",
                        paid: true,
                        isAutoPurchase: true, // Mark as auto purchase
                        createdAt: "2024-09-10T10:00:00Z"
                    },
                    {
                        id: "auto-sale-2",
                        clientId: "web-client-3",
                        accountId: "demo3",
                        profilesCount: 1,
                        startDate: "2024-08-05",
                        endDate: "2024-09-04",
                        total: 5.00,
                        status: "Inactiva", // Mark as inactive/expired
                        paid: true,
                        isAutoPurchase: true,
                        createdAt: "2024-08-05T11:00:00Z"
                    },
                    {
                        id: "auto-sale-3",
                        clientId: "web-client-3",
                        accountId: "demo2", // Assuming HBO Max has a profile sold
                        profilesCount: 1,
                        startDate: "2024-08-10",
                        endDate: "2024-09-09",
                        total: 5.00,
                        status: "Inactiva", // Mark as inactive/expired
                        paid: true,
                        isAutoPurchase: true,
                        createdAt: "2024-08-10T12:00:00Z"
                    }
                ];

                webClients = [ // These are now 'users' in Firestore
                    {
                        id: "web-client-1",
                        name: "Cliente",
                        lastName: "Demo",
                        email: "cliente@demo.com",
                        password: "password123", // Only for demo mode
                        phone: "+593987654321",
                        balance: 50.00,
                        purchases: [ // This is for demo display, actual purchases are in sales collection
                            {
                                saleId: "auto-sale-1",
                                platform: "Netflix",
                                email: "netflix@ejemplo.com",
                                password: "password123",
                                profileName: "Perfil 3",
                                profilePin: "Sin pin",
                                startDate: "2024-09-10",
                                endDate: "2024-10-09",
                                total: 2.50,
                                status: "Activa"
                            }
                        ],
                        createdAt: new Date("2024-01-01T09:00:00Z").toISOString()
                    },
                    {
                        id: "web-client-2",
                        name: "Usuario",
                        lastName: "Nuevo",
                        email: "nuevo@demo.com",
                        password: "password123", // Only for demo mode
                        phone: "+593999888777",
                        balance: 0,
                        purchases: [],
                        createdAt: new Date("2024-09-15T14:00:00Z").toISOString()
                    },
                    {
                        id: "web-client-3",
                        name: "Comprador",
                        lastName: "Frecuente",
                        email: "comprador@demo.com",
                        password: "password123", // Only for demo mode
                        phone: "+593976543210",
                        balance: 10.00,
                        purchases: [ // This is for demo display, actual purchases are in sales collection
                            {
                                saleId: "auto-sale-2",
                                platform: "Spotify",
                                email: "spotify@ejemplo.com",
                                password: "password123", // Added password for demo consistency
                                profileName: "Usuario Principal",
                                profilePin: "N/A",
                                startDate: "2024-08-05",
                                endDate: "2024-09-04",
                                total: 5.00,
                                status: "Vencida"
                            },
                            {
                                saleId: "auto-sale-3",
                                platform: "HBO Max",
                                email: "hbo@ejemplo.com",
                                password: "hbopass456", // Added password for demo consistency
                                profileName: "Usuario 1",
                                profilePin: "Sin pin",
                                startDate: "2024-08-10",
                                endDate: "2024-09-09",
                                total: 5.00,
                                status: "Vencida"
                            }
                        ],
                        createdAt: new Date("2024-07-30T08:00:00Z").toISOString()
                    }
                ];

                if (financialManager) {
                    financialManager.expenses = [
                        {
                            id: "exp1",
                            type: "acquisition",
                            description: "Compra de cuenta Netflix",
                            amount: 5.00,
                            createdAt: new Date("2024-08-15T10:00:00Z").toISOString(),
                            category: "Cuentas"
                        },
                        {
                            id: "exp2",
                            type: "operational",
                            description: "Herramienta de gestión",
                            amount: 10.00,
                            createdAt: new Date("2024-09-05T11:30:00Z").toISOString(),
                            category: "Software"
                        }
                    ];
                }

                rechargeRequests = [
                    {
                        id: "recharge1",
                        clientId: "web-client-1",
                        amount: 10.00,
                        bank: "Pichincha",
                        imageUrl: "https://i.ibb.co/XYZ123/comprobante1.jpg",
                        status: "pending",
                        comment: "Transferencia desde mi cuenta personal",
                        createdAt: new Date("2024-09-20T10:00:00Z").toISOString()
                    },
                    {
                        id: "recharge2",
                        clientId: "web-client-3",
                        amount: 5.00,
                        bank: "Guayaquil",
                        imageUrl: "https://i.ibb.co/ABC456/comprobante2.jpg",
                        status: "approved",
                        comment: "Pago de recarga",
                        createdAt: new Date("2024-09-18T15:00:00Z").toISOString(),
                        processedBy: "admin@demo.com",
                        processedAt: new Date("2024-09-18T16:00:00Z").toISOString()
                    },
                    {
                        id: "recharge3",
                        clientId: "web-client-2",
                        amount: 20.00,
                        bank: "Pichincha",
                        imageUrl: "https://i.ibb.co/DEF789/comprobante3.jpg",
                        status: "rejected",
                        comment: "Monto incorrecto",
                        createdAt: new Date("2024-09-17T09:00:00Z").toISOString(),
                        processedBy: "admin@demo.com",
                        processedAt: new Date("2024-09-17T10:00:00Z").toISOString()
                    }
                ];
            }
        }

        // ============= FUNCIONES DE UI (ADMIN) =============
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            const buttons = document.querySelectorAll('.nav-btn');
            
            // Validar que existan los elementos
            if (sections.length === 0 || buttons.length === 0) {
                console.warn('DOM elements not ready yet, retrying...');
                setTimeout(() => showSection(sectionId), 100);
                return;
            }
            
            sections.forEach(section => {
                if (section.classList) {
                    section.classList.remove('active');
                    section.setAttribute('hidden', 'true');
                }
            });
            
            buttons.forEach(btn => {
                if (btn.classList) {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                }
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection && targetSection.classList) {
                targetSection.classList.add('active');
                targetSection.removeAttribute('hidden');
            }
            
            // Encontrar el botón activo de manera más segura
            const activeButton = Array.from(buttons).find(btn => {
                const controls = btn.getAttribute('onclick');
                return controls && controls.includes(`'${sectionId}'`);
            });
            
            if (activeButton && activeButton.classList) {
                activeButton.classList.add('active');
                activeButton.setAttribute('aria-selected', 'true');
            }
            
            if (sectionId === 'dashboard') {
                updateDashboard();
            } else if (sectionId === 'finances' && financialManager) {
                financialManager.updateFinancialDashboard();
                financialManager.showFinanceTab('overview', { currentTarget: document.querySelector('.finance-tabs .tab-btn.active') }); // Pass event object for tab activation
            } else if (sectionId === 'webClients' && webClientManager) {
                webClientManager.loadAllUsers(); // Ensure latest users are loaded
            } else if (sectionId === 'rechargeRequests' && rechargeManager) {
                rechargeManager.loadRechargeRequests(); // Ensure latest requests are loaded
            }
        }

        function updateDashboard() {
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('totalClients').textContent = webClients.length; // All registered users
            
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthSales = sales.filter(sale => {
                const saleDate = new Date(sale.startDate);
                return saleDate.getMonth() === thisMonth && saleDate.getFullYear() === thisYear;
            });
            
            document.getElementById('totalSales').textContent = monthSales.length;
            
            const totalRevenue = monthSales.reduce((sum, sale) => sum + parseFloat(sale.total || 0), 0);
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            
            updatePlatformStats();
        }

        function updatePlatformStats() {
            const platforms = {};
            accounts.forEach(account => {
                const platform = account.platform;
                platforms[platform] = (platforms[platform] || 0) + 1;
            });

            const statsHtml = Object.entries(platforms)
                .map(([platform, count]) => `<div><strong>${escapeHTML(platform)}:</strong> ${count}</div>`)
                .join('') || '<div>No hay cuentas registradas</div>';

            document.getElementById('platformStats').innerHTML = statsHtml;
        }

        function renderAccounts() {
            const tbody = document.querySelector('#accountsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No hay cuentas registradas.</td></tr>';
                return;
            }

            accounts.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHTML(account.platform)}</td>
                    <td>${escapeHTML(account.email)}</td>
                    <td>${account.profiles.length}</td>
                    <td>$${(account.pricePerProfile || 0).toFixed(2)}</td>
                    <td>$${(account.fullAccountPrice || 0).toFixed(2)}</td>
                    <td>
                        <select class="form-control status-dropdown" onchange="updateAccountStatus('${account.id}', this.value)" aria-label="Cambiar estado de cuenta">
                            <option value="Disponible" ${account.status === 'Disponible' ? 'selected' : ''}>Disponible</option>
                            <option value="Ocupado" ${account.status === 'Ocupado' ? 'selected' : ''}>Ocupado</option>
                            <option value="No disponible" ${account.status === 'No disponible' ? 'selected' : ''}>No disponible</option>
                            <option value="Renovar" ${account.status === 'Renovar' ? 'selected' : ''}>Renovar</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="editAccount('${account.id}')" title="Editar" aria-label="Editar cuenta ${escapeHTML(account.platform)} ${escapeHTML(account.email)}" tabindex="0"><i class="fas fa-edit" aria-hidden="true"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAccount('${account.id}')" title="Eliminar" aria-label="Eliminar cuenta ${escapeHTML(account.platform)} ${escapeHTML(account.email)}" tabindex="0"><i class="fas fa-trash" aria-hidden="true"></i></button>
                        <button class="btn btn-secondary btn-sm" onclick="viewAccountDetails('${account.id}')" title="Ver Detalles" aria-label="Ver detalles de cuenta ${escapeHTML(account.platform)} ${escapeHTML(account.email)}" tabindex="0"><i class="fas fa-eye" aria-hidden="true"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function updateAccountStatus(accountId, newStatus) {
            const accountIndex = accounts.findIndex(acc => acc.id === accountId);
            if (accountIndex === -1) {
                modal.toast('Cuenta no encontrada.', 'error');
                return;
            }

            const oldStatus = accounts[accountIndex].status;
            accounts[accountIndex].status = newStatus;

            try {
                await saveToFirebase('accounts', accounts[accountIndex]);
                renderAccounts();
                modal.toast(`Estado de cuenta actualizado a "${newStatus}"`, 'success');
            } catch (error) {
                console.error('Error updating account status:', error);
                accounts[accountIndex].status = oldStatus; // Revert on error
                renderAccounts();
                modal.toast(`Error al actualizar el estado: ${error.message}`, 'error');
            }
        }

        function renderClientDashboard() {
            const userCurrentBalanceElement = document.getElementById('userCurrentBalance');
            const clientBalanceElement = document.getElementById('clientBalance');
            const clientDisplayNameElement = document.getElementById('clientDisplayName');
            const transactionHistoryElement = document.getElementById('transactionHistory');
            const availableAccountsCatalogElement = document.getElementById('availableAccountsCatalog');
            const clientPurchaseHistoryElement = document.getElementById('clientPurchaseHistory');

            if (!currentUser || currentUser.role !== 'client') {
                console.error('No hay un usuario cliente logeado.');
                return;
            }

            const clientData = webClients.find(u => u.id === currentUser.uid);
            if (!clientData) {
                console.error('Datos del cliente no encontrados en webClients.');
                return;
            }

            // Update balance and display name
            if (userCurrentBalanceElement) userCurrentBalanceElement.textContent = `$${(clientData.balance || 0).toFixed(2)}`;
            if (clientBalanceElement) clientBalanceElement.textContent = `$${(clientData.balance || 0).toFixed(2)}`;
            if (clientDisplayNameElement) clientDisplayNameElement.textContent = clientData.name;

            // Render transaction history
            renderClientTransactionHistory(clientData.id);

            // Render available accounts
            renderAvailableAccountsCatalog();

            // Render client purchase history
            renderClientPurchaseHistory(clientData.id);
        }

        async function renderClientTransactionHistory(clientId) {
            const transactionHistoryElement = document.getElementById('transactionHistory');
            if (!transactionHistoryElement) return;

            transactionHistoryElement.innerHTML = '<div class="loading">Cargando historial...</div>';

            if (isClaudeEnvironment) {
                transactionHistoryElement.innerHTML = '<div class="no-data">Historial de transacciones no disponible en modo demo.</div>';
                return;
            }

            try {
                const transactionsSnapshot = await db.collection('users').doc(clientId).collection('transactions').orderBy('createdAt', 'desc').get();
                const transactions = transactionsSnapshot.docs.map(doc => doc.data());

                if (transactions.length === 0) {
                    transactionHistoryElement.innerHTML = '<div class="no-data">No hay transacciones registradas.</div>';
                } else {
                    let historyHtml = '';
                    transactions.forEach(entry => {
                        const amountClass = entry.amount >= 0 ? 'positive' : 'negative';
                        historyHtml += `
                            <div class="balance-history-item">
                                <div>
                                    <span class="amount ${amountClass}">${entry.amount >= 0 ? '+' : ''}$${entry.amount.toFixed(2)}</span>
                                    <br>
                                    <span class="date">${(entry.createdAt?.toDate() || new Date()).toLocaleString()}</span>
                                </div>
                                <div class="comment">${escapeHTML(entry.comment || entry.type || 'Sin comentario')}</div>
                            </div>
                        `;
                    });
                    transactionHistoryElement.innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Error fetching client transactions:', error);
                transactionHistoryElement.innerHTML = '<div class="no-data">Error al cargar el historial de transacciones.</div>';
            }
        }

        async function loadServices() {
  const snapshot = await db.collection('services').get();
  services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  renderAvailableAccountsCatalog();
}


        function renderAvailableAccountsCatalog() {
            const catalogElement = document.getElementById('availableAccountsCatalog');
            if (!catalogElement) return;

            catalogElement.innerHTML = '';

            const availableAccounts = accounts.filter(acc => acc.status === 'Disponible' && acc.profiles.some(p => p.available));

            if (availableAccounts.length === 0) {
                catalogElement.innerHTML = '<div class="no-data">No hay cuentas disponibles en este momento.</div>';
                return;
            }

            availableAccounts.forEach(account => {
                const availableProfilesCount = account.profiles.filter(p => p.available).length;
                const card = document.createElement('div');
                card.className = 'account-card';
                card.innerHTML = `
                    <h3><i class="fas fa-play-circle" aria-hidden="true"></i> ${escapeHTML(account.platform)}</h3>
                    <p class="description">Usuario: ${escapeHTML(account.email)}</p>
                    <p class="price">Precio por perfil: $${(account.pricePerProfile || 0).toFixed(2)}</p>
                    <p class="description">Perfiles disponibles: ${availableProfilesCount}</p>
                    <button class="btn btn-success buy-btn" onclick="openPurchaseModal('${account.id}')">
                        <i class="fas fa-shopping-cart" aria-hidden="true"></i> Comprar Perfil
                    </button>
                `;
                catalogElement.appendChild(card);
            });
        }

        async function renderClientPurchaseHistory(clientId) {
            const historyElement = document.getElementById('clientPurchaseHistory');
            if (!historyElement) return;

            historyElement.innerHTML = '<div class="loading">Cargando historial de compras...</div>';

            try {
                // Filter sales by the current client's ID and mark auto purchases
                const clientSales = sales.filter(sale => sale.clientId === clientId && sale.isAutoPurchase);

                if (clientSales.length === 0) {
                    historyElement.innerHTML = '<div class="no-data">No tienes compras registradas aún.</div>';
                    return;
                }

                let historyHtml = '';
                for (const sale of clientSales) {
                    const account = accounts.find(acc => acc.id === sale.accountId);
                    if (!account) continue; // Skip if account not found

                    const profile = account.profiles.find(p => p.saleId === sale.id); // Find the specific profile sold in this sale

                    const today = new Date();
                    const endDate = new Date(sale.endDate);
                    let statusText = sale.status;
                    let statusClass = sale.status === 'Activa' ? 'active' : 'unavailable';

                    if (sale.status === 'Activa' && today > endDate) {
                        statusText = 'Vencida';
                        statusClass = 'unavailable';
                    }

                    historyHtml += `
                        <div class="purchase-history-item">
                            <p><strong>Plataforma:</strong> ${escapeHTML(account.platform)}</p>
                            <p><strong>Perfiles:</strong> ${sale.profilesCount}</p>
                            <p><strong>Total:</strong> $${(sale.total || 0).toFixed(2)}</p>
                            <p><strong>Periodo:</strong> ${new Date(sale.startDate).toLocaleDateString()} - ${new Date(sale.endDate).toLocaleDateString()}</p>
                            <p><strong>Estado:</strong> <span class="status-badge ${statusClass}">${statusText}</span></p>
                            <div class="access-details">
                                <p><strong>Usuario:</strong> ${escapeHTML(account.email)}</p>
                                <p><strong>Contraseña:</strong> ${escapeHTML(account.password)}</p>
                                ${profile ? `<p><strong>Perfil Asignado:</strong> ${escapeHTML(profile.name)} (PIN: ${escapeHTML(profile.pin)})</p>` : ''}
                            </div>
                        </div>
                    `;
                }
                historyElement.innerHTML = historyHtml;
            } catch (error) {
                console.error('Error rendering client purchase history:', error);
                historyElement.innerHTML = '<div class="no-data">Error al cargar el historial de compras.</div>';
            }
        }

        async function openPurchaseModal(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) {
                modal.alert('Cuenta no encontrada.', 'Error', 'error');
                return;
            }

            const availableProfiles = account.profiles.filter(p => p.available);
            if (availableProfiles.length === 0) {
                modal.alert('No hay perfiles disponibles en esta cuenta.', 'Sin Perfiles', 'warning');
                return;
            }

            const formConfig = {
                fields: [
                    { type: 'html', value: `<p>Estás a punto de comprar un perfil de <strong>${escapeHTML(account.platform)}</strong>.</p>` },
                    { type: 'html', value: `<p><strong>Precio por perfil:</strong> $${(account.pricePerProfile || 0).toFixed(2)}</p>` },
                    { type: 'html', value: `<p><strong>Perfiles disponibles:</strong> ${availableProfiles.length}</p>` },
                    { type: 'number', name: 'profilesToBuy', label: 'Cantidad de perfiles a comprar', required: true, value: '1', min: '1', max: availableProfiles.length.toString() }
                ]
            };

            modal.form(formConfig, `Comprar Perfil de ${account.platform}`).then(async data => {
                if (data) {
                    const profilesToBuy = parseInt(data.profilesToBuy);
                    if (isNaN(profilesToBuy) || profilesToBuy <= 0 || profilesToBuy > availableProfiles.length) {
                        modal.alert('Cantidad de perfiles inválida.', 'Error', 'error');
                        return;
                    }

                    const totalCost = profilesToBuy * (account.pricePerProfile || 0);
                    const clientData = webClients.find(u => u.id === currentUser.uid);

                    if (!clientData || (clientData.balance || 0) < totalCost) {
                        modal.alert(`Saldo insuficiente. Necesitas $${totalCost.toFixed(2)} y tienes $${(clientData?.balance || 0).toFixed(2)}.`, 'Saldo Insuficiente', 'error');
                        return;
                    }

                    const confirmed = await modal.confirm(`Confirmar compra de ${profilesToBuy} perfil(es) de ${account.platform} por $${totalCost.toFixed(2)}?`, 'Confirmar Compra');
                    if (!confirmed) return;

                    await processPurchase(accountId, profilesToBuy, totalCost);
                }
            });
        }

        async function processPurchase(accountId, profilesToBuy, totalCost) {
            if (isClaudeEnvironment) {
                modal.toast('Funcionalidad de compra no disponible en modo demo.', 'warning');
                return;
            }

            try {
                const accountRef = db.collection('accounts').doc(accountId);
                const clientRef = db.collection('users').doc(currentUser.uid);

                const accountDoc = await accountRef.get();
                const clientDoc = await clientRef.get();

                if (!accountDoc.exists || !clientDoc.exists) {
                    modal.toast('Error: Cuenta o cliente no encontrados.', 'error');
                    return;
                }

                const accountData = accountDoc.data();
                const clientData = clientDoc.data();

                if ((clientData.balance || 0) < totalCost) {
                    modal.toast('Saldo insuficiente. Por favor, recarga tu saldo.', 'error');
                    return;
                }

                const availableProfiles = accountData.profiles.filter(p => p.available);
                if (availableProfiles.length < profilesToBuy) {
                    modal.toast('No hay suficientes perfiles disponibles en este momento.', 'warning');
                    return;
                }

                // Deduct balance
                const newClientBalance = (clientData.balance || 0) - totalCost;
                await clientRef.update({ balance: newClientBalance });

                // Record transaction
                await clientRef.collection('transactions').add({
                    type: 'Compra de Perfil',
                    amount: -totalCost,
                    comment: `Compra de ${profilesToBuy} perfil(es) de ${accountData.platform}`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Assign profiles and create sale record
                const profilesToAssign = availableProfiles.slice(0, profilesToBuy);
                const updatedProfiles = accountData.profiles.map(p => {
                    const assigned = profilesToAssign.find(ap => ap.name === p.name && ap.pin === p.pin);
                    if (assigned) {
                        return {
                            ...p,
                            available: false,
                            soldTo: currentUser.uid,
                            saleId: '' // Will be updated with actual sale ID
                        };
                    }
                    return p;
                });

                const newSale = {
                    clientId: currentUser.uid,
                    accountId: accountId,
                    profilesCount: profilesToBuy,
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0], // 1 month duration
                    total: totalCost,
                    status: 'Activa',
                    paid: true,
                    isAutoPurchase: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const saleRef = await db.collection('sales').add(newSale);
                const saleId = saleRef.id;

                // Update saleId in assigned profiles
                const finalUpdatedProfiles = updatedProfiles.map(p => {
                    if (p.soldTo === currentUser.uid && p.saleId === '') { // Only update newly assigned profiles
                        return { ...p, saleId: saleId };
                    }
                    return p;
                });

                // Update account status if all profiles are now occupied
                const newAccountStatus = finalUpdatedProfiles.some(p => p.available) ? 'Disponible' : 'Ocupado';
                await accountRef.update({
                    profiles: finalUpdatedProfiles,
                    status: newAccountStatus,
                    totalEarned: (accountData.totalEarned || 0) + totalCost // Update total earned for the account
                });

                modal.toast('Compra realizada con éxito!', 'success');
                await loadServices();
                await loadAccounts();
                renderAvailableAccountsCatalog();
                renderClientDashboard();
            } catch (error) {
                console.error('Error processing purchase:', error);
                modal.toast(`Error al procesar la compra: ${error.message}`, 'error');
            }
        }

        async function openRechargeModal() {
            const formConfig = {
                fields: [
                    { type: 'number', name: 'amount', label: 'Monto a Recargar ($)', required: true, placeholder: '0.00', step: '0.01', min: MIN_RECHARGE_AMOUNT.toString() },
                    { type: 'select', name: 'bank', label: 'Banco de Origen', required: true, options: [
                        { value: '', text: 'Seleccionar banco...' },
                        { value: 'Pichincha', text: 'Banco Pichincha' },
                        { value: 'Guayaquil', text: 'Banco de Guayaquil' },
                        { value: 'Produbanco', text: 'Produbanco' },
                        { value: 'Pacifico', text: 'Banco del Pacífico' },
                        { value: 'Otro', text: 'Otro' }
                    ]},
                    { type: 'file', name: 'proof', label: 'Comprobante de Pago (Imagen)', required: true, accept: 'image/*' },
                    { type: 'textarea', name: 'comment', label: 'Comentario (opcional)', placeholder: 'Número de referencia, nombre del titular, etc.' }
                ]
            };

            const bankInfoHtml = `
                <div class="bank-info-section">
                    <h4>Datos Bancarios para Transferencia</h4>
                    <p><strong>Banco:</strong> Banco Pichincha</p>
                    <p><strong>Tipo de Cuenta:</strong> Ahorros</p>
                    <p><strong>Número de Cuenta:</strong> <strong>XXXXXXXXXX</strong></p>
                    <p><strong>Titular:</strong> Tu Nombre / Nombre de Empresa</p>
                    <p><strong>Cédula/RUC:</strong> XXXXXXXXXX</p>
                    <p class="warning-text">¡Importante! Realiza la transferencia a estos datos y adjunta el comprobante.</p>
                    <p class="recharge-min-amount">Monto mínimo de recarga: $${MIN_RECHARGE_AMOUNT.toFixed(2)}</p>
                </div>
            `;

            modal.form(formConfig, 'Solicitar Recarga de Saldo').then(async data => {
                if (data) {
                    const amount = parseFloat(data.amount);
                    const bank = sanitizeInput(data.bank);
                    const proofFile = data.proof;
                    const comment = sanitizeInput(data.comment || '');

                    if (isNaN(amount) || amount < MIN_RECHARGE_AMOUNT) {
                        modal.alert(`El monto mínimo de recarga es $${MIN_RECHARGE_AMOUNT.toFixed(2)}.`, 'Monto Inválido', 'error');
                        return;
                    }
                    if (!proofFile) {
                        modal.alert('Debes adjuntar un comprobante de pago.', 'Comprobante Requerido', 'error');
                        return;
                    }

                    await submitRechargeRequest(amount, bank, proofFile, comment);
                }
            });

            // Add bank info section to the modal body after it's opened
            const modalBody = document.querySelector('#modal-form').closest('.modal-body');
            if (modalBody) {
                modalBody.insertAdjacentHTML('afterbegin', bankInfoHtml);
            }
        }

        async function submitRechargeRequest(amount, bank, proofFile, comment) {
            if (isClaudeEnvironment) {
                modal.toast('Funcionalidad de recarga no disponible en modo demo.', 'warning');
                return;
            }

            try {
                // Upload image to ImgBB
                const formData = new FormData();
                formData.append('image', proofFile);

                const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                const uploadData = await uploadResponse.json();

                if (!uploadData.success) {
                    throw new Error(uploadData.error.message || 'Error al subir la imagen del comprobante.');
                }

                const imageUrl = uploadData.data.url;

                // Save recharge request to Firestore
                const newRechargeRequest = {
                    clientId: currentUser.uid,
                    amount: amount,
                    bank: bank,
                    imageUrl: imageUrl,
                    status: 'pending', // pending, approved, rejected
                    comment: comment,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('rechargeRequests').add(newRechargeRequest);

                modal.toast('Solicitud de recarga enviada con éxito. Esperando aprobación del administrador.', 'success');
                modal.close();
                renderClientDashboard(); // Refresh client dashboard to show pending request (if implemented)
            } catch (error) {
                console.error('Error submitting recharge request:', error);
                modal.toast(`Error al enviar la solicitud de recarga: ${error.message}`, 'error');
            }
        }


        function renderClientData(client) {
            // This function is now largely replaced by renderClientDashboard
            // but kept for potential specific data rendering needs.
            const dashboard = document.querySelector('#clientDashboard');
            if (!dashboard) return;

            // Example of updating specific elements if needed
            // document.getElementById('clientDisplayName').textContent = client.name;
            // document.getElementById('clientBalance').textContent = `$${(client.balance || 0).toFixed(2)}`;
        }

        async function loadAllClientsForAdmin() {
            // This function is now handled by webClientManager.loadAllUsers()
            // and webClientManager.renderAllUsersTable()
            if (webClientManager) {
                await webClientManager.loadAllUsers();
            }
        }

        function renderClientsForAdmin(clients) {
            // This function is now handled by webClientManager.renderAllUsersTable()
            // It's kept as a placeholder but won't be directly called for the main table.
            const tbody = document.querySelector('#clientsTable tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No hay clientes registrados.</td></tr>';
                return;
            }

            clients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHTML(client.name)}</td>
                    <td>${escapeHTML(client.phone)}</td>
                    <td>${escapeHTML(client.email)}</td>
                    <td>${client.purchases || 0}</td>
                    <td>${client.lastPurchase ? new Date(client.lastPurchase).toLocaleDateString() : 'Nunca'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editClient('${client.id}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient('${client.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        function renderClients() {
            // This function is for manual clients, which are now deprecated in favor of 'users'
            // Keeping it for compatibility with existing demo data, but it won't be used for new registrations.
            const tbody = document.querySelector('#clientsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No hay clientes registrados.</td></tr>';
                return;
            }

            clients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHTML(client.name)}</td>
                    <td>${escapeHTML(client.whatsApp)}</td>
                    <td>${escapeHTML(client.email || 'No especificado')}</td>
                    <td>${client.purchases}</td>
                    <td>${client.lastPurchase ? new Date(client.lastPurchase).toLocaleDateString() : 'Nunca'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editClient('${client.id}')" title="Editar" aria-label="Editar cliente ${escapeHTML(client.name)}" tabindex="0"><i class="fas fa-edit" aria-hidden="true"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient('${client.id}')" title="Eliminar" aria-label="Eliminar cliente ${escapeHTML(client.name)}" tabindex="0"><i class="fas fa-trash" aria-hidden="true"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSales() {
            const tbody = document.querySelector('#salesTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No hay ventas registradas.</td></tr>';
                return;
            }

            sales.forEach(sale => {
                const client = clients.find(c => c.id === sale.clientId) || webClients.find(wc => wc.id === sale.clientId);
                const account = accounts.find(a => a.id === sale.accountId);
                
                const today = new Date();
                const endDate = new Date(sale.endDate);
                let paymentStatus = 'pending';
                let paymentStatusText = 'Pendiente';
                let paymentStatusIcon = 'fas fa-hourglass-half';

                if (sale.paid) {
                    paymentStatus = 'paid';
                    paymentStatusText = 'Pagado';
                    paymentStatusIcon = 'fas fa-check-circle';
                } else if (today > endDate) {
                    paymentStatus = 'overdue';
                    paymentStatusText = 'Atrasado';
                    paymentStatusIcon = 'fas fa-exclamation-circle';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHTML(client ? (client.name + (client.lastName ? ' ' + client.lastName : '')) : 'Cliente eliminado')}</td>
                    <td>${escapeHTML(account ? account.platform : 'Cuenta eliminada')}</td>
                    <td>${sale.profilesCount}</td>
                    <td>${new Date(sale.startDate).toLocaleDateString()}</td>
                    <td>${new Date(sale.endDate).toLocaleDateString()}</td>
                    <td>$${(sale.total || 0).toFixed(2)}</td>
                    <td><span class="status-badge ${sale.status === 'Activa' ? 'active' : 'unavailable'}">${escapeHTML(sale.status)}</span></td>
                    <td>
                        <span class="status-badge ${paymentStatus}">
                            <i class="${paymentStatusIcon}" aria-hidden="true"></i> ${paymentStatusText}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="generateWhatsAppFromSale('${sale.id}')" title="Generar WhatsApp" aria-label="Generar mensaje de WhatsApp para venta ${sale.id}" tabindex="0"><i class="fab fa-whatsapp" aria-hidden="true"></i></button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleSalePaymentStatus('${sale.id}', ${sale.paid})" title="${sale.paid ? 'Marcar como Pendiente' : 'Marcar como Pagado'}" aria-label="${sale.paid ? 'Marcar venta como Pendiente' : 'Marcar venta como Pagado'}" tabindex="0">
                            <i class="fas ${sale.paid ? 'fa-undo' : 'fa-dollar-sign'}" aria-hidden="true"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSale('${sale.id}')" title="Eliminar" aria-label="Eliminar venta ${sale.id}" tabindex="0"><i class="fas fa-trash" aria-hidden="true"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function toggleSalePaymentStatus(saleId, currentPaidStatus) {
            const saleIndex = sales.findIndex(s => s.id === saleId);
            if (saleIndex === -1) {
                modal.toast('Venta no encontrada.', 'error');
                return;
            }

            const newPaidStatus = !currentPaidStatus;
            const oldSale = { ...sales[saleIndex] };
            sales[saleIndex].paid = newPaidStatus;

            try {
                await saveToFirebase('sales', sales[saleIndex]);
                renderSales();
                modal.toast(`Estado de pago de venta actualizado a "${newPaidStatus ? 'Pagado' : 'Pendiente'}"`, 'success');
            } catch (error) {
                console.error('Error updating sale payment status:', error);
                sales[saleIndex].paid = oldSale.paid; // Revert on error
                renderSales();
                modal.toast(`Error al actualizar el estado de pago: ${error.message}`, 'error');
            }
        }

        // Update your renderAll() function to include services:

function renderAll() {
    renderAccounts();
    renderClients(); // For manual clients (if any)
    renderSales();
    renderServices(); // Add this line
    if (financialManager) {
        financialManager.renderExpensesTable();
        financialManager.renderFinancialAccountsTable();
    }
    if (webClientManager) {
        webClientManager.renderAllUsersTable(); // Render all users for admin view
    }
    if (rechargeManager) {
        rechargeManager.renderRechargeRequests(); // Render recharge requests for admin view
    }
    updateDashboard();
}
        // Funciones de modales para Cuentas
        function openAddAccountModal(accountId = null) {
            let account = null;
            if (accountId) {
                account = accounts.find(acc => acc.id === accountId);
                if (!account) {
                    modal.alert('Cuenta no encontrada para editar.', 'Error', 'error');
                    return;
                }
            }

            const modalContent = `
                <div class="modal-header">
                    <h3 id="modal-title">${accountId ? 'Editar Cuenta Existente' : 'Agregar Nueva Cuenta'}</h3>
                    <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="account-form" aria-label="${accountId ? 'Formulario para editar cuenta' : 'Formulario para agregar nueva cuenta'}">
                        <!-- Información básica -->
                        <div class="form-section">
                            <h4><i class="fas fa-info-circle" aria-hidden="true"></i> Información de la Cuenta</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="platform">Plataforma: <span aria-hidden="true">*</span></label>
                                    <select id="platform" name="platform" class="form-control" required onchange="toggleCustomPlatform()" tabindex="0" aria-required="true">
                                        <option value="">Seleccionar plataforma</option>
                                        <option value="Netflix" ${account && account.platform === 'Netflix' ? 'selected' : ''}>Netflix</option>
                                        <option value="HBO Max" ${account && account.platform === 'HBO Max' ? 'selected' : ''}>HBO Max</option>
                                        <option value="Disney+" ${account && account.platform === 'Disney+' ? 'selected' : ''}>Disney+</option>
                                        <option value="Prime Video" ${account && account.platform === 'Prime Video' ? 'selected' : ''}>Prime Video</option>
                                        <option value="Spotify" ${account && account.platform === 'Spotify' ? 'selected' : ''}>Spotify</option>
                                        <option value="YouTube Premium" ${account && account.platform === 'YouTube Premium' ? 'selected' : ''}>YouTube Premium</option>
                                        <option value="Otro" ${account && !['Netflix', 'HBO Max', 'Disney+', 'Prime Video', 'Spotify', 'YouTube Premium'].includes(account.platform) ? 'selected' : ''}>Otro</option>
                                    </select>
                                </div>
                                <div class="form-group" id="custom-platform-group" style="display: ${account && !['Netflix', 'HBO Max', 'Disney+', 'Prime Video', 'Spotify', 'YouTube Premium'].includes(account.platform) ? 'block' : 'none'};">
                                    <label for="customPlatform">Plataforma Personalizada:</label>
                                    <input type="text" id="customPlatform" name="customPlatform" class="form-control" value="${account && !['Netflix', 'HBO Max', 'Disney+', 'Prime Video', 'Spotify', 'YouTube Premium'].includes(account.platform) ? escapeHTML(account.platform) : ''}" tabindex="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email">Usuario/Email: <span aria-hidden="true">*</span></label>
                                    <input type="email" id="email" name="email" class="form-control" required value="${account ? escapeHTML(account.email) : ''}" tabindex="0" aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label for="password">Contraseña: <span aria-hidden="true">*</span></label>
                                    <input id="password" name="password" class="form-control" required value="${account ? escapeHTML(account.password) : ''}" tabindex="0" aria-required="true">
                                </div>
                            </div>
                        </div>

                        <!-- Sección Financiera -->
                        <div class="form-section">
                            <h4><i class="fas fa-dollar-sign" aria-hidden="true"></i> Información Financiera</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="acquisitionCost">Costo de Adquisición: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="acquisitionCost" name="acquisitionCost" class="form-control" step="0.01" min="0" placeholder="0.00" required value="${account ? (account.acquisitionCost || 0).toFixed(2) : ''}" onchange="calculateProfitMargin()" tabindex="0" aria-required="true">
                                    <small class="form-text">Costo inicial de compra de la cuenta.</small>
                                </div>
                                <div class="form-group">
                                    <label for="supplier">Proveedor:</label>
                                    <input type="text" id="supplier" name="supplier" class="form-control" placeholder="Nombre del vendedor" value="${account ? escapeHTML(account.supplier || '') : ''}" tabindex="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="renewalCost">Costo de Renovación Mensual:</label>
                                    <input type="number" id="renewalCost" name="renewalCost" class="form-control" step="0.01" min="0" placeholder="0.00" value="${account ? (account.renewalCost || 0).toFixed(2) : ''}" tabindex="0">
                                    <small class="form-text">Solo si pagas renovaciones mensuales.</small>
                                </div>
                                <div class="form-group">
                                    <label for="renewalDate">Próxima Renovación:</label>
                                    <input type="date" id="renewalDate" name="renewalDate" class="form-control" value="${account ? (account.renewalDate || '') : ''}" tabindex="0">
                                </div>
                            </div>
                        </div>

                        <!-- Precios de venta -->
                        <div class="form-section">
                            <h4><i class="fas fa-tags" aria-hidden="true"></i> Precios de Venta</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pricePerProfile">Precio por Perfil: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="pricePerProfile" name="pricePerProfile" class="form-control" step="0.01" min="0" required value="${account ? (account.pricePerProfile || 0).toFixed(2) : ''}" tabindex="0" aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label for="fullAccountPrice">Precio Cuenta Completa: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="fullAccountPrice" name="fullAccountPrice" class="form-control" step="0.01" min="0" required value="${account ? (account.fullAccountPrice || 0).toFixed(2) : ''}" tabindex="0" aria-required="true">
                                </div>
                            </div>
                            
                            <!-- Indicador de rentabilidad en tiempo real -->
                            <div class="profit-indicator" id="profitIndicator" style="display: none;" role="status" aria-live="polite">
                                <strong>Análisis de Rentabilidad:</strong>
                                <div id="profitAnalysis"></div>
                            </div>
                        </div>

                        <!-- Perfiles -->
                        <div class="form-section">
                            <h4><i class="fas fa-user-friends" aria-hidden="true"></i> Configuración de Perfiles</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="devices">Número de Perfiles: <span aria-hidden="true">*</span></label>
                                    <input type="number" id="devices" name="devices" class="form-control" min="1" max="10" required value="${account ? (account.devices || 1) : 1}" onchange="updateProfilesSection(); calculateProfitMargin();" tabindex="0" aria-required="true">
                                </div>
                            </div>
                            
                            <div id="profiles-container" role="group" aria-label="Perfiles de la cuenta">
                                <!-- Los perfiles se cargarán aquí por updateProfilesSection() -->
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addProfile()" tabindex="0">
                                <i class="fas fa-plus" aria-hidden="true"></i> Agregar Perfil
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="modal.close()" tabindex="0">Cancelar</button>
                    <button class="btn btn-success" onclick="saveAccount('${accountId || ''}')" tabindex="0">
                        <i class="fas fa-save" aria-hidden="true"></i> ${accountId ? 'Guardar Cambios' : 'Guardar Cuenta'}
                    </button>
                </div>
            `;

            modal.open(modalContent, { size: 'large' });

            setTimeout(() => {
                updateProfilesSection(account ? account.profiles : null);
                toggleCustomPlatform();
                calculateProfitMargin();
            }, 100);
        }

        function toggleCustomPlatform() {
            const platformSelect = document.getElementById('platform');
            const customGroup = document.getElementById('custom-platform-group');
            const customInput = document.getElementById('customPlatform');
            
            if (platformSelect && customGroup && customInput) {
                if (platformSelect.value === 'Otro') {
                    customGroup.style.display = 'block';
                    customInput.required = true;
                    customInput.setAttribute('aria-required', 'true');
                } else {
                    customGroup.style.display = 'none';
                    customInput.required = false;
                    customInput.removeAttribute('aria-required');
                    customInput.value = '';
                }
            }
        }

        function calculateProfitMargin() {
            const acquisitionCostInput = document.getElementById('acquisitionCost');
            const pricePerProfileInput = document.getElementById('pricePerProfile');
            const devicesInput = document.getElementById('devices');
            
            if (!acquisitionCostInput || !pricePerProfileInput || !devicesInput) return;
            
            const acquisitionCost = parseFloat(acquisitionCostInput.value) || 0;
            const pricePerProfile = parseFloat(pricePerProfileInput.value) || 0;
            const devices = parseInt(devicesInput.value) || 1;
            
            if (acquisitionCost > 0 || pricePerProfile > 0) {
                const maxRevenue = pricePerProfile * devices;
                const profit = maxRevenue - acquisitionCost;
                const margin = maxRevenue > 0 ? ((profit / maxRevenue) * 100).toFixed(1) : 0;
                const roi = acquisitionCost > 0 ? ((profit / acquisitionCost) * 100).toFixed(1) : 0;
                
                let analysis = `
                    <div class="profit-breakdown">
                        <div class="metric">
                            <span class="label">Inversión inicial:</span>
                            <span class="value">$${acquisitionCost.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">Ingresos máximos potenciales:</span>
                            <span class="value">$${maxRevenue.toFixed(2)}</span>
                        </div>
                        <div class="metric ${profit >= 0 ? 'profit' : 'loss'}">
                            <span class="label">Ganancia estimada:</span>
                            <span class="value">$${profit.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">Margen de ganancia:</span>
                            <span class="value ${margin >= 0 ? 'positive' : 'negative'}">${margin}%</span>
                        </div>
                        <div class="metric">
                            <span class="label">ROI:</span>
                            <span class="value ${roi >= 0 ? 'positive' : 'negative'}">${roi}%</span>
                        </div>
                    </div>
                `;
                
                const profitAnalysis = document.getElementById('profitAnalysis');
                const profitIndicator = document.getElementById('profitIndicator');
                
                if (profitAnalysis && profitIndicator) {
                    profitAnalysis.innerHTML = analysis;
                    profitIndicator.style.display = 'block';
                }
            } else {
                document.getElementById('profitIndicator').style.display = 'none';
            }
        }

        function updateProfilesSection(existingProfiles = null) {
            const deviceCount = parseInt(document.getElementById('devices').value) || 1;
            const container = document.getElementById('profiles-container');
            
            container.innerHTML = '';
            
            for (let i = 0; i < deviceCount; i++) {
                const profile = existingProfiles && existingProfiles[i] ? existingProfiles[i] : { name: `Perfil ${i + 1}`, pin: 'Sin pin', available: true };
                
                const profileDiv = document.createElement('div');
                profileDiv.className = 'profile-item';
                profileDiv.innerHTML = `
                    <div class="profile-fields">
                        <input type="text" class="form-control profile-name" placeholder="Nombre del perfil" value="${escapeHTML(profile.name)}" aria-label="Nombre del perfil ${i + 1}" tabindex="0">
                        <input type="text" class="form-control profile-pin" placeholder="PIN (opcional)" value="${escapeHTML(profile.pin)}" aria-label="PIN del perfil ${i + 1}" tabindex="0">
                        <button type="button" class="btn btn-danger btn-sm remove-profile" onclick="removeProfile(this)" ${i === 0 && deviceCount === 1 ? 'style="display: none;"' : ''} aria-label="Eliminar perfil" tabindex="0">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                    </div>
                `;
                container.appendChild(profileDiv);
            }
        }

        function addProfile() {
            const container = document.getElementById('profiles-container');
            const profileCount = container.children.length + 1;
            
            const profileDiv = document.createElement('div');
            profileDiv.className = 'profile-item';
            profileDiv.innerHTML = `
                <div class="profile-fields">
                    <input type="text" class="form-control profile-name" placeholder="Nombre del perfil" value="Perfil ${profileCount}" aria-label="Nombre del perfil ${profileCount}" tabindex="0">
                    <input type="text" class="form-control profile-pin" placeholder="PIN (opcional)" value="Sin pin" aria-label="PIN del perfil ${profileCount}" tabindex="0">
                    <button type="button" class="btn btn-danger btn-sm remove-profile" onclick="removeProfile(this)" aria-label="Eliminar perfil" tabindex="0">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                    </button>
                </div>
            `;
            container.appendChild(profileDiv);
            
            document.getElementById('devices').value = container.children.length;
            calculateProfitMargin();
        }

        function removeProfile(button) {
            const container = document.getElementById('profiles-container');
            if (container.children.length > 1) {
                button.closest('.profile-item').remove();
                
                const profiles = container.querySelectorAll('.profile-item');
                profiles.forEach((profile, index) => {
                    const nameInput = profile.querySelector('.profile-name');
                    if (nameInput.value.startsWith('Perfil ')) {
                        nameInput.value = `Perfil ${index + 1}`;
                    }
                });
                
                document.getElementById('devices').value = profiles.length;
                calculateProfitMargin();
            }
        }

        async function saveAccount(accountId) {
            const form = document.getElementById('account-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const formData = new FormData(form);
            
            const platform = sanitizeInput(formData.get('platform'));
            const customPlatform = sanitizeInput(formData.get('customPlatform'));
            const email = sanitizeInput(formData.get('email'));
            const password = sanitizeInput(formData.get('password'));
            const devices = parseInt(formData.get('devices'));
            const pricePerProfile = parseFloat(formData.get('pricePerProfile'));
            const fullAccountPrice = parseFloat(formData.get('fullAccountPrice'));
            const acquisitionCost = parseFloat(formData.get('acquisitionCost'));
            const renewalCost = parseFloat(formData.get('renewalCost'));
            const supplier = sanitizeInput(formData.get('supplier') || '');
            const renewalDate = formData.get('renewalDate') || null;
            
            if (platform === 'Otro' && !customPlatform) {
                modal.alert('Por favor especifica el nombre de la plataforma personalizada.', 'Plataforma Personalizada', 'warning');
                return;
            }
            
            const profiles = [];
            const profileItems = document.querySelectorAll('.profile-item');
            profileItems.forEach(item => {
                const nameInput = item.querySelector('.profile-name');
                const pinInput = item.querySelector('.profile-pin');
                if (nameInput) { // pinInput might be null if not present
                    const name = sanitizeInput(nameInput.value) || 'Sin nombre';
                    const pin = sanitizeInput(pinInput ? pinInput.value : '') || 'Sin pin';
                    profiles.push({
                        name: name,
                        pin: pin,
                        available: true // Default to available when creating/editing
                    });
                }
            });

            let accountToSave;

            if (accountId) {
                accountToSave = accounts.find(acc => acc.id === accountId);
                if (!accountToSave) {
                    modal.alert('Error: Cuenta no encontrada para actualizar.', 'Error', 'error');
                    return;
                }
                Object.assign(accountToSave, {
                    platform: platform === 'Otro' ? customPlatform : platform,
                    email: email,
                    password: password,
                    devices: devices,
                    pricePerProfile: pricePerProfile,
                    fullAccountPrice: fullAccountPrice,
                    acquisitionCost: acquisitionCost,
                    supplier: supplier,
                    renewalCost: renewalCost,
                    renewalDate: renewalDate,
                });

                // Update existing profiles, preserving sold status if profile name matches
                const existingProfilesMap = new Map(accountToSave.profiles.map(p => [p.name, p]));
                accountToSave.profiles = profiles.map(newProfile => {
                    const existing = existingProfilesMap.get(newProfile.name);
                    if (existing) {
                        return { 
                            ...existing, 
                            name: newProfile.name,
                            pin: newProfile.pin 
                        }; 
                    }
                    return newProfile; // New profile, default to available
                });

            } else {
                accountToSave = {
                    id: Date.now().toString(),
                    platform: platform === 'Otro' ? customPlatform : platform,
                    email: email,
                    password: password,
                    devices: devices,
                    pricePerProfile: pricePerProfile,
                    fullAccountPrice: fullAccountPrice,
                    profiles: profiles,
                    status: 'Disponible',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    acquisitionCost: acquisitionCost,
                    supplier: supplier,
                    renewalCost: renewalCost,
                    renewalDate: renewalDate,
                    totalEarned: 0
                };
                accounts.push(accountToSave);
            }
            
            try {
                await saveToFirebase('accounts', accountToSave);
                renderAll();
                financialManager.updateFinancialDashboard();
                modal.close();
                modal.toast(`Cuenta ${accountId ? 'actualizada' : 'agregada'} correctamente.`, 'success');
            } catch (error) {
                console.error('Error saving account:', error);
                modal.toast(`Error al guardar la cuenta: ${error.message}`, 'error');
            }
        }

       function editAccount(id) {
            openAddAccountModal(id);
        }


        async function deleteAccount(id) {
            const confirmed = await modal.confirm('¿Estás seguro de que deseas eliminar esta cuenta? Esta acción es irreversible.', 'Eliminar Cuenta');
            if (confirmed) {
                try {
                    await deleteFromFirebase('accounts', id);
                    renderAll();
                    modal.toast('Cuenta eliminada correctamente.', 'success');
                } catch (error) {
                    console.error('Error deleting account:', error);
                    modal.toast(`Error al eliminar la cuenta: ${error.message}`, 'error');
                }
            }
        }

        function viewAccountDetails(id) {
            const account = accounts.find(acc => acc.id === id);
            if (!account) {
                modal.alert('Cuenta no encontrada.', 'Error', 'error');
                return;
            }

            const detailsHtml = `
                <div class="modal-header">
                    <h3><i class="fas fa-info-circle" aria-hidden="true"></i> Detalles de la Cuenta</h3>
                    <button class="modal-close" onclick="modal.close()" aria-label="Cerrar modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p><strong>Plataforma:</strong> ${escapeHTML(account.platform)}</p>
                    <p><strong>Email:</strong> ${escapeHTML(account.email)}</p>
                    <p><strong>Precio por Perfil:</strong> $${(account.pricePerProfile || 0).toFixed(2)}</p>
                    <p><strong>Precio Total:</strong> $${(account.fullAccountPrice || 0).toFixed(2)}</p>
                    <p><strong>Costo de Adquisición:</strong> $${(account.acquisitionCost || 0).toFixed(2)}</p>
                    <p><strong>Proveedor:</strong> ${escapeHTML(account.supplier || 'No especificado')}</p>
                    <p><strong>Estado:</strong> ${escapeHTML(account.status)}</p>
                    <p><strong>Perfiles:</strong></p>
                    <ul>
                        ${account.profiles.map(profile => `<li>${escapeHTML(profile.name)} (PIN: ${escapeHTML(profile.pin)})</li>`).join('')}
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="modal.close()" tabindex="0">Cerrar</button>
                </div>
            `;

            modal.open(detailsHtml, { size: 'medium' });
        }

        // ============= INICIALIZACIÓN =============
        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseInitialized = initializeFirebase(firebaseConfig);
            if (firebaseInitialized) {
                checkAuthState();
            } else {
                modal.alert('Error al inicializar Firebase. Verifica la configuración.', 'Error de Inicialización', 'error');
            }
        });
    </script>
</body>
</html>
<!-- ACTUALIZADO -->